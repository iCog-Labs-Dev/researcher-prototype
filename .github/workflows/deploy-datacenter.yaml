name: Build and Deploy

on:
#  push:
#    branches: [ "main" ]
  workflow_dispatch:
  
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Log in to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/qwestor-backend:latest

      - name: Build and push Frontend
        id: build-qwestor-researcher-frontend-prod
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          rm frontend/.env.development frontend/.env.example frontend/.env.production
          cat << EOF >> frontend/.env
          ${{ secrets.FRONTEND_ENV_DEV_DC}}
          EOF
          cat frontend/.env
          ls -la frontend
          git submodule init
          git submodule update
          docker build -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/qwestor-frontend:latest -f frontend/Dockerfile frontend/
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/qwestor-frontend:latest
          echo "image=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/qwestor-frontend:latest" >> $GITHUB_OUTPUT

 —Å–¥–µ–ª–∞–π –¥–æ–∫–µ—Ä—Ñ–∞–π–ª –¥–ª—è —Ñ—Ä–æ–Ω—Ç–∞ —Å npm run build

–ö–æ–Ω–µ—á–Ω–æ. –≠—Ç–æ—Ç Dockerfile –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è production-—Å–±–æ—Ä–∫–∏ –≤–∞—à–µ–≥–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞.

–û–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –º–Ω–æ–≥–æ—Å—Ç—É–ø–µ–Ω—á–∞—Ç—É—é —Å–±–æ—Ä–∫—É (multi-stage build), —á—Ç–æ —è–≤–ª—è–µ—Ç—Å—è –ª—É—á—à–µ–π –ø—Ä–∞–∫—Ç–∏–∫–æ–π. –°–Ω–∞—á–∞–ª–∞ –æ–Ω —Å–æ–±–∏—Ä–∞–µ—Ç –≤–∞—à–µ React-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –∞ –∑–∞—Ç–µ–º –∫–æ–ø–∏—Ä—É–µ—Ç —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –≤ Nginx, —Å–æ–∑–¥–∞–≤–∞—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏–π –∏ –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∏—Ç–æ–≥–æ–≤—ã–π –æ–±—Ä–∞–∑.

–≠—Ç–æ—Ç Dockerfile –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –ø–∞–ø–∫–µ frontend.
1. frontend/Dockerfile (–¥–ª—è npm run build)
Dockerfile

# frontend/Dockerfile

# --- –≠–¢–ê–ü 1: –°–ë–û–†–ö–ê (Builder) ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º Node.js –¥–ª—è —Å–±–æ—Ä–∫–∏ React-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
FROM node:18-alpine AS builder

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
WORKDIR /app

# –ö–æ–ø–∏—Ä—É–µ–º package.json –∏ package-lock.json
COPY package*.json ./

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
RUN npm install

# –ö–æ–ø–∏—Ä—É–µ–º –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
COPY . .

# –°–æ–±–∏—Ä–∞–µ–º production-–±–∏–ª–¥. –§–∞–π–ª—ã –ø–æ—è–≤—è—Ç—Å—è –≤ /app/build
RUN npm run build

# --- –≠–¢–ê–ü 2: –°–ï–†–í–ï–† (Final) ---
# –ò—Å–ø–æ–ª—å–∑—É–µ–º Nginx –¥–ª—è —Ä–∞–∑–¥–∞—á–∏ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
FROM nginx:1.25-alpine

# –ö–æ–ø–∏—Ä—É–µ–º –≥–æ—Ç–æ–≤—ã–π –±–∏–ª–¥ –∏–∑ —ç—Ç–∞–ø–∞ "builder" –≤ –ø–∞–ø–∫—É Nginx
COPY --from=builder /app/build /usr/share/nginx/html

# –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è Nginx
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å Dockerfile
COPY nginx.conf /etc/nginx/conf.d/default.conf

# –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø–æ—Ä—Ç 80, –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç Nginx
EXPOSE 80

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ Nginx
CMD ["nginx", "-g", "daemon off;"]

2. frontend/nginx.conf

–≠—Ç–æ—Ç —Ñ–∞–π–ª –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å –≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ frontend, —Ä—è–¥–æ–º —Å Dockerfile. –û–Ω –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç Nginx –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å React-—Ä–æ—É—Ç–µ—Ä–æ–º –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç API-–∑–∞–ø—Ä–æ—Å—ã –Ω–∞ –±—ç–∫–µ–Ω–¥.
Nginx

# frontend/nginx.conf

server {
  listen 80;

  # –ü–∞–ø–∫–∞ —Å –Ω–∞—à–∏–º–∏ —Å–æ–±—Ä–∞–Ω–Ω—ã–º–∏ —Ñ–∞–π–ª–∞–º–∏
  root /usr/share/nginx/html;
  index index.html;

  # --- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è API –Ω–∞ –±—ç–∫–µ–Ω–¥ ---
  # 'backend' - —ç—Ç–æ –∏–º—è —Å–µ—Ä–≤–∏—Å–∞ –∏–∑ –≤–∞—à–µ–≥–æ docker-compose.yml
  location /api {
    proxy_pass http://backend:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WebSocket –¥–ª—è API
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
  }

  # --- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è WebSocket –Ω–∞ –±—ç–∫–µ–Ω–¥ ---
  location /ws {
    proxy_pass http://backend:8000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ WebSocket
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "Upgrade";
  }

  # --- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–æ—É—Ç–∏–Ω–≥–∞ React (SPA) ---
  # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ index.html
  location / {
    try_files $uri /index.html;
  }
}

–ö–∞–∫ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ docker-compose.yml

–í –≤–∞—à–µ–º docker-compose.yml —Å–µ—Ä–≤–∏—Å frontend —Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫ (–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —á—Ç–æ –º—ã —É–±—Ä–∞–ª–∏ Dockerfile.dev –∏ command):
YAML

# docker-compose.yml

services:
  # ... (—Å–µ—Ä–≤–∏—Å backend) ...

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –Ω–æ–≤—ã–π production Dockerfile
    ports:
      - "3000:80" # Nginx —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 80
    depends_on:
      - backend
    networks:
      - app-network

  # ... (–æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –∏ —Å–µ—Ç–∏) ...

–í–∞–∂–Ω–æ–µ –æ—Ç–ª–∏—á–∏–µ: –í —ç—Ç–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ hot-reload (–∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ) —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ –±—É–¥–µ—Ç. –ü—Ä–∏ –∫–∞–∂–¥–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∫–æ–¥–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –≤–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø–µ—Ä–µ—Å–æ–±–∏—Ä–∞—Ç—å –æ–±—Ä–∞–∑:
Bash

docker-compose up --build -d frontend

certbot-1 | Unable to find deploy-hook command docker-compose in the PATH.

certbot-1 | (PATH is /usr/local/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin)

certbot-1 | See also the --disable-hook-validation option.

certbot-1 exited with code 1

–≠—Ç–æ—Ç —Å–±–æ–π –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Ç–æ–º—É, —á—Ç–æ –∫–æ–º–∞–Ω–¥–∞ docker-compose, –∫–æ—Ç–æ—Ä—É—é –≤—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤ deploy-hook, –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ certbot.

docker-compose ‚Äî —ç—Ç–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Ö–æ—Å—Ç-–º–∞—à–∏–Ω—ã (–≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞), –∞ –Ω–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä certbot ‚Äî —ç—Ç–æ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–µ—Ç —ç—Ç–æ–≥–æ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞.

–í–∞—à–∞ —Ü–µ–ª—å ‚Äî –∑–∞—Å—Ç–∞–≤–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä certbot –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä nginx –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.
‚úÖ –ö–∞–∫ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

–ú—ã —Å–¥–µ–ª–∞–µ–º —Ç–∞–∫, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä certbot –º–æ–≥ –Ω–∞–ø—Ä—è–º—É—é –æ–±—â–∞—Ç—å—Å—è —Å Docker-–¥–µ–º–æ–Ω–æ–º –Ω–∞ –≤–∞—à–µ–º —Ö–æ—Å—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫–æ–º–∞–Ω–¥—É –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ nginx.

–î–ª—è —ç—Ç–æ–≥–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è 3 —à–∞–≥–∞:

    –°–æ–∑–¥–∞—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π Dockerfile –¥–ª—è certbot, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–µ–≥–æ docker-cli.

    –ü—Ä–∏—Å–≤–æ–∏—Ç—å nginx —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–º—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

    –û–±–Ω–æ–≤–∏—Ç—å docker-compose.yml, —á—Ç–æ–±—ã –æ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª docker (–≤–º–µ—Å—Ç–æ docker-compose) –∏ –∑–∞–ø—É—Å–∫–∞–ª –ø—Ä–æ–≤–µ—Ä–∫—É –≤ —Ü–∏–∫–ª–µ.

## 1. –°–æ–∑–¥–∞–π—Ç–µ certbot/Dockerfile

–°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é –ø–∞–ø–∫—É certbot –≤ –∫–æ—Ä–Ω–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø–æ–º–µ—Å—Ç–∏—Ç–µ –≤ –Ω–µ–µ —Ñ–∞–π–ª Dockerfile:
Dockerfile

# certbot/Dockerfile
FROM certbot/certbot

# –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º Docker-–∫–ª–∏–µ–Ω—Ç (–ù–ï docker-compose)
RUN apk add --no-cache docker-cli

## 2. –û–±–Ω–æ–≤–∏—Ç–µ docker-compose.yml

–í–Ω–µ—Å–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–µ—Ä–≤–∏—Å—ã nginx –∏ certbot:
YAML

# docker-compose.yml

services:
  # ... (backend –∏ react-app –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

  # 3. –°–µ—Ä–≤–∏—Å Nginx
  nginx:
    container_name: researcher_nginx # <-- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û
    image: nginx:1.25-alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - certbot_etc:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
    depends_on:
      - backend
      - react-app
    networks:
      - app-network

  # 4. –°–µ—Ä–≤–∏—Å Certbot
  certbot:
    build: ./certbot # <-- –ò–ó–ú–ï–ù–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à Dockerfile
    volumes:
      - certbot_etc:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
      - /var/run/docker.sock:/var/run/docker.sock # <-- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û (–¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ Docker)
    # –ò–ó–ú–ï–ù–ï–ù–û: –ö–æ–º–∞–Ω–¥–∞ —Ç–µ–ø–µ—Ä—å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ü–∏–∫–ª–µ –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç 'docker exec'
    command: sh -c "while :; do sleep 12h & wait $${!}; certbot renew -q --deploy-hook 'docker exec researcher_nginx nginx -s reload'; done"

# ... (—Å–µ—Ç–∏ –∏ —Ç–æ–º–∞ –æ—Å—Ç–∞—é—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

## –ß—Ç–æ –¥–µ–ª–∞—é—Ç —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è?

    build: ./certbot: –ú—ã –±–æ–ª—å—à–µ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ–±—Ä–∞–∑ certbot/certbot, –∞ —Å–æ–±–∏—Ä–∞–µ–º —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π, –≤ –∫–æ—Ç–æ—Ä—ã–π (—à–∞–≥ 1) –¥–æ–±–∞–≤–∏–ª–∏ docker-cli.

    container_name: researcher_nginx: –ú—ã –¥–∞–µ–º nginx –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –∏–º—è (researcher_nginx), —á—Ç–æ–±—ã certbot –≤—Å–µ–≥–¥–∞ –∑–Ω–∞–ª, –∫–∞–∫ –∫ –Ω–µ–º—É –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è.

    /var/run/docker.sock: –ú—ã "–ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º" —Å–æ–∫–µ—Ç Docker —Å —Ö–æ—Å—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä certbot. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç docker-cli –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —É–ø—Ä–∞–≤–ª—è—Ç—å –¥—Ä—É–≥–∏–º–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏.

    command: ...:

        –ú—ã –∑–∞–ø—É—Å–∫–∞–µ–º –≤–µ—á–Ω—ã–π —Ü–∏–∫–ª (while :; do ... done), –∫–æ—Ç–æ—Ä—ã–π —Å–ø–∏—Ç 12 —á–∞—Å–æ–≤, –∞ –∑–∞—Ç–µ–º –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É.

        --deploy-hook 'docker exec researcher_nginx nginx -s reload': –≠—Ç–æ –Ω–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞. Certbot —Ç–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω—è–µ—Ç docker exec (–∫–æ—Ç–æ—Ä—ã–π –º—ã —É—Å—Ç–∞–Ω–æ–≤–∏–ª–∏) –∏ –Ω–∞–ø—Ä—è–º—É—é –≥–æ–≤–æ—Ä–∏—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É researcher_nginx –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É nginx -s reload.

–ü–æ—Å–ª–µ —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Docker Compose:
Bash

docker-compose up -d --build --force-recreate

–í–∞—à certbot –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤ —Ñ–æ–Ω–æ–≤–æ–º —Ä–µ–∂–∏–º–µ –∏ —Å–º–æ–∂–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å Nginx –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —É—Å–ø–µ—à–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞.

–ê –µ—Å–ª–∏ –ø–æ —Ç–∞–∫–æ–π —Å—Ö–µ–º–µ

server {

listen 80;

server_name –≤–∞—à_–¥–æ–º–µ–Ω;


location ~ /.well-known/acme-challenge/ {

root /var/www/certbot;

}

location / {

return 301 https://$host$request_uri;

}

}

–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ–º docker-compose.yml

–í –∫–æ–¥–µ –Ω–∏–∂–µ –º—ã —Å–æ–∑–¥–∞—ë–º —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã, —Å–æ—Å—Ç–æ—è—â–∏–µ –∏–∑ –¥–≤—É—Ö –æ—Ç–¥–µ–ª—å–Ω—ã—Ö, –æ–Ω–∏ –±—É–¥—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –≤–º–µ—Å—Ç–µ, –∞ –∏–º–µ–Ω–Ω–æ —Å–µ—Ä–≤–∏—Å Nginx –∏ —Å–µ—Ä–≤–∏—Å Certbot.


services:

nginx:

image: nginx:latest

ports:

- 80:80 # HTTP (–¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ Certbot)

- 443:443 # HTTPS

volumes:

- ./nginx/conf.d:/etc/nginx/conf.d # Nginx –∫–æ–Ω—Ñ–∏–≥

- ./static-files:/usr/share/nginx/html # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã –≤ nginx –≤ Docker'–µ

- ./certbot/www:/var/www/certbot # Certbot HTTP challenge

- ./certbot/conf:/etc/letsencrypt # SSL certificates

restart: unless-stopped


certbot:

image: certbot/certbot:latest

volumes:

- ./certbot/conf:/etc/letsencrypt

- ./certbot/www:/var/www/certbot

command: certonly --webroot -w /var/www/certbot --force-renewal --email –≤–∞—à–∞_–ø–æ—á—Ç–∞ --agree-tos -d –≤–∞—à_–¥–æ–º–µ–Ω

restart: unless-stopped

–ù–µ—Ç, —ç—Ç–∞ —Å—Ö–µ–º–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ç–æ–º –≤–∏–¥–µ, –∫–∞–∫ –æ–Ω–∞ –Ω–∞–ø–∏—Å–∞–Ω–∞, –∏–∑-–∑–∞ –¥–≤—É—Ö –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º.
## –ü—Ä–æ–±–ª–µ–º—ã —Å –≤–∞—à–∏–º –∫–æ–Ω—Ñ–∏–≥–æ–º:

    –ü—Ä–æ–±–ª–µ–º–∞ "–ö—É—Ä–∏—Ü—ã –∏ –Ø–π—Ü–∞" (Catch-22):

        –í–∞—à —Å–µ—Ä–≤–∏—Å nginx (–≤ –ø–æ–ª–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏, –∫–æ—Ç–æ—Ä–∞—è —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 443) –ø–æ—Ç—Ä–µ–±—É–µ—Ç SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞.

        –ù–æ —Å–µ—Ä–≤–∏—Å certbot (–∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω —Å–æ–∑–¥–∞—Ç—å —ç—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã) –Ω–µ —Å–º–æ–∂–µ—Ç –∏—Ö –ø–æ–ª—É—á–∏—Ç—å, –ø–æ—Ç–æ–º—É —á—Ç–æ –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç webroot (–ø–∞–ø–∫—É certbot/www), –∫–æ—Ç–æ—Ä—ã–π –¥–æ–ª–∂–µ–Ω –æ–±—Å–ª—É–∂–∏–≤–∞—Ç—å—Å—è —É–∂–µ –∑–∞–ø—É—â–µ–Ω–Ω—ã–º nginx.

        –ò—Ç–æ–≥: nginx –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ –Ω–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤. certbot –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –ø–æ—Ç–æ–º—É —á—Ç–æ nginx –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –¢—É–ø–∏–∫.

    –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:

        –ö–æ–º–∞–Ω–¥–∞ command: certonly ... –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –û–Ω–∞ –Ω–µ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –∫–æ–≥–¥–∞ –∏—Ö —Å—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è –ø–æ–¥–æ–π–¥–µ—Ç –∫ –∫–æ–Ω—Ü—É (–∫–∞–∂–¥—ã–µ 60-90 –¥–Ω–µ–π).

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –ü–ª–∞–Ω –ø–µ—Ä–≤–æ–≥–æ –∑–∞–ø—É—Å–∫–∞ –∏ –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

–í–æ—Ç –∫–∞–∫ —ç—Ç–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –æ–¥–∏–Ω —Ä–∞–∑ —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω–æ —Ä–∞–±–æ—Ç–∞–ª–æ –∏ –æ–±–Ω–æ–≤–ª—è–ª–æ—Å—å. –ú—ã —Ä–∞–∑–¥–µ–ª–∏–º –ø—Ä–æ—Ü–µ—Å—Å –Ω–∞ –¥–≤–∞ —ç—Ç–∞–ø–∞: –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏ —Ä–∞–±–æ—á–∏–π —Ä–µ–∂–∏–º.
## –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–Ω—ã–π nginx.conf (–¥–ª—è —Ä–∞–±–æ—á–µ–≥–æ —Ä–µ–∂–∏–º–∞)

–í–∞–º –Ω—É–∂–µ–Ω –∫–æ–Ω—Ñ–∏–≥, –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç –∏ 80 (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞), –∏ 443 (–¥–ª—è HTTPS).

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª nginx/conf.d/default.conf (–æ–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ, —è –¥–æ–±–∞–≤–∏–ª listen 443 ssl...):
Nginx

# nginx/conf.d/default.conf

# --- –°–ï–†–í–ï–† HTTP (–ü–æ—Ä—Ç 80) ---
# –≠—Ç–æ—Ç –±–ª–æ–∫ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É Certbot –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Å—Ç–∞–ª—å–Ω–æ–π —Ç—Ä–∞—Ñ–∏–∫
server {
    listen 80;
    server_name –≤–∞—à_–¥–æ–º–µ–Ω;

    # 1. –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç Let's Encrypt
    location ~ /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # 2. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# --- –°–ï–†–í–ï–† HTTPS (–ü–æ—Ä—Ç 443) ---
server {
    listen 443 ssl http2;
    server_name –≤–∞—à_–¥–æ–º–µ–Ω;

    # --- SSL –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã ---
    ssl_certificate /etc/letsencrypt/live/–≤–∞—à_–¥–æ–º–µ–Ω/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/–≤–∞—à_–¥–æ–º–µ–Ω/privkey.pem;

    # ... (–¥—Ä—É–≥–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ SSL) ...

    # --- –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏–∫–∏ ---
    location / {
        root /usr/share/nginx/html;
        index index.html;
    }
}

## –®–∞–≥ 2: –°–æ–∑–¥–∞–π—Ç–µ docker-compose.yml (–¥–ª—è —Ä–∞–±–æ—á–µ–≥–æ —Ä–µ–∂–∏–º–∞)

–≠—Ç–æ—Ç docker-compose.yml –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–∞–Ω–¥—É renew –¥–ª—è certbot, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –≤ —Ü–∏–∫–ª–µ.
YAML

# docker-compose.yml
services:
  nginx:
    image: nginx:latest
    container_name: nginx
    ports:
      - 80:80
      - 443:443
    volumes:
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./static-files:/usr/share/nginx/html
      - ./certbot/www:/var/www/certbot
      - ./certbot/conf:/etc/letsencrypt
    restart: unless-stopped

  certbot:
    image: certbot/certbot:latest
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    # –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –±—É–¥–µ—Ç –ø—ã—Ç–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
    # –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å Nginx, –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
    command: sh -c "while :; do certbot renew --quiet --deploy-hook 'docker exec nginx nginx -s reload'; sleep 12h; done"

## –®–∞–≥ 3: –ü—Ä–æ—Ü–µ—Å—Å –ü–ï–†–í–û–ì–û –ó–ê–ü–£–°–ö–ê (–†–µ—à–∞–µ–º "Catch-22")

–ù–µ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ docker-compose up —Å—Ä–∞–∑—É! –í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç–∏ –∫–æ–º–∞–Ω–¥—ã –ø–æ –ø–æ—Ä—è–¥–∫—É:

    –°–æ–∑–¥–∞–π—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞–ø–∫–∏:
    Bash

mkdir -p ./certbot/conf
mkdir -p ./certbot/www
mkdir -p ./nginx/conf.d
# (–°–æ–∑–¥–∞–π—Ç–µ –ø–∞–ø–∫—É ./static-files –∏ –ø–æ–ª–æ–∂–∏—Ç–µ —Ç—É–¥–∞ –≤–∞—à —Å–∞–π—Ç)

–°–æ–∑–¥–∞–π—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–π nginx.conf: –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–ª—å–∫–æ HTTP-–±–ª–æ–∫ (server { listen 80; ... }) –∏–∑ –®–∞–≥–∞ 1 –≤ –≤–∞—à nginx/conf.d/default.conf. Nginx –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –±–µ–∑ HTTPS.

–ó–∞–ø—É—Å—Ç–∏—Ç–µ Nginx (—Ç–æ–ª—å–∫–æ –µ–≥–æ):
Bash

docker-compose up -d nginx

–¢–µ–ø–µ—Ä—å Nginx –∑–∞–ø—É—â–µ–Ω –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–µ—Ç –ø–∞–ø–∫—É /var/www/certbot –Ω–∞ –ø–æ—Ä—Ç—É 80.

–ó–∞–ø—É—Å—Ç–∏—Ç–µ certbot –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞: –¢–µ–ø–µ—Ä—å –º—ã –≤—Ä—É—á–Ω—É—é –≤—ã–ø–æ–ª–Ω–∏–º –∫–æ–º–∞–Ω–¥—É certonly, –∫–∞–∫ –≤—ã –∏ –ø—Ä–µ–¥–ª–∞–≥–∞–ª–∏.
Bash

docker-compose run --rm certbot certonly \
  --webroot -w /var/www/certbot \
  --email –≤–∞—à–∞_–ø–æ—á—Ç–∞ \
  --agree-tos \
  -d –≤–∞—à_–¥–æ–º–µ–Ω \
  --no-eff-email

Certbot —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–π–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫—É, –∏ –≤ –ø–∞–ø–∫–µ ./certbot/conf –ø–æ—è–≤—è—Ç—Å—è –Ω–∞—Å—Ç–æ—è—â–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã.

–í–∫–ª—é—á–∏—Ç–µ HTTPS –≤ Nginx: –¢–µ–ø–µ—Ä—å —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª–Ω—ã–π nginx.conf (—Å –±–ª–æ–∫–æ–º listen 443 ssl ...) –∏–∑ –®–∞–≥–∞ 1 –≤ nginx/conf.d/default.conf, –∑–∞–º–µ–Ω—è—è –≤—Ä–µ–º–µ–Ω–Ω—ã–π –∫–æ–Ω—Ñ–∏–≥.

–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ:
Bash

    docker-compose up -d --force-recreate

–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å Nginx –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è —Å HTTPS, –∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä certbot –ø–µ—Ä–µ–π–¥–µ—Ç –≤ —Ä–∞–±–æ—á–∏–π —Ä–µ–∂–∏–º –∏ –±—É–¥–µ—Ç –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤.

–°–¥–µ–ª–∞–π –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å–µ—Ä—Ç–±–æ—Ç–∞ —Å —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º nginx

–í—ã –ø—Ä–∞–≤—ã, –º–æ–∂–Ω–æ –∏ –Ω—É–∂–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å —ç—Ç–æ—Ç –ø—Ä–æ—Ü–µ—Å—Å. –û—à–∏–±–∫–∞ Unable to find deploy-hook command docker-compose –≤–æ–∑–Ω–∏–∫–ª–∞ –ø–æ—Ç–æ–º—É, —á—Ç–æ –≤—ã –ø—ã—Ç–∞–ª–∏—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É docker-compose –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –≥–¥–µ –æ–Ω–∞ –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.

–ò–¥–µ—è "—Å –æ—Ç–¥–µ–ª—å–Ω—ã–º Nginx" ‚Äî —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å, –Ω–æ –µ–≥–æ –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç–ª–µ–≥–∞–Ω—Ç–Ω–µ–µ. –í–º–µ—Å—Ç–æ –¥–≤—É—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ Nginx, –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–∏–Ω —Å–µ—Ä–≤–∏—Å Nginx, –Ω–æ —Å –¥–≤—É–º—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏: –æ–¥–Ω—É –≤—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞, –∏ –æ–¥–Ω—É –ø–æ—Å—Ç–æ—è–Ω–Ω—É—é –¥–ª—è —Ä–∞–±–æ—Ç—ã.

–ú—ã —Å–¥–µ–ª–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–¥–µ–ª–∞–µ—Ç –≤—Å–µ –∑–∞ –≤–∞—Å.

–í–æ—Ç –ø–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å –Ω—É–ª—è.
## 1. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–ø–æ–∫

–í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç —Å–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫:

researcher-prototype/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile.dev
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îî‚îÄ‚îÄ nginx.conf.template  # (*) –ù–û–í–´–ô: –®–∞–±–ª–æ–Ω –¥–ª—è Nginx
‚îú‚îÄ‚îÄ certbot/
‚îÇ   ‚îî‚îÄ‚îÄ ... (–±—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω–∞)
‚îú‚îÄ‚îÄ scripts/
‚îÇ   ‚îî‚îÄ‚îÄ init-letsencrypt.sh  # (*) –ù–û–í–´–ô: –ù–∞—à –≥–ª–∞–≤–Ω—ã–π —Å–∫—Ä–∏–ø—Ç
‚îî‚îÄ‚îÄ docker-compose.yml       # (–ò–∑–º–µ–Ω–∏–º)

## 2. docker-compose.yml

–≠—Ç–æ—Ç —Ñ–∞–π–ª –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –≤—Å–µ –≤–∞—à–∏ —Å–µ—Ä–≤–∏—Å—ã. nginx –∏ certbot –±—É–¥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–±—â–∏–µ —Ç–æ–º–∞ (volumes) –¥–ª—è –æ–±–º–µ–Ω–∞ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏.
YAML

# docker-compose.yml
version: '3.8'

services:
  # 1. –°–µ—Ä–≤–∏—Å Backend (FastAPI)
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    command: uvicorn app:app --host 0.0.0.0 --port 8000 --reload
    env_file: ./backend/.env
    volumes:
      - ./backend:/app
      - backend_storage:/app/storage_data
    networks:
      - app-network
    restart: unless-stopped

  # 2. –°–µ—Ä–≤–∏—Å Frontend (React Dev Server)
  react-app:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    volumes:
      - ./frontend:/app
      - /app/node_modules
    env_file: ./frontend/.env.development
    networks:
      - app-network
    restart: unless-stopped

  # 3. –°–µ—Ä–≤–∏—Å Nginx (–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞)
  nginx:
    image: nginx:1.25-alpine
    container_name: nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro # –ö–æ–Ω—Ñ–∏–≥ Nginx
      - certbot_etc:/etc/letsencrypt # –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
      - certbot_webroot:/var/www/certbot # –§–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    depends_on:
      - backend
      - react-app
    networks:
      - app-network
    restart: unless-stopped

  # 4. –°–µ—Ä–≤–∏—Å Certbot
  certbot:
    image: certbot/certbot
    container_name: certbot
    volumes:
      - certbot_etc:/etc/letsencrypt
      - certbot_webroot:/var/www/certbot
    # –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –±—É–¥–µ—Ç –ø—ã—Ç–∞—Ç—å—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
    # –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å Nginx, –µ—Å–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—à–ª–æ —É—Å–ø–µ—à–Ω–æ
    command: sh -c "while :; do certbot renew --quiet --deploy-hook 'docker exec nginx nginx -s reload'; sleep 12h; done"

# --- –û–±—â–∏–µ —Ä–µ—Å—É—Ä—Å—ã ---
networks:
  app-network:
    driver: bridge

volumes:
  backend_storage:
  certbot_etc:
  certbot_webroot:

## 3. nginx/nginx.conf.template (–®–∞–±–ª–æ–Ω Nginx)

–≠—Ç–æ—Ç —Ñ–∞–π–ª ‚Äî "–º–æ–∑–≥" Nginx. –û–Ω —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 80 (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Certbot –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞) –∏ 443 (–¥–ª—è HTTPS –∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è).

–í–∞–∂–Ω–æ: –≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –ø–æ–∫–∞ Certbot –Ω–µ —Å–æ–∑–¥–∞—Å—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ $DOMAIN –∏ $EMAIL, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—à —Å–∫—Ä–∏–ø—Ç –ø–æ–¥—Å—Ç–∞–≤–∏—Ç.
Nginx

# nginx/nginx.conf.template

# --- –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–æ–≤ ---
upstream backend_server {
    server backend:8000;
}
upstream frontend_server {
    server react-app:3000;
}

# --- HTTP (–ü–æ—Ä—Ç 80) ---
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Certbot –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –Ω–∞ HTTPS
server {
    listen 80;
    server_name $DOMAIN;

    # –†–∞–∑–¥–∞—á–∞ —Ñ–∞–π–ª–æ–≤ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Let's Encrypt
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # –†–µ–¥–∏—Ä–µ–∫—Ç –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ –Ω–∞ HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# --- HTTPS (–ü–æ—Ä—Ç 443) ---
server {
    listen 443 ssl http2;
    server_name $DOMAIN;

    # --- SSL –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã ---
    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    # --- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è (–∫–∞–∫ –º—ã –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–ª–∏ —Ä–∞–Ω–µ–µ) ---
    location /api {
        proxy_pass http://backend_server;
        # ... (–≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ proxy_set_header) ...
    }
    location /ws {
        proxy_pass http://backend_server;
        # ... (–≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ proxy_set_header –∏ WebSocket) ...
    }
    location / {
        proxy_pass http://frontend_server;
        # ... (–≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ proxy_set_header –∏ WebSocket) ...
    }
}

## 4. scripts/init-letsencrypt.sh (–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫)

–≠—Ç–æ –≤–æ–ª—à–µ–±–Ω—ã–π —Å–∫—Ä–∏–ø—Ç. –û–Ω —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É "–∫—É—Ä–∏—Ü—ã –∏ —è–π—Ü–∞". –û–Ω –∑–∞–ø—É—Å—Ç–∏—Ç –≤—Ä–µ–º–µ–Ω–Ω—ã–π, –æ—Ç–¥–µ–ª—å–Ω—ã–π Nginx –¥–ª—è —Ç–æ–ª—å–∫–æ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞, –∞ –∑–∞—Ç–µ–º –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç –≤—Å–µ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞.

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç, —Å–¥–µ–ª–∞–π—Ç–µ –µ–≥–æ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º (chmod +x scripts/init-letsencrypt.sh) –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ –û–î–ò–ù –†–ê–ó.
Bash

#!/bin/bash

# --- –ù–ê–°–¢–†–û–ô–ö–ò ---
DOMAIN="–≤–∞—à_–¥–æ–º–µ–Ω"  # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω
EMAIL="–≤–∞—à–∞_–ø–æ—á—Ç–∞@example.com" # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à—É –ø–æ—á—Ç—É
NGINX_CONFIG_TEMPLATE="./nginx/nginx.conf.template"
NGINX_CONFIG_OUTPUT="./nginx/nginx.conf"
# -----------------

if [ -f "$NGINX_CONFIG_OUTPUT" ]; then
    echo "–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π —Ñ–∞–π–ª Nginx ($NGINX_CONFIG_OUTPUT) —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."
    echo "–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –ø–æ–ª—É—á–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∑–∞–Ω–æ–≤–æ, —É–¥–∞–ª–∏—Ç–µ –µ–≥–æ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç –µ—â–µ —Ä–∞–∑."
    exit 0
fi

if ! [ -x "$(command -v docker-compose)" ]; then
  echo '–û—à–∏–±–∫–∞: docker-compose –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.' >&2
  exit 1
fi

# 1. –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π Nginx –∫–æ–Ω—Ñ–∏–≥ –¢–û–õ–¨–ö–û –¥–ª—è HTTP (–¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏)
echo "–°–æ–∑–¥–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏..."
cat > $NGINX_CONFIG_OUTPUT << EOL
server {
    listen 80;
    server_name $DOMAIN;
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    location / {
        return 404; # –í—Ä–µ–º–µ–Ω–Ω–æ
    }
}
EOL

# 2. –ó–∞–ø—É—Å–∫–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π Nginx
echo "–ó–∞–ø—É—Å–∫ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ Nginx..."
docker-compose up -d nginx

# 3. –ó–∞–ø—É—Å–∫–∞–µ–º Certbot –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
echo "–ó–∞–ø—Ä–æ—Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤ Let's Encrypt –¥–ª—è $DOMAIN..."
docker-compose run --rm certbot certonly \
    --webroot -w /var/www/certbot \
    --email $EMAIL \
    --agree-tos \
    -d $DOMAIN \
    --no-eff-email \
    --quiet

# 4. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π Nginx
echo "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ Nginx..."
docker-compose down

# 5. –°–æ–∑–¥–∞–µ–º –ü–û–°–¢–û–Ø–ù–ù–´–ô Nginx –∫–æ–Ω—Ñ–∏–≥ –∏–∑ —à–∞–±–ª–æ–Ω–∞
echo "–°–æ–∑–¥–∞–Ω–∏–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx..."
# –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —à–∞–±–ª–æ–Ω
sed -e "s/\$DOMAIN/$DOMAIN/g" -e "s/\$EMAIL/$EMAIL/g" $NGINX_CONFIG_TEMPLATE > $NGINX_CONFIG_OUTPUT

echo "–ì–æ—Ç–æ–≤–æ! –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã –∏ Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω."
echo "–ó–∞–ø—É—Å—Ç–∏—Ç–µ 'docker-compose up -d' –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤."

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç (–ø–æ —à–∞–≥–∞–º):

    –í—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ scripts/init-letsencrypt.sh:

        –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π nginx.conf, –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ—Ä—Ç 80 –∏ –æ—Ç–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.

    docker-compose up -d nginx:

        –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ Nginx —Å —ç—Ç–æ–π –≤—Ä–µ–º–µ–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π.

    docker-compose run --rm certbot certonly...:

        –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è Certbot. –û–Ω —Å–≤—è–∑—ã–≤–∞–µ—Ç—Å—è —Å Let's Encrypt.

        Let's Encrypt –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞—à –¥–æ–º–µ–Ω, –æ–±—Ä–∞—â–∞—è—Å—å –∫ –≤–∞—à–µ–º—É Nginx, –∫–æ—Ç–æ—Ä—ã–π —É—Å–ø–µ—à–Ω–æ –æ—Ç–¥–∞–µ—Ç —Ñ–∞–π–ª –ø—Ä–æ–≤–µ—Ä–∫–∏.

        Certbot –ø–æ–ª—É—á–∞–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –∏—Ö –≤ —Ç–æ–º certbot_etc.

    docker-compose down:

        –í—Ä–µ–º–µ–Ω–Ω—ã–π Nginx –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è.

    sed ...:

        –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π nginx.conf –∏–∑ –≤–∞—à–µ–≥–æ —à–∞–±–ª–æ–Ω–∞, –∫–æ—Ç–æ—Ä—ã–π —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç –∏ HTTP (–¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞) –∏ HTTPS (–¥–ª—è —Ä–∞–±–æ—Ç—ã).

    –í—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ docker-compose up -d:

        Nginx –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π. –û–Ω –≤–∏–¥–∏—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –≤ certbot_etc –∏ —Å—Ç–∞—Ä—Ç—É–µ—Ç –±–µ–∑ –æ—à–∏–±–æ–∫.

        Certbot –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –≤ —Ä–µ–∂–∏–º–µ renew, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞—Ç—å Nginx.

–ü–µ—Ä–µ–≤–µ–¥–∏ —Å–∫—Ä–∏–ø—Ç –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏ —Å–¥–µ–ª–∞–π –º–∏–Ω–∏–º—É–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤

–í–æ—Ç –ø–µ—Ä–µ–≤–æ–¥ —Å–∫—Ä–∏–ø—Ç–∞ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —Å –º–∏–Ω–∏–º—É–º–æ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
Bash

#!/bin/bash

# --- SETTINGS ---
DOMAIN="your_domain"  # Replace with your domain
EMAIL="your_email@example.com" # Replace with your email
NGINX_CONFIG_TEMPLATE="./nginx/nginx.conf.template"
NGINX_CONFIG_OUTPUT="./nginx/nginx.conf"
# -----------------

if [ -f "$NGINX_CONFIG_OUTPUT" ]; then
    echo "Nginx config file ($NGINX_CONFIG_OUTPUT) already exists."
    echo "If you want to get new certificates, delete it and run the script again."
    exit 0
fi

if ! [ -x "$(command -v docker-compose)" ]; then
  echo 'Error: docker-compose is not installed.' >&2
  exit 1
fi

echo "Creating temporary Nginx config for validation..."
cat > $NGINX_CONFIG_OUTPUT << EOL
server {
    listen 80;
    server_name $DOMAIN;
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }
    location / {
        return 404; # Temporary
    }
}
EOL

echo "Starting temporary Nginx..."
docker-compose up -d nginx

echo "Requesting Let's Encrypt certificates for $DOMAIN..."
docker-compose run --rm certbot certonly \
    --webroot -w /var/www/certbot \
    --email $EMAIL \
    --agree-tos \
    -d $DOMAIN \
    --no-eff-email \
    --quiet

echo "Stopping temporary Nginx..."
docker-compose down

echo "Creating permanent Nginx config from template..."
sed -e "s/\$DOMAIN/$DOMAIN/g" -e "s/\$EMAIL/$EMAIL/g" $NGINX_CONFIG_TEMPLATE > $NGINX_CONFIG_OUTPUT

echo "Done! Certificates obtained and Nginx is configured."
echo "Run 'docker-compose up -d' to start all services."

–°–¥–µ–ª–∞–π –ø–æ–ª–Ω—ã–π —Ñ–∞–π–ª nginx.conf.template

–í–æ—Ç –ø–æ–ª–Ω—ã–π nginx.conf.template, –∫–æ—Ç–æ—Ä—ã–π –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–º–µ—Å—Ç–∏—Ç—å –≤ –ø–∞–ø–∫—É nginx/.

–≠—Ç–æ—Ç —à–∞–±–ª–æ–Ω ‚Äî "–º–æ–∑–≥" –≤–∞—à–µ–π Nginx-–∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏. –û–Ω —Å–æ–¥–µ—Ä–∂–∏—Ç –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ-–∑–∞–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ ($DOMAIN), –∫–æ—Ç–æ—Ä—ã–µ –≤–∞—à —Å–∫—Ä–∏–ø—Ç init-letsencrypt.sh –Ω–∞–π–¥–µ—Ç –∏ –∑–∞–º–µ–Ω–∏—Ç –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è.
Nginx

# nginx/nginx.conf.template

# --- 1. –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ Upstream-—Å–µ—Ä–≤–∏—Å–æ–≤ ---
# –≠—Ç–æ –ø—Å–µ–≤–¥–æ–Ω–∏–º—ã –¥–ª—è –≤–∞—à–∏—Ö –±—ç–∫–µ–Ω–¥- –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤,
# –∏–º–µ–Ω–∞ 'backend' –∏ 'react-app' –≤–∑—è—Ç—ã –∏–∑ docker-compose.yml.

upstream backend_server {
    server backend:8000;
}

upstream frontend_server {
    server react-app:3000;
}

# --- 2. –°–µ—Ä–≤–µ—Ä HTTP (–ü–æ—Ä—Ç 80) ---
# –≠—Ç–æ—Ç –±–ª–æ–∫ –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ –¥–≤–µ –≤–µ—â–∏:
# 1. –ü—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ Certbot (Let's Encrypt).
# 2. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ–≥–æ –æ—Å—Ç–∞–ª—å–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞ HTTPS.

server {
    listen 80;
    server_name $DOMAIN; # –ë—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–º

    # –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Certbot
    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    # –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö –æ—Å—Ç–∞–ª—å–Ω—ã—Ö HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ HTTPS
    location / {
        return 301 https://$host$request_uri;
    }
}

# --- 3. –°–µ—Ä–≤–µ—Ä HTTPS (–ü–æ—Ä—Ç 443) ---
# –≠—Ç–æ –≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–µ—Å—å —Ç—Ä–∞—Ñ–∏–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.

server {
    listen 443 ssl http2;
    server_name $DOMAIN; # –ë—É–¥–µ—Ç –∑–∞–º–µ–Ω–µ–Ω–æ —Å–∫—Ä–∏–ø—Ç–æ–º

    # --- SSL –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã ---
    # –ü—É—Ç–∏ –∫ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º, –∫–æ—Ç–æ—Ä—ã–µ Certbot —Å–æ–∑–¥–∞—Å—Ç
    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    # --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ SSL (–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å) ---
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # --- –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ---

    # –ó–∞–ø—Ä–æ—Å—ã –∫ API -> –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥ (FastAPI)
    location /api {
        proxy_pass http://backend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # –í–∫–ª—é—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebSocket (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç /api/ws)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    # –ó–∞–ø—Ä–æ—Å—ã WebSocket -> –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –±—ç–∫–µ–Ω–¥ (FastAPI)
    location /ws {
        proxy_pass http://backend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # –í–∫–ª—é—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebSocket
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    # –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã -> –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (React Dev Server)
    location / {
        proxy_pass http://frontend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        # –í–∫–ª—é—á–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É WebSocket (–¥–ª—è React Hot-Reload)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}

–£–±–µ—Ä–∏ –≤—Å–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
Nginx

upstream backend_server {
    server backend:8000;
}

upstream frontend_server {
    server react-app:3000;
}

server {
    listen 80;
    server_name $DOMAIN;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl http2;
    server_name $DOMAIN;

    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location /api {
        proxy_pass http://backend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location /ws {
        proxy_pass http://backend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location / {
        proxy_pass http://frontend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}

/docker-entrypoint.d/ is not empty, will attempt to perform configuration

nginx-1 | /docker-entrypoint.sh: Looking for shell scripts in /docker-entrypoint.d/

nginx-1 | /docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh

nginx-1 | 10-listen-on-ipv6-by-default.sh: info: can not modify /etc/nginx/conf.d/default.conf (read-only file system?)

nginx-1 | /docker-entrypoint.sh: Sourcing /docker-entrypoint.d/15-local-resolvers.envsh

nginx-1 | /docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh

nginx-1 | /docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh

nginx-1 | /docker-entrypoint.sh: Configuration complete; ready for start up

nginx-1 | 2025/10/31 15:03:50 [warn] 1#1: the "listen ... http2" directive is deprecated, use the "http2" directive instead in /etc/nginx/conf.d/default.conf:23

nginx-1 | nginx: [warn] the "listen ... http2" directive is deprecated, use the "http2" directive instead in /etc/nginx/conf.d/default.conf:23

nginx-1 | 2025/10/31 15:03:50 [emerg] 1#1: SSL_CTX_set_cipher_list("TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256") failed (SSL: error:

0A0000B9:SSL routines::no cipher match)

nginx-1 | nginx: [emerg] SSL_CTX_set_cipher_list("TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256") failed (SSL: error:0A0000B9:SSL routi

nes::no cipher match)

–í–∞—à –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä Nginx –ø–∞–¥–∞–µ—Ç –∏–∑-–∑–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–π ([emerg]) –æ—à–∏–±–∫–∏ SSL: [emerg] 1#1: SSL_CTX_set_cipher_list(...) failed (SSL: error:0A0000B9:SSL routines::no cipher match)

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ —Å–ø–∏—Å–æ–∫ —à–∏—Ñ—Ä–æ–≤ (ssl_ciphers), –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É–∫–∞–∑–∞–ª–∏ –≤ nginx.conf.template, –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º —Å SSL-–±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π –≤–Ω—É—Ç—Ä–∏ –≤–∞—à–µ–≥–æ –æ–±—Ä–∞–∑–∞ nginx:1.25-alpine.

–û–±—Ä–∞–∑—ã Nginx –Ω–∞ alpine –∏—Å–ø–æ–ª—å–∑—É—é—Ç LibreSSL, –≤ —Ç–æ –≤—Ä–µ–º—è –∫–∞–∫ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –æ–±—Ä–∞–∑—ã Nginx (–Ω–∞ Debian) –∏—Å–ø–æ–ª—å–∑—É—é—Ç OpenSSL. –í–∞—à —Å–ø–∏—Å–æ–∫ —à–∏—Ñ—Ä–æ–≤ (TLS_AES_256_GCM_SHA384...) –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è OpenSSL –∏ TLS 1.3, –∫–æ—Ç–æ—Ä—ã–π LibreSSL –≤ alpine-–æ–±—Ä–∞–∑–µ –Ω–µ –ø–æ–Ω–∏–º–∞–µ—Ç.
‚úÖ –†–µ—à–µ–Ω–∏–µ 1 (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è): –ò–∑–º–µ–Ω–∏—Ç—å –æ–±—Ä–∞–∑ Nginx

–≠—Ç–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±. –ó–∞–º–µ–Ω–∏—Ç–µ nginx:1.25-alpine –Ω–∞ nginx:1.25 (–∏–ª–∏ nginx:latest). –≠—Ç–æ—Ç –æ–±—Ä–∞–∑ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç OpenSSL –∏ –ø–æ–π–º–µ—Ç –≤–∞—à —Å–æ–≤—Ä–µ–º–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ —à–∏—Ñ—Ä–æ–≤.

–ò–∑–º–µ–Ω–∏—Ç–µ docker-compose.yml:
YAML

  nginx:
    # –ë–´–õ–û:
    # image: nginx:1.25-alpine
    # –°–¢–ê–õ–û:
    image: nginx:1.25 
    container_name: nginx
    # ... (–æ—Å—Ç–∞–ª—å–Ω–æ–µ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...

‚úÖ –†–µ—à–µ–Ω–∏–µ 2 (–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞): –ò–∑–º–µ–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ —à–∏—Ñ—Ä–æ–≤

–ï—Å–ª–∏ –≤—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å alpine-–æ–±—Ä–∞–∑, –≤–∞–º –Ω—É–∂–Ω–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —à–∏—Ñ—Ä–æ–≤, —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å LibreSSL (–≤–∫–ª—é—á–∞—è —à–∏—Ñ—Ä—ã TLS 1.2).

–ò–∑–º–µ–Ω–∏—Ç–µ nginx.conf.template:
Nginx

server {
    # ...
    ssl_protocols TLSv1.2 TLSv1.3;

    # –ë–´–õ–û:
    # ssl_ciphers 'TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256:TLS_AES_128_GCM_SHA256';
    
    # –°–¢–ê–õ–û (–±–æ–ª–µ–µ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Å–ø–∏—Å–æ–∫):
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    
    ssl_prefer_server_ciphers off;
    # ...
}

üí° –ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ (Warning)

–í—ã —Ç–∞–∫–∂–µ –≤–∏–¥–∏—Ç–µ —ç—Ç–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ: [warn] 1#1: the "listen ... http2" directive is deprecated, use the "http2" directive instead

–≠—Ç–æ –Ω–µ —Ñ–∞—Ç–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞, –Ω–æ –µ–µ —Å—Ç–æ–∏—Ç –∏—Å–ø—Ä–∞–≤–∏—Ç—å.

–ò–∑–º–µ–Ω–∏—Ç–µ nginx.conf.template:
Nginx

server {
    # –ë–´–õ–û:
    # listen 443 ssl http2;
    
    # –°–¢–ê–õ–û:
    listen 443 ssl;
    http2 on;

    server_name $DOMAIN;
    # ...
}

–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –û—à–∏–±–∫–∞ (read-only file system?) ‚Äî —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞, –∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –û–Ω–æ –≤ –ø–æ—Ä—è–¥–∫–µ.

nginx-1 | 2025/10/31 15:07:51 [emerg] 1#1: cannot load certificate "/etc/letsencrypt/live/qwestor.general.singularitynet.dev/fullchain.pem": BIO_new_file() failed (

SSL: error:80000002:system library::No such file or directory:calling fopen(/etc/letsencrypt/live/qwestor.general.singularitynet.dev/fullchain.pem, r) er rror:1000

0080:BIO routines::no such file)

nginx-1 | nginx: [emerg] cannot load certificate "/etc/letsencrypt/live/qwestor.general.singularitynet.dev/fullchain.pem": BIO_new_file() failed (SSL: error:8000000

2:system library::No such file or directory:calling fopen(/etc/letsencrypt/live/qwestor.general.singularitynet.dev/fullchain.pem, r) error:10000080:BIO r routines:

:no such file)

–≠—Ç–∞ –æ—à–∏–±–∫–∞ ‚Äî [emerg] cannot load certificate... No such file or directory ‚Äî —è–≤–ª—è–µ—Ç—Å—è –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–æ–π –ø—Ä–æ–±–ª–µ–º–æ–π "–∫—É—Ä–∏—Ü—ã –∏ —è–π—Ü–∞", –∫–æ—Ç–æ—Ä—É—é –º—ã –ø—ã—Ç–∞–ª–∏—Å—å —Ä–µ—à–∏—Ç—å —Å –ø–æ–º–æ—â—å—é —Å–∫—Ä–∏–ø—Ç–∞.

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ Nginx –∑–∞–ø—É—Å—Ç–∏–ª—Å—è –∏ –ø–æ–ø—ã—Ç–∞–ª—Å—è –∑–∞–≥—Ä—É–∑–∏—Ç—å SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –Ω–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç –≤ –ø–∞–ø–∫–µ /etc/letsencrypt/live/qwestor.general.singularitynet.dev/.

–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —ç—Ç–æ –ø—Ä–æ–∏–∑–æ—à–ª–æ –ø–æ –æ–¥–Ω–æ–π –∏–∑ –¥–≤—É—Ö –ø—Ä–∏—á–∏–Ω:

    –í—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏ docker-compose up -d –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –∑–∞–ø—É—Å—Ç–∏–ª–∏ —Å–∫—Ä–∏–ø—Ç scripts/init-letsencrypt.sh.

    –°–∫—Ä–∏–ø—Ç init-letsencrypt.sh –Ω–µ –±—ã–ª –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ (–≤–æ–∑–º–æ–∂–Ω–æ, –∏–∑-–∑–∞ –æ—à–∏–±–∫–∏ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –¥–æ–º–µ–Ω–∞).

‚úÖ –ö–∞–∫ —ç—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å

–í–∞–º –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é –∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞, –∫–∞–∫ –±—ã–ª–æ –æ–ø–∏—Å–∞–Ω–æ –≤ —Å–∫—Ä–∏–ø—Ç–µ.
–®–∞–≥ 1: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Å–µ

–°–Ω–∞—á–∞–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –≤—Å–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã.
Bash

docker-compose down

–®–∞–≥ 2: –£–¥–∞–ª–∏—Ç–µ "—Å–ª–æ–º–∞–Ω–Ω—ã–π" –∫–æ–Ω—Ñ–∏–≥ Nginx

–°–∫—Ä–∏–ø—Ç –Ω–µ –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –µ—Å–ª–∏ –æ–Ω —É–≤–∏–¥–∏—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π nginx.conf.
Bash

rm nginx/nginx.conf

–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç init-letsencrypt.sh

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ —Ñ–∞–π–ª–µ scripts/init-letsencrypt.sh –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è DOMAIN —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —Ç–æ—á–Ω–æ –≤ qwestor.general.singularitynet.dev.
Bash

#!/bin/bash

# --- SETTINGS ---
DOMAIN="qwestor.general.singularitynet.dev" # <-- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–¥–µ—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –¥–æ–º–µ–Ω
EMAIL="your_email@example.com"             # <-- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∑–¥–µ—Å—å –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –ø–æ—á—Ç–∞
...

–ü–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç:
Bash

chmod +x scripts/init-letsencrypt.sh
./scripts/init-letsencrypt.sh

–í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–ª–µ–¥–∏—Ç–µ –∑–∞ –≤—ã–≤–æ–¥–æ–º —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞. –û–Ω –¥–æ–ª–∂–µ–Ω –∑–∞–∫–æ–Ω—á–∏—Ç—å—Å—è —Å–æ–æ–±—â–µ–Ω–∏–µ–º: Done! Certificates obtained and Nginx is configured. Run 'docker-compose up -d' to start all services.

–ï—Å–ª–∏ –æ–Ω –≤—ã–¥–∞—Å—Ç –æ—à–∏–±–∫—É, Certbot –Ω–µ —Å–º–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–∞—à –¥–æ–º–µ–Ω. –ù–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞ ‚Äî –≤–∞—à –¥–æ–º–µ–Ω (qwestor.general.singularitynet.dev) –µ—â–µ –Ω–µ —É–∫–∞–∑—ã–≤–∞–µ—Ç (–∏–ª–∏ —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–µ–≤–µ—Ä–Ω–æ) –Ω–∞ IP-–∞–¥—Ä–µ—Å —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞, –∏–ª–∏ –ø–æ—Ä—Ç 80 –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.
–®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã

–ï—Å–ª–∏ –®–∞–≥ 3 –ø—Ä–æ—à–µ–ª —É—Å–ø–µ—à–Ω–æ, —É –≤–∞—Å —Ç–µ–ø–µ—Ä—å –µ—Å—Ç—å –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã, –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π nginx.conf.
Bash

docker-compose up -d

ubuntu@ip-172-31-27-52:~/researcher-prototype$ curl -k https://172.31.27.52


="/favicon.ico"/>

"Web site created using create-react-app"/><

script defer="defer" src="/static/js/main.3de380d6.js">You need to ena</span></div><div><span>ble JavaScript to run this app.ubun

ubuntu@ip-172-31-27-52:~/researcher-prototype$ -k ^Ctps://httphttps://qwestor.ge

neral.singularitynet.dev/

ubuntu@ip-172-31-27-52:~/researcher-prototype$ curl -k https://qwestor.general.si

ngularitynet.dev/

–ò –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ

–≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞: –≤–∞—à —Å–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –µ–≥–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ñ–∞–π—Ä–≤–æ–ª (Security Group) –≤ AWS.
## –ê–Ω–∞–ª–∏–∑ —Å–∏—Ç—É–∞—Ü–∏–∏

    curl -k https://172.31.27.52 (–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π IP) ‚Üí –†–ê–ë–û–¢–ê–ï–¢.

        –≠—Ç–æ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ docker-compose –∑–∞–ø—É—â–µ–Ω.

        Nginx —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 443 –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç SSL-—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (–ø–æ—ç—Ç–æ–º—É –Ω—É–∂–µ–Ω -k).

        Nginx –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–¥–∞–µ—Ç —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ (create-react-app).

    curl -k https://qwestor.general... (–ø—É–±–ª–∏—á–Ω—ã–π –¥–æ–º–µ–Ω) ‚Üí –ù–ï –†–ê–ë–û–¢–ê–ï–¢ (–±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–µ –æ–∂–∏–¥–∞–Ω–∏–µ).

        –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –æ—Ç–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ–Ω –ø–æ–ø–∞–¥–∞–µ—Ç –≤ Nginx.

        –°–∫—Ä–∏–ø—Ç init-letsencrypt.sh —Å—Ä–∞–±–æ—Ç–∞–ª, —á—Ç–æ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ –ø–æ—Ä—Ç 80 (HTTP) —É –≤–∞—Å –±—ã–ª –æ—Ç–∫—Ä—ã—Ç (–∏–Ω–∞—á–µ Certbot –Ω–µ –ø—Ä–æ—à–µ–ª –±—ã –ø—Ä–æ–≤–µ—Ä–∫—É).

        –ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ –≤—ã, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –Ω–µ –æ—Ç–∫—Ä—ã–ª–∏ –ø–æ—Ä—Ç 443 (HTTPS) –¥–ª—è —Ç—Ä–∞—Ñ–∏–∫–∞ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞.

## ‚úÖ –†–µ—à–µ–Ω–∏–µ: –û—Ç–∫—Ä–æ–π—Ç–µ –ø–æ—Ä—Ç 443 –≤ AWS Security Group

–í–∞–º –Ω—É–∂–Ω–æ –∑–∞–π—Ç–∏ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–∞—à–µ–≥–æ EC2-–∏–Ω—Å—Ç–∞–Ω—Å–∞ –∏ —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ –ø–æ—Ä—Ç 443.

    –û—Ç–∫—Ä–æ–π—Ç–µ –∫–æ–Ω—Å–æ–ª—å AWS –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ —Å–µ—Ä–≤–∏—Å EC2.

    –ù–∞–π–¥–∏—Ç–µ –≤–∞—à –∏–Ω—Å—Ç–∞–Ω—Å (ip-172-31-27-52).

    –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "Security" (–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å) –≤–Ω–∏–∑—É.

    –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–º—è –≤–∞—à–µ–π Security Group (–ì—Ä—É–ø–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏).

    –í –æ—Ç–∫—Ä—ã–≤—à–µ–º—Å—è –æ–∫–Ω–µ –≥—Ä—É–ø–ø—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –Ω–∞–∂–º–∏—Ç–µ "Edit inbound rules" (–ò–∑–º–µ–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –¥–ª—è –≤—Ö–æ–¥—è—â–µ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞).

    –ù–∞–∂–º–∏—Ç–µ "Add rule" (–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ) –∏ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ:

        Type (–¢–∏–ø): HTTPS

        Protocol (–ü—Ä–æ—Ç–æ–∫–æ–ª): TCP (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

        Port range (–î–∏–∞–ø–∞–∑–æ–Ω –ø–æ—Ä—Ç–æ–≤): 443 (—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)

        Source (–ò—Å—Ç–æ—á–Ω–∏–∫): Anywhere (0.0.0.0/0)

    –ù–∞–∂–º–∏—Ç–µ "Save rules" (–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞).

–ß–µ—Ä–µ–∑ 10-30 —Å–µ–∫—É–Ω–¥ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∞–≤–∏–ª–∞, –≤–∞—à curl -k https://qwestor.general.singularitynet.dev/ –¥–æ–ª–∂–µ–Ω –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Ç–æ—Ç –∂–µ HTML-–∫–æ–¥, —á—Ç–æ –∏ –≤–∞—à –ª–æ–∫–∞–ª—å–Ω—ã–π curl.

—Å–¥–µ–ª–∞–π –µ—â–µ —á—Ç–æ–±—ã –ø–æ—Å—Ç—Ñ–∏–∫—Å /api –∏ /ws —É–¥–∞–ª—è–ª—Å—è
Nginx

upstream backend_server {
    server backend:8000;
}

upstream frontend_server {
    server react-app:3000;
}

server {
    listen 80;
    server_name $DOMAIN;

    location /.well-known/acme-challenge/ {
        root /var/www/certbot;
    }

    location / {
        return 301 https://$host$request_uri;
    }
}

server {
    listen 443 ssl;
    http2 on;
    server_name $DOMAIN;

    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location /api/ {
        proxy_pass http://backend_server/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location /ws/ {
        proxy_pass http://backend_server/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location / {
        proxy_pass http://frontend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}

backend-1 | INFO: 172.20.0.3:40150 - "WebSocket //notifications?user-id=an

onymous" 403

backend-1 | INFO: connection rejected (403 Forbidden)

backend-1 | INFO: connection closed

–≠—Ç–æ—Ç –ª–æ–≥ 403 Forbidden –∏–¥–µ—Ç –∏–∑ –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ (FastAPI), –∞ –Ω–µ –∏–∑ Nginx.

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ Nginx —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–ª WebSocket-–∑–∞–ø—Ä–æ—Å, –Ω–æ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI –ø–æ–ª—É—á–∏–ª–æ –µ–≥–æ –∏ –æ—Ç–∫–ª–æ–Ω–∏–ª–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.

–≠—Ç–æ –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–±–ª–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ WebSocket: –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ Origin, —á—Ç–æ–±—ã —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ –∑–∞–ø—Ä–æ—Å –∏—Å—Ö–æ–¥–∏—Ç —Å –¥–æ–≤–µ—Ä–µ–Ω–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ (–≤–∞—à–µ–≥–æ –∂–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞). Nginx –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–µ –ø–µ—Ä–µ–¥–∞–µ—Ç —ç—Ç–æ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫.
‚úÖ –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤—å—Ç–µ Origin –≤ nginx.conf.template

–í–∞–º –Ω—É–∂–Ω–æ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å Nginx –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å Origin –≤ –±–ª–æ–∫–∞—Ö, –∫–æ—Ç–æ—Ä—ã–µ –≤–µ–¥—É—Ç –∫ –±—ç–∫–µ–Ω–¥—É.

–í–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π server –±–ª–æ–∫ –¥–ª—è HTTPS:
Nginx

server {
    listen 443 ssl;
    http2 on;
    server_name $DOMAIN;

    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location /api/ {
        proxy_pass http://backend_server/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin; # <-- –î–û–ë–ê–í–õ–ï–ù–û
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location /ws/ {
        proxy_pass http://backend_server/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin; # <-- –î–û–ë–ê–í–õ–ï–ù–û
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location / {
        proxy_pass http://frontend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}

–ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è —ç—Ç–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ nginx/nginx.conf.template, –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Nginx:
Bash

docker-compose exec nginx nginx -s reload

–ò–ª–∏, –µ—Å–ª–∏ –≤—ã –º–µ–Ω—è–ª–∏ docker-compose.yml:
Bash

docker-compose up -d --force-recreate nginx

–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–µ—Ç—Å—è

–ü–æ–Ω—è–ª. –û—à–∏–±–∫–∞ 403 Forbidden (–ó–∞–ø—Ä–µ—â–µ–Ω–æ) –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏—Å—Ö–æ–¥–∏—Ç –æ—Ç –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ (FastAPI), –∞ –Ω–µ –æ—Ç Nginx.

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ Nginx —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å, –Ω–æ –≤–∞—à–µ Python-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ–ª—É—á–∞–µ—Ç –µ–≥–æ –∏ –∞–∫—Ç–∏–≤–Ω–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

–°—É–¥—è –ø–æ –ª–æ–≥—É, —É –≤–∞—Å –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –¥–≤–µ —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã.
## –ü—Ä–æ–±–ª–µ–º–∞ 1: 403 Forbidden (–û—à–∏–±–∫–∞ "–ó–∞–ø—Ä–µ—â–µ–Ω–æ")

FastAPI –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–æ–∫–∏—Ä—É–µ—Ç WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —Å "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö" –¥–æ–º–µ–Ω–æ–≤ (Origin). –ú—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ Nginx, —á—Ç–æ–±—ã –æ–Ω –ø–µ—Ä–µ–¥–∞–≤–∞–ª –¥–æ–º–µ–Ω (proxy_set_header Origin...), –Ω–æ —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ "—Å–∫–∞–∑–∞—Ç—å" FastAPI, —á—Ç–æ–±—ã –æ–Ω –¥–æ–≤–µ—Ä—è–ª —ç—Ç–æ–º—É –¥–æ–º–µ–Ω—É.
‚úÖ –†–µ—à–µ–Ω–∏–µ: –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ FastAPI (app.py)

–í–∞–º –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å CORSMiddleware –≤ –≤–∞—à –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª FastAPI (app.py –∏–ª–∏ main.py), —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤–∞—à–µ–º—É –¥–æ–º–µ–Ω—É –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è.
Python

# backend/app.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

# --- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö ---
origins = [
    "https://qwestor.general.singularitynet.dev", # –í–∞—à –¥–æ–º–µ–Ω
    "http://local.dev",                           # –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    "https://local.dev",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
# --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê ---

# ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ä–æ—É—Ç–µ—Ä—ã –∏ —Ç.–¥.)

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ –∫–æ–¥–∞ –≤–∞–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä backend, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —Å–∏–ª—É:
Bash

docker-compose up -d --force-recreate backend

## –ü—Ä–æ–±–ª–µ–º–∞ 2: –î–≤–æ–π–Ω–æ–π —Å–ª—ç—à //notifications

–í –≤–∞—à–µ–º –ª–æ–≥–µ –≤–∏–¥–µ–Ω –æ—á–µ–Ω—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å: "WebSocket //notifications?user-id=anonymous"

Nginx –¥–æ–ª–∂–µ–Ω –±—ã–ª —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å /ws/, –æ—Å—Ç–∞–≤–∏–≤ —Ç–æ–ª—å–∫–æ /notifications.... –î–≤–æ–π–Ω–æ–π —Å–ª—ç—à (//) –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤–∞—à –∫–ª–∏–µ–Ω—Ç, –≤–µ—Ä–æ—è—Ç–Ω–æ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ .../ws//notifications....

–≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–µ 404 Not Found —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã –∏—Å–ø—Ä–∞–≤–∏—Ç–µ –æ—à–∏–±–∫—É 403. Nginx –º–æ–∂–µ—Ç "–∏—Å–ø—Ä–∞–≤–∏—Ç—å" —ç—Ç–æ –Ω–∞ –ª–µ—Ç—É.
‚úÖ –†–µ—à–µ–Ω–∏–µ: –°–¥–µ–ª–∞–π—Ç–µ Nginx –±–æ–ª–µ–µ "—É–º–Ω—ã–º"

–ú—ã –¥–æ–±–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª–æ rewrite –≤ Nginx, —á—Ç–æ–±—ã –æ–Ω "—Å—Ö–ª–æ–ø—ã–≤–∞–ª" –¥–≤–æ–π–Ω—ã–µ —Å–ª—ç—à–∏ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –±—ç–∫–µ–Ω–¥—É.

–í–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π nginx.conf.template (—Ç–æ–ª—å–∫–æ –±–ª–æ–∫ 443):
Nginx

# nginx/nginx.conf.template (–±–ª–æ–∫ 443)
server {
    listen 443 ssl;
    http2 on;
    server_name $DOMAIN;

    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES26-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location /api/ {
        # (–∫–æ–Ω—Ñ–∏–≥ –¥–ª—è /api ... )
        proxy_pass http://backend_server/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin; 
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location /ws/ {
        # <-- –ù–û–í–û–ï –ü–†–ê–í–ò–õ–û –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–í–û–ô–ù–û–ì–û –°–õ–≠–®–ê
        rewrite ^/ws//(.*)$ /ws/$1 last;

        proxy_pass http://backend_server/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location / {
        # (–∫–æ–Ω—Ñ–∏–≥ –¥–ª—è / ... )
        proxy_pass http://frontend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}

–ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è nginx.conf.template –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Nginx:
Bash

docker-compose exec nginx nginx -s reload

## –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

    –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ FastAPI (app.py), —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å 403 Forbidden.

    –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä backend.

    –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ nginx.conf.template, —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å //notifications.

    –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥ Nginx.

–û—à–∏–±–∫–∞ 403 –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å.

–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ location /ws/ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç wss://?

–î–∞, –∞–±—Å–æ–ª—é—Ç–Ω–æ.

–ë–ª–æ–∫ location /ws/ –∏–º–µ–Ω–Ω–æ –¥–ª—è —ç—Ç–æ–≥–æ –∏ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –≤ –≤–∞—à–µ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.

–í–æ—Ç –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

    –ö–ª–∏–µ–Ω—Ç (–±—Ä–∞—É–∑–µ—Ä) –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ wss://qwestor.general.singularitynet.dev/ws/notifications.

    wss:// –æ–∑–Ω–∞—á–∞–µ—Ç WebSocket + SSL –∏ –≤—Å–µ–≥–¥–∞ –∏–¥–µ—Ç –Ω–∞ –ø–æ—Ä—Ç 443.

    Nginx –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –≤ –±–ª–æ–∫–µ server { listen 443 ssl; ... }. –≠—Ç–æ—Ç –±–ª–æ–∫ "—Å–Ω–∏–º–∞–µ—Ç" SSL-—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ.

    Nginx –≤–∏–¥–∏—Ç, —á—Ç–æ "—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π" –ø—É—Ç—å –∑–∞–ø—Ä–æ—Å–∞ ‚Äî /ws/notifications.

    –≠—Ç–æ—Ç –ø—É—Ç—å —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –≤–∞—à–∏–º –±–ª–æ–∫–æ–º location /ws/ { ... }.

    –≠—Ç–æ—Ç –±–ª–æ–∫ (–±–ª–∞–≥–æ–¥–∞—Ä—è proxy_pass –∏ proxy_set_header Upgrade...) –ø–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –≤–∞—à–µ–º—É –±—ç–∫–µ–Ω–¥—É.

–ö–æ—Ä–æ—á–µ –≥–æ–≤–æ—Ä—è: wss:// ‚Äî —ç—Ç–æ —Ç–æ, —á—Ç–æ –≤–∏–¥–∏—Ç –∫–ª–∏–µ–Ω—Ç. location /ws/ ‚Äî —ç—Ç–æ —Ç–æ, –∫–∞–∫ Nginx –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å –ø–æ—Å–ª–µ —Å–Ω—è—Ç–∏—è SSL.

–í—Å–µ —Ä–∞–≤–Ω–æ 403 –æ—à–∏–±–∫–∞ backend-1 | INFO: 172.20.0.3:41228 - "WebSocket /notifications?user-id=bri

ght-pig-74" 403

backend-1 | INFO: connection rejected (403 Forbidden)

–ü–æ–Ω—è–ª. –û—à–∏–±–∫–∞ 403 Forbidden –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –∏—Å—Ö–æ–¥–∏—Ç –æ—Ç –≤–∞—à–µ–≥–æ –±—ç–∫–µ–Ω–¥–∞ (FastAPI), –∞ –Ω–µ –æ—Ç Nginx.

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ Nginx —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–ø—Ä–æ—Å, –Ω–æ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI –ø–æ–ª—É—á–∞–µ—Ç –µ–≥–æ –∏ –∞–∫—Ç–∏–≤–Ω–æ –æ—Ç–∫–ª–æ–Ω—è–µ—Ç –ø–æ —Å–æ–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

–°—É–¥—è –ø–æ –ª–æ–≥—É, —É –≤–∞—Å –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ –¥–≤–µ —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã.
## –ü—Ä–æ–±–ª–µ–º–∞ 1: 403 Forbidden (–û—à–∏–±–∫–∞ "–ó–∞–ø—Ä–µ—â–µ–Ω–æ")

FastAPI –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –±–ª–æ–∫–∏—Ä—É–µ—Ç WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–∏—Ö–æ–¥—è—Ç —Å "–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö" –¥–æ–º–µ–Ω–æ–≤ (Origin). –ú—ã –Ω–∞—Å—Ç—Ä–æ–∏–ª–∏ Nginx, —á—Ç–æ–±—ã –æ–Ω –ø–µ—Ä–µ–¥–∞–≤–∞–ª –¥–æ–º–µ–Ω (proxy_set_header Origin...), –Ω–æ —Ç–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ "—Å–∫–∞–∑–∞—Ç—å" FastAPI, —á—Ç–æ–±—ã –æ–Ω –¥–æ–≤–µ—Ä—è–ª —ç—Ç–æ–º—É –¥–æ–º–µ–Ω—É.
‚úÖ –†–µ—à–µ–Ω–∏–µ: –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ FastAPI (app.py)

–í–∞–º –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å CORSMiddleware –≤ –≤–∞—à –≥–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª FastAPI (app.py –∏–ª–∏ main.py), —á—Ç–æ–±—ã —Ä–∞–∑—Ä–µ—à–∏—Ç—å –≤–∞—à–µ–º—É –¥–æ–º–µ–Ω—É –ø–æ–¥–∫–ª—é—á–∞—Ç—å—Å—è.
Python

# backend/app.py
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

app = FastAPI()

# --- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö ---
origins = [
    "https://qwestor.general.singularitynet.dev", # –í–∞—à –¥–æ–º–µ–Ω
    "http://local.dev",                           # –î–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
    "https://local.dev",
]

app.add_middleware(
    CORSMiddleware,
    allow_origins=origins,
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
# --- –ö–û–ù–ï–¶ –ë–õ–û–ö–ê ---

# ... (–æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è, —Ä–æ—É—Ç–µ—Ä—ã –∏ —Ç.–¥.)

–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —ç—Ç–æ–≥–æ –∫–æ–¥–∞ –≤–∞–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä backend, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤—Å—Ç—É–ø–∏–ª–∏ –≤ —Å–∏–ª—É:
Bash

docker-compose up -d --force-recreate backend

## –ü—Ä–æ–±–ª–µ–º–∞ 2: –î–≤–æ–π–Ω–æ–π —Å–ª—ç—à //notifications

–í –≤–∞—à–µ–º –ª–æ–≥–µ –≤–∏–¥–µ–Ω –æ—á–µ–Ω—å –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—É—Ç—å: "WebSocket //notifications?user-id=anonymous"

Nginx –¥–æ–ª–∂–µ–Ω –±—ã–ª —É–¥–∞–ª–∏—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å /ws/, –æ—Å—Ç–∞–≤–∏–≤ —Ç–æ–ª—å–∫–æ /notifications.... –î–≤–æ–π–Ω–æ–π —Å–ª—ç—à (//) –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤–∞—à –∫–ª–∏–µ–Ω—Ç, –≤–µ—Ä–æ—è—Ç–Ω–æ, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —á—Ç–æ-—Ç–æ –≤—Ä–æ–¥–µ .../ws//notifications....

–≠—Ç–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –æ—à–∏–±–∫–µ 404 Not Found —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã –∏—Å–ø—Ä–∞–≤–∏—Ç–µ –æ—à–∏–±–∫—É 403. Nginx –º–æ–∂–µ—Ç "–∏—Å–ø—Ä–∞–≤–∏—Ç—å" —ç—Ç–æ –Ω–∞ –ª–µ—Ç—É.
‚úÖ –†–µ—à–µ–Ω–∏–µ: –°–¥–µ–ª–∞–π—Ç–µ Nginx –±–æ–ª–µ–µ "—É–º–Ω—ã–º"

–ú—ã –¥–æ–±–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª–æ rewrite –≤ Nginx, —á—Ç–æ–±—ã –æ–Ω "—Å—Ö–ª–æ–ø—ã–≤–∞–ª" –¥–≤–æ–π–Ω—ã–µ —Å–ª—ç—à–∏ –¥–æ —Ç–æ–≥–æ, –∫–∞–∫ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –±—ç–∫–µ–Ω–¥—É.

–í–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π nginx.conf.template (—Ç–æ–ª—å–∫–æ –±–ª–æ–∫ 443):
Nginx

# nginx/nginx.conf.template (–±–ª–æ–∫ 443)
server {
    listen 443 ssl;
    http2 on;
    server_name $DOMAIN;

    ssl_certificate /etc/letsencrypt/live/$DOMAIN/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/$DOMAIN/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES26-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    location /api/ {
        # (–∫–æ–Ω—Ñ–∏–≥ –¥–ª—è /api ... )
        proxy_pass http://backend_server/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin; 
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location /ws/ {
        # <-- –ù–û–í–û–ï –ü–†–ê–í–ò–õ–û –î–õ–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –î–í–û–ô–ù–û–ì–û –°–õ–≠–®–ê
        rewrite ^/ws//(.*)$ /ws/$1 last;

        proxy_pass http://backend_server/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Origin $http_origin;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }

    location / {
        # (–∫–æ–Ω—Ñ–∏–≥ –¥–ª—è / ... )
        proxy_pass http://frontend_server;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "Upgrade";
    }
}

–ü–æ—Å–ª–µ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è nginx.conf.template –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Nginx:
Bash

docker-compose exec nginx nginx -s reload

## –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π:

    –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ FastAPI (app.py), —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å 403 Forbidden.

    –ü–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä backend.

    –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤ nginx.conf.template, —á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å //notifications.

    –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥ Nginx.

–û—à–∏–±–∫–∞ 403 –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å.

–î–≤–æ–π–Ω–æ–≥–æ —Å–ª–µ—à–∞ –±–æ–ª—å—à–µ –Ω–µ—Ç

–ù–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ –µ—Å—Ç—å –∫–æ—Ä—Å CORS_ORIGINS=http://localhost:3000,https://qwestor.general.singularitynet.dev

–ü–æ–Ω—è–ª. –≠—Ç–æ –æ—á–µ–Ω—å –≤–∞–∂–Ω–∞—è –¥–µ—Ç–∞–ª—å.

–ü—Ä–æ–±–ª–µ–º–∞ –≤ —Ç–æ–º, —á—Ç–æ CORSMiddleware –≤ FastAPI –Ω–µ –ø—Ä–∏–º–µ–Ω—è–µ—Ç—Å—è –∫ WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è–º.

–≠—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω–∞—è –∏ —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω–µ–Ω–Ω–∞—è "–ª–æ–≤—É—à–∫–∞" FastAPI. CORSMiddleware –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Ç–æ–ª—å–∫–æ –æ–±—ã—á–Ω—ã–µ HTTP-–∑–∞–ø—Ä–æ—Å—ã (GET, POST –∏ —Ç.–¥.), –Ω–æ WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å—Ç–µ–∫–æ–º, –∫–æ—Ç–æ—Ä—ã–π –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç —ç—Ç–æ middleware.

–í–∞—à Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ. –û–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ Origin. –ù–æ –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ FastAPI –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –µ–≥–æ –¥–ª—è WebSocket.
‚úÖ –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É Origin –≤—Ä—É—á–Ω—É—é –≤ –∫–æ–¥ WebSocket

–í–∞–º –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –≤ –∫–æ–¥–µ –±—ç–∫–µ–Ω–¥–∞ (backend/) —Ñ—É–Ω–∫—Ü–∏—é, –∫–æ—Ç–æ—Ä–∞—è –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç WebSocket-—ç–Ω–¥–ø–æ–∏–Ω—Ç (–æ–Ω–∞ –±—É–¥–µ—Ç –≤—ã–≥–ª—è–¥–µ—Ç—å –∫–∞–∫ @app.websocket("/notifications") –∏–ª–∏ @router.websocket("/notifications")) –∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ –Ω–µ–µ —è–≤–Ω—É—é –ø—Ä–æ–≤–µ—Ä–∫—É Origin.

–í–æ—Ç –∫–∞–∫ —ç—Ç–æ –¥–æ–ª–∂–Ω–æ –≤—ã–≥–ª—è–¥–µ—Ç—å –≤ –≤–∞—à–µ–º –∫–æ–¥–µ (app.py –∏–ª–∏ –≥–¥–µ —É –≤–∞—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω —ç–Ω–¥–ø–æ–∏–Ω—Ç):
Python

import os
from fastapi import FastAPI, WebSocket, WebSocketDisconnect, status

app = FastAPI()

# ... (–≤–∞—à –∫–æ–¥ middleware, –∫–æ—Ç–æ—Ä—ã–π –≤—ã —É–∂–µ –¥–æ–±–∞–≤–∏–ª–∏, –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å) ...

# 1. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö –¥–æ–º–µ–Ω–æ–≤ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
# (–í—ã —Å–∫–∞–∑–∞–ª–∏, —á—Ç–æ —É –≤–∞—Å —ç—Ç–æ —É–∂–µ –µ—Å—Ç—å, –ø—Ä–æ—Å—Ç–æ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫–æ–¥ —ç—Ç–æ —á–∏—Ç–∞–µ—Ç)
ALLOWED_ORIGINS_STR = os.getenv("CORS_ORIGINS", "")
ALLOWED_ORIGINS = [origin.strip() for origin in ALLOWED_ORIGINS_STR.split(",") if origin.strip()]
# ALLOWED_ORIGINS —Ç–µ–ø–µ—Ä—å: ['http://localhost:3000', 'https://qwestor.general.singularitynet.dev']


# 2. –ù–∞–π–¥–∏—Ç–µ –≤–∞—à WebSocket —ç–Ω–¥–ø–æ–∏–Ω—Ç –∏ –¥–æ–±–∞–≤—å—Ç–µ –ø—Ä–æ–≤–µ—Ä–∫—É
# Nginx —É–¥–∞–ª—è–µ—Ç /ws/, –ø–æ—ç—Ç–æ–º—É –ø—É—Ç—å –≤ –∫–æ–¥–µ –±—É–¥–µ—Ç /notifications
@app.websocket("/notifications")
async def websocket_notifications(websocket: WebSocket, user_id: str):
    
    # --- –í–û–¢ –†–ï–®–ï–ù–ò–ï ---
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ Origin, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–¥–∞–ª Nginx
    origin = websocket.headers.get("origin")

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —ç—Ç–æ—Ç Origin –≤ –Ω–∞—à–µ–º —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö
    if not origin or origin not in ALLOWED_ORIGINS:
        # –ï—Å–ª–∏ –¥–æ–º–µ–Ω –Ω–µ —Ä–∞–∑—Ä–µ—à–µ–Ω, –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å –∫–æ–¥–æ–º –æ—à–∏–±–∫–∏
        await websocket.close(code=status.WS_1008_POLICY_VIOLATION)
        print(f"Connection rejected from untrusted origin: {origin}") # –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        return
    # --- –ö–û–ù–ï–¶ –†–ï–®–ï–ù–ò–Ø ---

    # –ï—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–π–¥–µ–Ω–∞, –ø—Ä–∏–Ω–∏–º–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
    await websocket.accept()
    print(f"Client {user_id} connected from origin: {origin}") # –õ–æ–≥ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
    
    try:
        while True:
            # ... (–≤–∞—à–∞ –æ—Å—Ç–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ WebSocket) ...
            data = await websocket.receive_text()
            await websocket.send_text(f"Received: {data}")
            
    except WebSocketDisconnect:
        print(f"Client {user_id} disconnected")

–ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:

    –ù–∞–π–¥–∏—Ç–µ —Ñ–∞–π–ª –≤ backend/, –≥–¥–µ —É –≤–∞—Å –æ–ø—Ä–µ–¥–µ–ª–µ–Ω @app.websocket("/notifications").

    –î–æ–±–∞–≤—å—Ç–µ –∫–æ–¥ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞ origin (–∫–∞–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤—ã—à–µ) –ø–µ—Ä–µ–¥ —Å—Ç—Ä–æ–∫–æ–π await websocket.accept().

    –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –±—ç–∫–µ–Ω–¥–∞, —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞ –ø—Ä–∏–º–µ–Ω–∏–ª–∏—Å—å:
    Bash

    docker-compose up -d --force-recreate backend

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤–∞—à –±—ç–∫–µ–Ω–¥ –±—É–¥–µ—Ç –≤—Ä—É—á–Ω—É—é –ø—Ä–æ–≤–µ—Ä—è—Ç—å Origin –¥–ª—è WebSocket-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ –æ—à–∏–±–∫–∞ 403 –¥–æ–ª–∂–Ω–∞ –∏—Å—á–µ–∑–Ω—É—Ç—å.

make config with k3s deploy

–ü–µ—Ä–µ—Ö–æ–¥ —Å Docker Compose –Ω–∞ K3s (Kubernetes) ‚Äî —ç—Ç–æ –æ—Ç–ª–∏—á–Ω—ã–π —à–∞–≥ –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç–∏ –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏.

–í Kubernetes –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –º–µ–Ω—è–µ—Ç—Å—è:

    Nginx (–∫–∞–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä) –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ Ingress Controller (–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫ –Ω–∞–≥—Ä—É–∑–∫–∏).

    Certbot –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ cert-manager (—Å—Ç–∞–Ω–¥–∞—Ä—Ç K8s –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è SSL).

    Docker Compose Services —Å—Ç–∞–Ω–æ–≤—è—Ç—Å—è Deployments –∏ Services.

–í–æ—Ç –ø–æ–ª–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –¥–µ–ø–ª–æ—è –≤–∞—à–µ–≥–æ —Å—Ç–µ–∫–∞ –≤ K3s.
## 0. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ (Prerequisites)

–í K3s –≤—ã –Ω–µ "—Å—Ç—Ä–æ–∏—Ç–µ" –æ–±—Ä–∞–∑—ã –Ω–∞ –ª–µ—Ç—É (–∫–∞–∫ build: .). –í–∞–º –Ω—É–∂–Ω–æ —Å–æ–±—Ä–∞—Ç—å –∏—Ö –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤ —Ä–µ–µ—Å—Ç—Ä (Docker Hub, GitHub Registry –∏–ª–∏ GitLab Registry).

    –°–æ–±–µ—Ä–∏—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –æ–±—Ä–∞–∑—ã:
    Bash

# Backend
docker build -t your-dockerhub-user/backend:v1 ./backend
docker push your-dockerhub-user/backend:v1

# Frontend (–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Dockerfile –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞!)
docker build -t your-dockerhub-user/frontend:v1 ./frontend
docker push your-dockerhub-user/frontend:v1

–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Nginx Ingress (–µ—Å–ª–∏ –≤—ã –æ—Ç–∫–ª—é—á–∏–ª–∏ Traefik –≤ K3s) –∏ Cert-Manager:
Bash

    # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ cert-manager (–¥–ª—è SSL)
    kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.13.0/cert-manager.yaml

## 1. ConfigMap –∏ Secrets (–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è)

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª 01-config.yaml. –ó–¥–µ—Å—å —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è.
YAML

apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ CORS –¥–ª—è FastAPI
  CORS_ORIGINS: "https://qwestor.general.singularitynet.dev"
  # –î—Ä—É–≥–∏–µ –Ω–µ—Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
---
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
type: Opaque
stringData:
  # –°—é–¥–∞ –¥–æ–±–∞–≤—å—Ç–µ –≤–∞—à–∏ —Å–µ–∫—Ä–µ—Ç—ã (API –∫–ª—é—á–∏ –∏ —Ç.–¥.)
  OPENAI_API_KEY: "sk-..."

## 2. Persistent Volume (–•—Ä–∞–Ω–∏–ª–∏—â–µ)

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª 02-storage.yaml. –≠—Ç–æ –∑–∞–º–µ–Ω–∞ volumes: backend_storage.
YAML

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backend-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  # –í K3s –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è local-path storage class

## 3. Backend Deployment

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª 03-backend.yaml.
YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 1 # –ú–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      containers:
        - name: backend
          image: your-dockerhub-user/backend:v1 # <--- –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –û–ë–†–ê–ó
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: app-config
            - secretRef:
                name: app-secrets
          volumeMounts:
            - mountPath: /app/storage_data
              name: storage
      volumes:
        - name: storage
          persistentVolumeClaim:
            claimName: backend-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
spec:
  selector:
    app: backend
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000

## 4. Frontend Deployment

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª 04-frontend.yaml.
YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      containers:
        - name: frontend
          image: your-dockerhub-user/frontend:v1 # <--- –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–® –û–ë–†–ê–ó
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
spec:
  selector:
    app: frontend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80

## 5. SSL (Let's Encrypt Issuer)

–í–º–µ—Å—Ç–æ —Å–∫—Ä–∏–ø—Ç–æ–≤ –∏ Certbot-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, –º—ã —Å–æ–∑–¥–∞–µ–º —Ä–µ—Å—É—Ä—Å ClusterIssuer. –°–æ–∑–¥–∞–π—Ç–µ 05-issuer.yaml.
YAML

apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: your_email@example.com # <--- –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–®–£ –ü–û–ß–¢–£
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
      - http01:
          ingress:
            class: nginx # –ò–ª–∏ traefik, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π K3s ingress

## 6. Ingress (–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è)

–≠—Ç–æ —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π —Ñ–∞–π–ª. –û–Ω –∑–∞–º–µ–Ω—è–µ—Ç –≤–∞—à nginx.conf. –°–æ–∑–¥–∞–π—Ç–µ 06-ingress.yaml.

–ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å WebSocket, —Ç–∞–π–º–∞—É—Ç—ã –∏ SSL.
YAML

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  annotations:
    # –£–∫–∞–∑—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Nginx Ingress Controller
    kubernetes.io/ingress.class: "nginx"
    
    # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ cert-manager
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è WebSocket (—Ç–∞–π–º–∞—É—Ç—ã —á—Ç–µ–Ω–∏—è/–∑–∞–ø–∏—Å–∏)
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    
    # –í–∫–ª—é—á–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è WS (–∞–Ω–∞–ª–æ–≥ Upgrade –∏ Connection –≤ nginx.conf)
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    
    # –õ–∏–º–∏—Ç –Ω–∞ —Ä–∞–∑–º–µ—Ä —Ç–µ–ª–∞ –∑–∞–ø—Ä–æ—Å–∞ (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç–µ —Ñ–∞–π–ª—ã)
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"

    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω—ã—Ö —Å–ª–µ—à–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, Ingress –æ–±—ã—á–Ω–æ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å–∞–º)
    # nginx.ingress.kubernetes.io/rewrite-target: /$1

spec:
  tls:
    - hosts:
        - qwestor.general.singularitynet.dev # <--- –í–ê–® –î–û–ú–ï–ù
      secretName: app-tls-secret # –°—é–¥–∞ cert-manager –ø–æ–ª–æ–∂–∏—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
  rules:
    - host: qwestor.general.singularitynet.dev # <--- –í–ê–® –î–û–ú–ï–ù
      http:
        paths:
          # –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è API
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          
          # –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è WebSocket
          - path: /ws
            pathType: Prefix
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          
          # –ú–∞—Ä—à—Ä—É—Ç –¥–ª—è –§—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ)
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend-service
                port:
                  number: 80

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å

    –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å K3s.

    –ü—Ä–∏–º–µ–Ω–∏—Ç–µ –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π:
    Bash

    kubectl apply -f 01-config.yaml
    kubectl apply -f 02-storage.yaml
    kubectl apply -f 03-backend.yaml
    kubectl apply -f 04-frontend.yaml
    kubectl apply -f 05-issuer.yaml
    kubectl apply -f 06-ingress.yaml

## –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

    –°—Ç–∞—Ç—É—Å –ø–æ–¥–æ–≤: kubectl get pods

    –°—Ç–∞—Ç—É—Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞: kubectl get certificate (–î–æ–ª–∂–Ω–æ —Å—Ç–∞—Ç—å True —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É).

    –°—Ç–∞—Ç—É—Å Ingress: kubectl get ingress

    –õ–æ–≥–∏ –±—ç–∫–µ–Ω–¥–∞: kubectl logs -l app=backend -f

–í–∞–∂–Ω–æ–µ –∑–∞–º–µ—á–∞–Ω–∏–µ –ø—Ä–æ K3s –∏ Traefik: –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é K3s —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç Traefik –≤ –∫–∞—á–µ—Å—Ç–≤–µ Ingress Controller.

    –ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤—ã—à–µ (–¥–ª—è Nginx Ingress), –≤–∞–º –Ω—É–∂–Ω–æ –ª–∏–±–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Nginx Ingress Controller (helm install ...), –ª–∏–±–æ –∏–∑–º–µ–Ω–∏—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é –≤ 06-ingress.yaml –Ω–∞ kubernetes.io/ingress.class: "traefik", –Ω–æ —Å–∏–Ω—Ç–∞–∫—Å–∏—Å –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π –¥–ª—è middleware —É Traefik –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è.

    –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –ï—Å–ª–∏ –≤—ã –ø—Ä–∏–≤—ã–∫–ª–∏ –∫ Nginx, –æ—Ç–∫–ª—é—á–∏—Ç–µ Traefik –ø—Ä–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–µ K3s (curl ... | sh -s - --disable traefik) –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Nginx Ingress Controller. –≠—Ç–æ —É–ø—Ä–æ—Å—Ç–∏—Ç –º–∏–≥—Ä–∞—Ü–∏—é –≤–∞—à–µ–≥–æ –∫–æ–Ω—Ñ–∏–≥–∞.

–º–æ–∂–Ω–æ –ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å aws ecr

–î–∞, –±–µ–∑—É—Å–ª–æ–≤–Ω–æ. AWS ECR (Elastic Container Registry) ‚Äî —ç—Ç–æ –æ—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä, –æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ –≤—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ AWS EC2. –≠—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –∏ –±—ã—Å—Ç—Ä–µ–µ, —Ç–∞–∫ –∫–∞–∫ —Ç—Ä–∞—Ñ–∏–∫ –º–µ–∂–¥—É ECR –∏ EC2 –≤–Ω—É—Ç—Ä–∏ –æ–¥–Ω–æ–≥–æ —Ä–µ–≥–∏–æ–Ω–∞ AWS —á–∞—Å—Ç–æ –±–µ—Å–ø–ª–∞—Ç–µ–Ω –∏ –∏–º–µ–µ—Ç –≤—ã—Å–æ–∫—É—é —Å–∫–æ—Ä–æ—Å—Ç—å.

–û–¥–Ω–∞–∫–æ, –≤ –æ—Ç–ª–∏—á–∏–µ –æ—Ç –ø—É–±–ª–∏—á–Ω–æ–≥–æ Docker Hub, ECR ‚Äî —ç—Ç–æ –ø—Ä–∏–≤–∞—Ç–Ω—ã–π —Ä–µ–µ—Å—Ç—Ä. –í–∞—à –∫–ª–∞—Å—Ç–µ—Ä K3s –Ω–µ —Å–º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å –æ—Ç—Ç—É–¥–∞ –æ–±—Ä–∞–∑—ã "–ø—Ä–æ—Å—Ç–æ —Ç–∞–∫", –µ–º—É –Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (–∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è).

–í–æ—Ç –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è, –∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å AWS ECR –¥–ª—è –≤–∞—à–µ–≥–æ K3s –∫–ª–∞—Å—Ç–µ—Ä–∞.
## –®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (IAM) –¥–ª—è EC2

–ß—Ç–æ–±—ã –≤–∞—à —Å–µ—Ä–≤–µ—Ä –º–æ–≥ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏ —Å–∫–∞—á–∏–≤–∞—Ç—å –æ–±—Ä–∞–∑—ã, —É –Ω–µ–≥–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ.

    –ó–∞–π–¥–∏—Ç–µ –≤ AWS Console -> IAM -> Roles.

    –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—É—é —Ä–æ–ª—å –¥–ª—è —Å–µ—Ä–≤–∏—Å–∞ EC2.

    –ü—Ä–∏–∫—Ä–µ–ø–∏—Ç–µ –∫ –Ω–µ–π –ø–æ–ª–∏—Ç–∏–∫—É (Policy): AmazonEC2ContainerRegistryPowerUser (—ç—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç –∏ —á–∏—Ç–∞—Ç—å, –∏ –ø–∏—Å–∞—Ç—å –æ–±—Ä–∞–∑—ã).

    –ó–∞–π–¥–∏—Ç–µ –≤ EC2, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à –∏–Ω—Å—Ç–∞–Ω—Å -> Actions -> Security -> Modify IAM role.

    –í—ã–±–µ—Ä–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–Ω—É—é —Ä–æ–ª—å –∏ —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ.

## –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–≤ –∏ Push –æ–±—Ä–∞–∑–æ–≤

–ù–∞ –≤–∞—à–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ (–∏–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –≥–¥–µ –≤—ã —Å–æ–±–∏—Ä–∞–µ—Ç–µ Docker):

    –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ AWS CLI –∏ –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ (aws configure).

    –°–æ–∑–¥–∞–π—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ (–¥–ª—è –±—ç–∫–µ–Ω–¥–∞ –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞):
    Bash

aws ecr create-repository --repository-name backend
aws ecr create-repository --repository-name frontend

–ó–∞–ª–æ–≥–∏–Ω—å—Ç–µ—Å—å –≤ Docker —á–µ—Ä–µ–∑ AWS CLI: (–ó–∞–º–µ–Ω–∏—Ç–µ REGION –∏ ACCOUNT_ID –Ω–∞ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ)
Bash

aws ecr get-login-password --region REGION | docker login --username AWS --password-stdin ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com

–°–æ–±–µ—Ä–∏—Ç–µ –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ (Push) –æ–±—Ä–∞–∑—ã:
Bash

    # –°–±–æ—Ä–∫–∞
    docker build -t backend ./backend

    # –¢–µ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ (—Å—Å—ã–ª–∫–∞ –Ω–∞ ECR)
    docker tag backend:latest ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com/backend:v1

    # –û—Ç–ø—Ä–∞–≤–∫–∞
    docker push ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com/backend:v1

    # (–ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è frontend)

## –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ K3s –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ ECR

K3s –Ω—É–∂–µ–Ω "–ø–∞—Ä–æ–ª—å" –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—Ä–∏–≤–∞—Ç–Ω–æ–º—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—é. –í Kubernetes —ç—Ç–æ –¥–µ–ª–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ Secret.

–ü—Ä–æ–±–ª–µ–º–∞: –¢–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ ECR –∂–∏–≤–µ—Ç –≤—Å–µ–≥–æ 12 —á–∞—Å–æ–≤. –†–µ—à–µ–Ω–∏–µ: –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —Å—Ç–∞–≤—è—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –æ–±–Ω–æ–≤–ª—è—Ç–æ—Ä, –Ω–æ –¥–ª—è –Ω–∞—á–∞–ª–∞ –º—ã —Å–æ–∑–¥–∞–¥–∏–º —Å–µ–∫—Ä–µ—Ç –≤—Ä—É—á–Ω—É—é.

–í—ã–ø–æ–ª–Ω–∏—Ç–µ —ç—Ç—É –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ —Å K3s:
Bash

# –ó–∞–º–µ–Ω–∏—Ç–µ REGION, ACCOUNT_ID –∏ YOUR_EMAIL
kubectl create secret docker-registry ecr-secret \
  --docker-server=ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com \
  --docker-username=AWS \
  --docker-password=$(aws ecr get-login-password --region REGION) \
  --docker-email=YOUR_EMAIL

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ –µ—Å—Ç—å —Å–µ–∫—Ä–µ—Ç —Å –∏–º–µ–Ω–µ–º ecr-secret.
## –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ Deployment YAML

–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ —Å–∫–∞–∑–∞—Ç—å Kubernetes: "–ò—Å–ø–æ–ª—å–∑—É–π –æ–±—Ä–∞–∑—ã –∏–∑ ECR" –∏ "–ò—Å–ø–æ–ª—å–∑—É–π —Å–µ–∫—Ä–µ—Ç ecr-secret –¥–ª—è –¥–æ—Å—Ç—É–ø–∞".

–û–±–Ω–æ–≤–∏—Ç–µ —Ñ–∞–π–ª—ã 03-backend.yaml –∏ 04-frontend.yaml:
YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  # ...
  template:
    # ...
    spec:
      # --- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö ---
      imagePullSecrets:
        - name: ecr-secret
      # --------------------------
      containers:
        - name: backend
          # –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –ø–æ–ª–Ω—ã–π URI –∏–∑ ECR
          image: ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com/backend:v1
          # ...

–°–¥–µ–ª–∞–π—Ç–µ —Ç–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è frontend.
## –®–∞–≥ 5: –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ
Bash

kubectl apply -f 03-backend.yaml
kubectl apply -f 04-frontend.yaml

–¢–µ–ø–µ—Ä—å K3s —Å–º–æ–∂–µ—Ç —Å–∫–∞—á–∞—Ç—å –≤–∞—à–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –æ–±—Ä–∞–∑—ã –∏–∑ AWS ECR.
‚ö†Ô∏è –í–∞–∂–Ω–æ–µ –ø—Ä–∏–º–µ—á–∞–Ω–∏–µ –ø—Ä–æ 12 —á–∞—Å–æ–≤

–¢–∞–∫ –∫–∞–∫ –º—ã —Å–æ–∑–¥–∞–ª–∏ —Å–µ–∫—Ä–µ—Ç –≤—Ä—É—á–Ω—É—é (—à–∞–≥ 3), —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤ —Ç–æ–∫–µ–Ω –ø—Ä–æ—Ç—É—Ö–Ω–µ—Ç. –ï—Å–ª–∏ K3s –∑–∞—Ö–æ—á–µ—Ç –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–¥ –∏–ª–∏ —Å–∫–∞—á–∞—Ç—å –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é, –æ–Ω –ø–æ–ª—É—á–∏—Ç –æ—à–∏–±–∫—É ImagePullBackOff.

–ö–∞–∫ —Å–¥–µ–ª–∞—Ç—å "–≤–µ—á–Ω—ã–π" –¥–æ—Å—Ç—É–ø?

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± –¥–ª—è K3s ‚Äî —Å–æ–∑–¥–∞—Ç—å CronJob, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å —ç—Ç–æ—Ç —Å–µ–∫—Ä–µ—Ç –∫–∞–∂–¥—ã–µ 10 —á–∞—Å–æ–≤.

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª ecr-cronjob.yaml:
YAML

apiVersion: batch/v1
kind: CronJob
metadata:
  name: ecr-registry-helper
  namespace: default
spec:
  schedule: "0 */10 * * *" # –ö–∞–∂–¥—ã–µ 10 —á–∞—Å–æ–≤
  successfulJobsHistoryLimit: 1
  suspend: false
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: default # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É serviceAccount –µ—Å—Ç—å –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ (RoleBinding)
          containers:
          - name: ecr-registry-helper
            image: odaniait/aws-kubectl:latest
            imagePullPolicy: IfNotPresent
            env:
              - name: AWS_REGION
                value: "us-east-1" # <-- –í–ê–® –†–ï–ì–ò–û–ù
              - name: ECR_REGISTRY
                value: "123456789012.dkr.ecr.us-east-1.amazonaws.com" # <-- –í–ê–® ECR URL
            command:
              - /bin/sh
              - -c
              - |-
                ECR_TOKEN=`aws ecr get-login-password --region ${AWS_REGION}`
                kubectl delete secret --ignore-not-found ecr-secret
                kubectl create secret docker-registry ecr-secret \
                  --docker-server=${ECR_REGISTRY} \
                  --docker-username=AWS \
                  --docker-password=${ECR_TOKEN}
          restartPolicy: Never

(–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: –î–ª—è —Ä–∞–±–æ—Ç—ã —ç—Ç–æ–≥–æ CronJob –≤–∞—à–µ–º—É ServiceAccount –≤ K3s –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –ø—Ä–∞–≤–∞ (RBAC) –Ω–∞ —É–¥–∞–ª–µ–Ω–∏–µ –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤. –ï—Å–ª–∏ —ç—Ç–æ —Å–ª–æ–∂–Ω–æ —Å–µ–π—á–∞—Å, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å–∫–∞–π—Ç–µ –∫–æ–º–∞–Ω–¥—É –∏–∑ –®–∞–≥–∞ 3 –≤—Ä—É—á–Ω—É—é –ø–µ—Ä–µ–¥ –¥–µ–ø–ª–æ–µ–º).

–∫–∞–∫–∏–µ –µ—â–µ —Ö—Ä–∞–Ω–∏–ª–∫–∏ –¥–ª—è –æ–±—Ä–∞–∑–æ–≤ —Å—É—â–µ—Å—Ç–≤—É—é—Ç

–ö—Ä–æ–º–µ AWS ECR –∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ Docker Hub, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –º–Ω–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤. –í—ã–±–æ—Ä –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, –≥–¥–µ –ª–µ–∂–∏—Ç –≤–∞—à –∫–æ–¥, –∫–∞–∫–æ–π —É –≤–∞—Å –±—é–¥–∂–µ—Ç –∏ –Ω—É–∂–Ω–∞ –ª–∏ –≤–∞–º –ø—Ä–∏–≤–∞—Ç–Ω–æ—Å—Ç—å.

–í–æ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã, —Ä–∞–∑–±–∏—Ç—ã–µ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º:
1. –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å Git (–°–∞–º—ã–µ —É–¥–æ–±–Ω—ã–µ)

–ï—Å–ª–∏ –≤—ã —É–∂–µ —Ö—Ä–∞–Ω–∏—Ç–µ –∫–æ–¥ –Ω–∞ GitHub –∏–ª–∏ GitLab, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∏—Ö –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã—Ö —Ä–µ–µ—Å—Ç—Ä–æ–≤ ‚Äî —ç—Ç–æ —Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –ø—É—Ç—å. –í–∞–º –Ω–µ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ (IAM), —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –≤–∞—à–µ–º—É –∞–∫–∫–∞—É–Ω—Ç—É —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

    GitHub Container Registry (GHCR)

        –ê–¥—Ä–µ—Å: ghcr.io

        –ü–ª—é—Å—ã: –ë–µ—Å–ø–ª–∞—Ç–Ω–æ –¥–ª—è –ø—É–±–ª–∏—á–Ω—ã—Ö –æ–±—Ä–∞–∑–æ–≤. –•–æ—Ä–æ—à–∏–π –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ª–∏–º–∏—Ç –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö (500MB/–º–µ—Å). –ò–¥–µ–∞–ª—å–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å GitHub Actions (—Å–±–æ—Ä–∫–∞ –∏ –ø—É—à –≤ 2 —Å—Ç—Ä–æ—á–∫–∏).

        –ú–∏–Ω—É—Å—ã: –ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–∫–µ—Ç–∞–º –∏–Ω–æ–≥–¥–∞ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ –æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

    GitLab Container Registry

        –ê–¥—Ä–µ—Å: registry.gitlab.com

        –ü–ª—é—Å—ã: –í—Å—Ç—Ä–æ–µ–Ω –≤ –∫–∞–∂–¥—ã–π –ø—Ä–æ–µ–∫—Ç GitLab –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é. –û—á–µ–Ω—å —É–¥–æ–±–Ω–æ –¥–ª—è CI/CD –≤–Ω—É—Ç—Ä–∏ GitLab.

        –ú–∏–Ω—É—Å—ã: –ú–æ–∂–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—å –º–µ—Å—Ç–æ –≤ –∫–≤–æ—Ç–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è.

2. Self-Hosted (–î–ª—è –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç—Ä–æ–ª—è)

–ï—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Ö—Ä–∞–Ω–∏—Ç—å –æ–±—Ä–∞–∑—ã –≤–Ω—É—Ç—Ä–∏ —Å–≤–æ–µ–≥–æ K3s –∫–ª–∞—Å—Ç–µ—Ä–∞ –∏–ª–∏ –Ω–∞ —Å–≤–æ–µ–º —Å–µ—Ä–≤–µ—Ä–µ, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≤–∏—Å–µ—Ç—å –æ—Ç –æ–±–ª–∞–∫–æ–≤ –∏ –Ω–µ –ø–ª–∞—Ç–∏—Ç—å –∑–∞ —Ç—Ä–∞—Ñ–∏–∫.

    Harbor (–ó–æ–ª–æ—Ç–æ–π —Å—Ç–∞–Ω–¥–∞—Ä—Ç)

        –ß—Ç–æ —ç—Ç–æ: Open-source –ø—Ä–æ–µ–∫—Ç —É—Ä–æ–≤–Ω—è Enterprise (CNCF graduated).

        –ü–ª—é—Å—ã: –ò–º–µ–µ—Ç –∫—Ä–∞—Å–∏–≤—ã–π –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —Å–∫–∞–Ω–µ—Ä —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π (Trivy), —Ä–µ–ø–ª–∏–∫–∞—Ü–∏—é –æ–±—Ä–∞–∑–æ–≤, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º (RBAC).

        –î–ª—è –∫–æ–≥–æ: –ï—Å–ª–∏ —É –≤–∞—Å —Å–µ—Ä—å–µ–∑–Ω—ã–π –ø—Ä–æ–¥–∞–∫—à–Ω –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ï–≥–æ –º–æ–∂–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç—å –ø—Ä—è–º–æ –≤ K3s —á–µ—Ä–µ–∑ Helm.

    Shutterstock

    Docker Registry (–õ–æ–∫–∞–ª—å–Ω—ã–π)

        –ß—Ç–æ —ç—Ç–æ: –û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ registry:2.

        –ü–ª—é—Å—ã: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ –ø—Ä–æ—Å—Ç–æ–π. –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –æ–¥–Ω–æ–π –∫–æ–º–∞–Ω–¥–æ–π docker run.

        –ú–∏–Ω—É—Å—ã: –ù–µ—Ç –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ (—Ç–æ–ª—å–∫–æ API), –Ω–µ—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ "–∏–∑ –∫–æ—Ä–æ–±–∫–∏".

3. –î—Ä—É–≥–∏–µ –æ–±–ª–∞—á–Ω—ã–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä—ã

–ï—Å–ª–∏ –≤—ã —Ä–µ—à–∏—Ç–µ –ø–µ—Ä–µ–µ—Ö–∞—Ç—å —Å AWS, —É –∫–∞–∂–¥–æ–≥–æ –æ–±–ª–∞–∫–∞ –µ—Å—Ç—å –∞–Ω–∞–ª–æ–≥ ECR:

    Google Artifact Registry (GAR): (–ó–∞–º–µ–Ω–∞ —Å—Ç–∞—Ä–æ–º—É GCR). –û—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π, –µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Google Kubernetes Engine (GKE).

    Azure Container Registry (ACR): –û—Ç–ª–∏—á–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Active Directory.

    DigitalOcean Container Registry: –û—á–µ–Ω—å –ø—Ä–æ—Å—Ç–æ–π –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ, –¥–µ—à–µ–≤–ª–µ –≥–∏–≥–∞–Ω—Ç–æ–≤.

4. –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ "–∫–æ–º–±–∞–π–Ω—ã"

–ï—Å–ª–∏ –≤–∞—à–∞ –∫–æ–º–ø–∞–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Java (Maven), npm, Python (PyPI) –∏ —Ö–æ—á–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å –≤—Å—ë –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ.

    Sonatype Nexus Repository OSS: –ü–æ–ø—É–ª—è—Ä–µ–Ω –≤ –º–∏—Ä–µ Java. –£–º–µ–µ—Ç —Ö—Ä–∞–Ω–∏—Ç—å Docker –æ–±—Ä–∞–∑—ã –Ω–∞—Ä—è–¥—É —Å .jar —Ñ–∞–π–ª–∞–º–∏.

    JFrog Artifactory: –ú–æ—â–Ω—ã–π —ç–Ω—Ç–µ—Ä–ø—Ä–∞–π–∑ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç, –Ω–æ –¥–æ—Ä–æ–≥–æ–π.

–ò—Ç–æ–≥–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
–†–µ–µ—Å—Ç—Ä	–¶–µ–Ω–∞ (–ü—Ä–∏–≤–∞—Ç–Ω—ã–µ)	–°–ª–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏	–î–ª—è –∫–æ–≥–æ –ª—É—á—à–µ
AWS ECR	–ü–ª–∞—Ç–Ω–æ (–∑–∞ GB + —Ç—Ä–∞—Ñ–∏–∫)	–°—Ä–µ–¥–Ω—è—è (IAM)	–ï—Å–ª–∏ –≤—ã —É–∂–µ –Ω–∞ AWS EC2/EKS
GitHub (GHCR)	–ë–µ—Å–ø–ª–∞—Ç–Ω–æ (–¥–æ –ª–∏–º–∏—Ç–∞)	–û—á–µ–Ω—å –Ω–∏–∑–∫–∞—è	–ï—Å–ª–∏ –∫–æ–¥ –Ω–∞ GitHub
Docker Hub	1 –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ	–ù–∏–∑–∫–∞—è	–î–ª—è –ø–µ—Ç-–ø—Ä–æ–µ–∫—Ç–æ–≤ / Open Source
Harbor	–ë–µ—Å–ø–ª–∞—Ç–Ω–æ (—Å–≤–æ–π —Å–µ—Ä–≤–µ—Ä)	–í—ã—Å–æ–∫–∞—è	–î–ª—è —Å–µ—Ä—å–µ–∑–Ω–æ–≥–æ Self-Hosted
Nexus OSS	–ë–µ—Å–ø–ª–∞—Ç–Ω–æ (—Å–≤–æ–π —Å–µ—Ä–≤–µ—Ä)	–°—Ä–µ–¥–Ω—è—è	–ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å Java/Maven

–ú–æ—è —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è –¥–ª—è –≤–∞—à–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ —ç—Ç–∞–ø–∞:

–ï—Å–ª–∏ –≤–∞—à –∫–æ–¥ –Ω–∞ GitHub, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ GHCR (ghcr.io).

    –≠—Ç–æ –±–µ—Å–ø–ª–∞—Ç–Ω–æ.

    –í–∞–º –Ω–µ –Ω—É–∂–Ω–æ –≤–æ–∑–∏—Ç—å—Å—è —Å —Ç–æ–∫–µ–Ω–∞–º–∏ AWS, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–æ—Ç—É—Ö–∞—é—Ç —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤. –í—ã –ø—Ä–æ—Å—Ç–æ —Å–æ–∑–¥–∞–µ—Ç–µ Personal Access Token (Classic) –≤ GitHub —Å –ø—Ä–∞–≤–∞–º–∏ read:packages, –∏ –æ–Ω –≤–µ—á–Ω—ã–π.

    K3s –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤—Å–µ–≥–¥–∞.

–ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å github registry

–û—Ç–ª–∏—á–Ω—ã–π –≤—ã–±–æ—Ä. GitHub Container Registry (GHCR) ‚Äî —ç—Ç–æ, –ø–æ–∂–∞–ª—É–π, —Å–∞–º—ã–π —É–¥–æ–±–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, —á–µ–π –∫–æ–¥ —É–∂–µ –ª–µ–∂–∏—Ç –Ω–∞ GitHub.

–ì–ª–∞–≤–Ω–æ–µ –ø—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–æ –ø–µ—Ä–µ–¥ AWS ECR: —Ç–æ–∫–µ–Ω –Ω–µ –ø—Ä–æ—Ç—É—Ö–∞–µ—Ç –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤. –í—ã —Å–æ–∑–¥–∞–µ—Ç–µ –µ–≥–æ –æ–¥–∏–Ω —Ä–∞–∑, –∏ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –≥–æ–¥–∞–º–∏.

–í–æ—Ç –ø–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ.
## –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ (PAT)

–í–∞–º –Ω–µ–ª—å–∑—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π –ø–∞—Ä–æ–ª—å –æ—Ç GitHub –¥–ª—è Docker. –ù—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å Personal Access Token (Classic).

    –ó–∞–π–¥–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub: Settings -> Developer settings (–≤ —Å–∞–º–æ–º –Ω–∏–∑—É —Å–ª–µ–≤–∞).

    –í—ã–±–µ—Ä–∏—Ç–µ Personal access tokens -> Tokens (classic).

    –ù–∞–∂–º–∏—Ç–µ Generate new token (classic).

    Scopes (–ü—Ä–∞–≤–∞): –û—Ç–º–µ—Ç—å—Ç–µ –≥–∞–ª–æ—á–∫–∞–º–∏:

        write:packages (—á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∂–∞—Ç—å –æ–±—Ä–∞–∑—ã)

        read:packages (—á—Ç–æ–±—ã —Å–∫–∞—á–∏–≤–∞—Ç—å –æ–±—Ä–∞–∑—ã)

        delete:packages (—á—Ç–æ–±—ã —É–¥–∞–ª—è—Ç—å —Å—Ç–∞—Ä—ã–µ)

    –ù–∞–∂–º–∏—Ç–µ Generate token.

    –°–ö–û–ü–ò–†–£–ô–¢–ï –ï–ì–û –°–†–ê–ó–£! –í—ã –±–æ–ª—å—à–µ –Ω–∏–∫–æ–≥–¥–∞ –µ–≥–æ –Ω–µ —É–≤–∏–¥–∏—Ç–µ.

## –®–∞–≥ 2: –õ–æ–∫–∞–ª—å–Ω—ã–π –≤—Ö–æ–¥ –∏ Push –æ–±—Ä–∞–∑–æ–≤

–¢–µ–ø–µ—Ä—å "—Å–≤—è–∂–µ–º" –≤–∞—à Docker –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ —Å GitHub.

    –õ–æ–≥–∏–Ω: –í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (–∑–∞–º–µ–Ω–∏—Ç–µ YOUR_TOKEN –Ω–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω, –∞ USERNAME –Ω–∞ –≤–∞—à –ª–æ–≥–∏–Ω GitHub):
    Bash

echo "YOUR_TOKEN" | docker login ghcr.io -u USERNAME --password-stdin

–ï—Å–ª–∏ –Ω–∞–ø–∏—Å–∞–ª–æ Login Succeeded, –≤—Å—ë –æ—Ç–ª–∏—á–Ω–æ.

–°–±–æ—Ä–∫–∞ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ (Push): –í GHCR –æ–±—Ä–∞–∑—ã –¥–æ–ª–∂–Ω—ã –Ω–∞–∑—ã–≤–∞—Ç—å—Å—è —Ç–∞–∫: ghcr.io/–≤–∞—à-—é–∑–µ—Ä–Ω–µ–π–º/–Ω–∞–∑–≤–∞–Ω–∏–µ-–æ–±—Ä–∞–∑–∞:—Ç–µ–≥.

–î–ª—è –ë—ç–∫–µ–Ω–¥–∞:
Bash

# 1. –°–æ–±–∏—Ä–∞–µ–º (–µ—Å–ª–∏ –µ—â–µ –Ω–µ —Å–æ–±—Ä–∞–Ω)
docker build -t ghcr.io/username/backend:v1 ./backend

# 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±–ª–∞–∫–æ
docker push ghcr.io/username/backend:v1

–î–ª—è –§—Ä–æ–Ω—Ç–µ–Ω–¥–∞:
Bash

    docker build -t ghcr.io/username/frontend:v1 ./frontend
    docker push ghcr.io/username/frontend:v1

## –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ K3s (–°–µ–∫—Ä–µ—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è)

–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ –¥–∞—Ç—å –≤–∞—à–µ–º—É –∫–ª–∞—Å—Ç–µ—Ä—É K3s —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω, —á—Ç–æ–±—ã –æ–Ω –º–æ–≥ —Å–∫–∞—á–∏–≤–∞—Ç—å –≤–∞—à–∏ –ø—Ä–∏–≤–∞—Ç–Ω—ã–µ –æ–±—Ä–∞–∑—ã.

–ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä —Å K3s –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:
Bash

# –ó–∞–º–µ–Ω–∏—Ç–µ:
# YOUR_GITHUB_USERNAME - –≤–∞—à –ª–æ–≥–∏–Ω
# YOUR_PAT_TOKEN - —Ç–æ—Ç —Å–∞–º—ã–π —Ç–æ–∫–µ–Ω –∏–∑ –®–∞–≥–∞ 1
# YOUR_EMAIL - –≤–∞—à–∞ –ø–æ—á—Ç–∞

kubectl create secret docker-registry ghcr-secret \
  --docker-server=ghcr.io \
  --docker-username=YOUR_GITHUB_USERNAME \
  --docker-password=YOUR_PAT_TOKEN \
  --docker-email=YOUR_EMAIL

–¢–µ–ø–µ—Ä—å —É –≤–∞—Å –µ—Å—Ç—å "–≤–µ—á–Ω—ã–π" —Å–µ–∫—Ä–µ—Ç ghcr-secret.
## –®–∞–≥ 4: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ YAML —Ñ–∞–π–ª–æ–≤

–û–±–Ω–æ–≤–∏—Ç–µ –≤–∞—à–∏ —Ñ–∞–π–ª—ã –¥–µ–ø–ª–æ—è (03-backend.yaml –∏ 04-frontend.yaml), —á—Ç–æ–±—ã –æ–Ω–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ GHCR –∏ —Å–æ–∑–¥–∞–Ω–Ω—ã–π —Å–µ–∫—Ä–µ—Ç.
YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  # ...
  template:
    spec:
      # 1. –£–∫–∞–∑—ã–≤–∞–µ–º –∏–º—è —Å–µ–∫—Ä–µ—Ç–∞
      imagePullSecrets:
        - name: ghcr-secret
      
      containers:
        - name: backend
          # 2. –£–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –∞–¥—Ä–µ—Å –æ–±—Ä–∞–∑–∞
          image: ghcr.io/username/backend:v1
          # ...

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø—Ä–∏–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
Bash

kubectl apply -f 03-backend.yaml

## –ë–æ–Ω—É—Å: –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ GitHub Actions

–°–∞–º–æ–µ –∫—Ä—É—Ç–æ–µ –≤ GHCR ‚Äî —ç—Ç–æ —Ç–æ, –∫–∞–∫ –ª–µ–≥–∫–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–±–æ—Ä–∫—É. –°–æ–∑–¥–∞–π—Ç–µ –≤ —Å–≤–æ–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Ñ–∞–π–ª .github/workflows/deploy.yml.

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤—ã –±—É–¥–µ—Ç–µ –¥–µ–ª–∞—Ç—å git push, GitHub —Å–∞–º —Å–æ–±–µ—Ä–µ—Ç Docker-–æ–±—Ä–∞–∑ –∏ –∑–∞–ª—å–µ—Ç –µ–≥–æ –≤ —Ä–µ–µ—Å—Ç—Ä.
YAML

name: Build and Push Docker Image

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }} # –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∏–º—è (user/repo)

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }} # –≠—Ç–æ—Ç —Ç–æ–∫–µ–Ω GitHub —Å–æ–∑–¥–∞–µ—Ç –°–ê–ú, –Ω–∏—á–µ–≥–æ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å –Ω–µ –Ω–∞–¥–æ!

      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ghcr.io/${{ github.repository }}/backend:latest
      
      # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ç–∞–∫–æ–π –∂–µ —à–∞–≥ –¥–ª—è Frontend

–° —ç—Ç–∏–º —Ñ–∞–π–ª–æ–º –≤–∞–º –¥–∞–∂–µ –Ω–µ –Ω—É–∂–Ω–æ —Å–æ–±–∏—Ä–∞—Ç—å Docker –Ω–∞ —Å–≤–æ–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ. –í—ã –ø—Ä–æ—Å—Ç–æ –ø–∏—à–µ—Ç–µ –∫–æ–¥, –ø—É—à–∏—Ç–µ –≤ Git, –∞ GitHub Actions –¥–µ–ª–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–ª—å–Ω–æ–µ.

–°–æ–±–µ—Ä–∏ –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥–∏ –≤–æ–µ–¥–∏–Ω–æ:

—Å–¥–µ–ª–∞–π configmap –∏–∑ env —Ñ–∞–π–ª–∞

–°–¥–µ–ª–∞–π –ø–∞–π–ø–ª–∞–π–Ω –¥–ª—è —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ github actions

–ö–æ–Ω–µ—á–Ω–æ. –î–∞–≤–∞–π—Ç–µ —Å–æ–±–µ—Ä–µ–º –≤—Å–µ –≤ —á–∏—Å—Ç—É—é, –≥–æ—Ç–æ–≤—É—é –∫ –ø—Ä–æ–¥–∞–∫—à–µ–Ω—É —Å—Ç—Ä—É–∫—Ç—É—Ä—É.

–ú—ã —Å–¥–µ–ª–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ:

    Kubernetes Manifests: –°–æ–∑–¥–∞–¥–∏–º –ø–∞–ø–∫—É k8s/, –≥–¥–µ –±—É–¥—É—Ç –ª–µ–∂–∞—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.

    ConfigMap & Secrets: –ü–µ—Ä–µ–Ω–µ—Å–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ .env –≤ —Ä–µ—Å—É—Ä—Å—ã Kubernetes.

    GitHub Actions: –ù–∞—Å—Ç—Ä–æ–∏–º CI/CD, –∫–æ—Ç–æ—Ä—ã–π —Å–æ–±–∏—Ä–∞–µ—Ç Docker-–æ–±—Ä–∞–∑—ã, –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ GHCR –∏ –¥–µ–ø–ª–æ–∏—Ç –Ω–∞ –≤–∞—à —Å–µ—Ä–≤–µ—Ä.

## –ß–∞—Å—Ç—å 1: –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫:
Plaintext

.
‚îú‚îÄ‚îÄ backend/            # –ö–æ–¥ –±—ç–∫–µ–Ω–¥–∞
‚îú‚îÄ‚îÄ frontend/           # –ö–æ–¥ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
‚îú‚îÄ‚îÄ k8s/                # –ù–û–í–ê–Ø –ü–ê–ü–ö–ê: –ö–æ–Ω—Ñ–∏–≥–∏ Kubernetes
‚îÇ   ‚îú‚îÄ‚îÄ 01-environment.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 02-backend.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 03-frontend.yaml
‚îÇ   ‚îî‚îÄ‚îÄ 04-ingress.yaml
‚îî‚îÄ‚îÄ .github/
    ‚îî‚îÄ‚îÄ workflows/
        ‚îî‚îÄ‚îÄ deploy.yml  # –ù–û–í–´–ô –§–ê–ô–õ: –ü–∞–π–ø–ª–∞–π–Ω

## –ß–∞—Å—Ç—å 2: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Kubernetes (k8s/)

–ó–∞–º–µ–Ω–∏—Ç–µ <GITHUB_USER> –∏ <REPO_NAME> –Ω–∞ –≤–∞—à–∏ —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
1. k8s/01-environment.yaml (ConfigMap, Secret, PVC)

–ó–¥–µ—Å—å –º—ã –æ–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏ —Å–µ–∫—Ä–µ—Ç—ã.

–í–∞–∂–Ω–æ: –°–µ–∫—Ä–µ—Ç ghcr-secret (–¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –æ–±—Ä–∞–∑–∞–º) –º—ã —Å–æ–∑–¥–∞–¥–∏–º –∫–æ–º–∞–Ω–¥–æ–π –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ–¥–∏–Ω —Ä–∞–∑, –≤ YAML –µ–≥–æ –æ–ø–∏—Å—ã–≤–∞—Ç—å –Ω–µ –Ω—É–∂–Ω–æ.
YAML

apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  # –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏–∑ –≤–∞—à–µ–≥–æ .env
  CORS_ORIGINS: "https://qwestor.general.singularitynet.dev,http://localhost:3000"
  LOG_LEVEL: "info"
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã)
  REACT_APP_API_URL: "https://qwestor.general.singularitynet.dev"

---
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
type: Opaque
stringData:
  # –°–Æ–î–ê –ü–ò–®–ï–ú –°–ï–ö–†–ï–¢–ù–´–ï –ö–õ–Æ–ß–ò
  # Kubernetes —Å–∞–º –∑–∞–∫–æ–¥–∏—Ä—É–µ—Ç –∏—Ö –≤ base64
  OPENAI_API_KEY: "sk-..." 

---
# –•—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –±—ç–∫–µ–Ω–¥–∞
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backend-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 5Gi

2. k8s/02-backend.yaml
YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      imagePullSecrets:
        - name: ghcr-secret # –°–µ–∫—Ä–µ—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –∏–∑ GitHub Registry
      containers:
        - name: backend
          # –í–ê–ñ–ù–û: –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –æ–±—Ä–∞–∑—É (–Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä!)
          image: ghcr.io/<GITHUB_USER>/<REPO_NAME>/backend:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          envFrom:
            - configMapRef:
                name: app-config
            - secretRef:
                name: app-secrets
          volumeMounts:
            - mountPath: /app/storage_data
              name: storage
      volumes:
        - name: storage
          persistentVolumeClaim:
            claimName: backend-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
spec:
  selector:
    app: backend
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000

3. k8s/03-frontend.yaml
YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: frontend
          # –í–ê–ñ–ù–û: –£–∫–∞–∂–∏—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ –æ–±—Ä–∞–∑—É
          image: ghcr.io/<GITHUB_USER>/<REPO_NAME>/frontend:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
spec:
  selector:
    app: frontend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80

4. k8s/04-ingress.yaml (–í—Ö–æ–¥, SSL, WebSocket)
YAML

# 1. Issuer –¥–ª—è Let's Encrypt
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: your-email@example.com # –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –í–ê–®–£ –ü–û–ß–¢–£
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
      - http01:
          ingress:
            class: nginx

---
# 2. Ingress (–ü—Ä–∞–≤–∏–ª–∞ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏)
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è WebSocket –∏ —Ç–∞–π–º–∞—É—Ç–æ–≤
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    
    # –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞ –∑–∞–≥—Ä—É–∑–∫–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    nginx.ingress.kubernetes.io/proxy-body-size: "50m"

    # –£–¥–∞–ª–µ–Ω–∏–µ —Å—É—Ñ—Ñ–∏–∫—Å–∞ /ws/ –∏–∑ –ø—É—Ç–∏ (—á—Ç–æ–±—ã –∏—Å–ø—Ä–∞–≤–∏—Ç—å –¥–≤–æ–π–Ω—ã–µ —Å–ª–µ—à–∏)
    # –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å /ws/notifications -> –±—ç–∫–µ–Ω–¥ –ø–æ–ª—É—á–∏—Ç /notifications
    nginx.ingress.kubernetes.io/rewrite-target: /$1
    nginx.ingress.kubernetes.io/use-regex: "true"

spec:
  tls:
    - hosts:
        - qwestor.general.singularitynet.dev
      secretName: app-tls-secret
  rules:
    - host: qwestor.general.singularitynet.dev
      http:
        paths:
          # API
          - path: /api/?(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          
          # WebSocket (—Å rewrite)
          - path: /ws/?(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          
          # Frontend
          - path: /(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: frontend-service
                port:
                  number: 80

## –ß–∞—Å—Ç—å 3: GitHub Actions Pipeline

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .github/workflows/deploy.yml.

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–µ–ª–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

    –°–æ–±–∏—Ä–∞–µ—Ç –æ–±—Ä–∞–∑—ã –ø—Ä–∏ –ø—É—à–µ –≤ –≤–µ—Ç–∫—É main.

    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∏—Ö –≤ GitHub Container Registry.

    –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –≤–∞—à–µ–º—É —Å–µ—Ä–≤–µ—Ä—É –ø–æ SSH.

    –ö–æ–ø–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏ k8s/ –Ω–∞ —Å–µ—Ä–≤–µ—Ä.

    –ü—Ä–∏–º–µ–Ω—è–µ—Ç –∏—Ö (kubectl apply) –∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ–¥—ã.

YAML

name: Build and Deploy to K3s

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  # –ò–º—è –æ–±—Ä–∞–∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –±–µ—Ä–µ—Ç—Å—è –∏–∑ –Ω–∞–∑–≤–∞–Ω–∏—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–Ω–∞–ø—Ä–∏–º–µ—Ä user/repo)
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Log in to the Container registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # –°–±–æ—Ä–∫–∞ Backend
      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest

      # –°–±–æ—Ä–∫–∞ Frontend
      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # 1. –ö–æ–ø–∏—Ä—É–µ–º —Ñ–∞–π–ª—ã k8s –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: Copy k8s configs to server
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "k8s/*"
          target: "~/app-deploy"

      # 2. –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –ø–æ SSH –∏ –ø—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
      - name: Apply K8s manifests
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –≤—Å–µ –∫–æ–Ω—Ñ–∏–≥–∏ –∏–∑ –ø–∞–ø–∫–∏
            kubectl apply -f ~/app-deploy/k8s/
            
            # –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º Deployment, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –Ω–æ–≤—ã–µ –æ–±—Ä–∞–∑—ã :latest
            kubectl rollout restart deployment/backend
            kubectl rollout restart deployment/frontend
            
            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            kubectl get pods

## –ß–∞—Å—Ç—å 4: –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –ø–µ—Ä–µ–¥ –ø–µ—Ä–≤—ã–º –∑–∞–ø—É—Å–∫–æ–º

–ß—Ç–æ–±—ã –ø–∞–π–ø–ª–∞–π–Ω –∑–∞—Ä–∞–±–æ—Ç–∞–ª, –≤–∞–º –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–µ–∫—Ä–µ—Ç—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ GitHub.

    –ó–∞–π–¥–∏—Ç–µ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –Ω–∞ GitHub: Settings -> Secrets and variables -> Actions -> New repository secret.

    –î–æ–±–∞–≤—å—Ç–µ 3 —Å–µ–∫—Ä–µ—Ç–∞:

        SSH_HOST: IP-–∞–¥—Ä–µ—Å –≤–∞—à–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 172.31.27.52 –∏–ª–∏ –ø—É–±–ª–∏—á–Ω—ã–π IP).

        SSH_USER: –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–æ–±—ã—á–Ω–æ ubuntu –∏–ª–∏ root).

        SSH_PRIVATE_KEY: –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤–∞—à–µ–≥–æ .pem —Ñ–∞–π–ª–∞ (–ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞).

    –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–û–î–ò–ù –†–ê–ó): –ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ SSH –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–∫—Ä–µ—Ç–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ GHCR (–µ—Å–ª–∏ –≤—ã –µ—â–µ —ç—Ç–æ–≥–æ –Ω–µ –¥–µ–ª–∞–ª–∏): –í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–∞—à GitHub PAT —Ç–æ–∫–µ–Ω (Classic) —Å –ø—Ä–∞–≤–∞–º–∏ read:packages.
    Bash

    kubectl create secret docker-registry ghcr-secret \
      --docker-server=ghcr.io \
      --docker-username=–í–ê–®_GITHUB_LOGIN \
      --docker-password=–í–ê–®_PAT_TOKEN \
      --docker-email=–í–ê–®_EMAIL

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤—ã —Å–¥–µ–ª–∞–µ—Ç–µ git push origin main, GitHub Actions –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–±–µ—Ä–µ—Ç –ø—Ä–æ–µ–∫—Ç –∏ –æ–±–Ω–æ–≤–∏—Ç –µ–≥–æ –Ω–∞ –≤–∞—à–µ–º —Å–µ—Ä–≤–µ—Ä–µ.

–î–æ–±–∞–≤—å postgres c –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–µ–∑–µ—Ä–≤–Ω—ã–º –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ–º

–û—Ç–ª–∏—á–Ω–∞—è –∏–¥–µ—è. –î–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤ Kubernetes –º—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:

    StatefulSet: –í –æ—Ç–ª–∏—á–∏–µ –æ—Ç Deployment, –æ–Ω –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ —É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –≤—Å–µ–≥–¥–∞ –±—É–¥–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ–µ —Å–µ—Ç–µ–≤–æ–µ –∏–º—è –∏ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ, –∫–æ—Ç–æ—Ä–æ–µ –Ω–µ –ø–æ—Ç–µ—Ä—è–µ—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –ø–æ–¥–∞.

    CronJob –¥–ª—è –±—ç–∫–∞–ø–æ–≤: –≠—Ç–æ –∑–∞–¥–∞—á–∞, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –ø–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—é (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–∞–∂–¥—É—é –Ω–æ—á—å), –¥–µ–ª–∞—Ç—å –¥–∞–º–ø –±–∞–∑—ã (pg_dump) –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ–≥–æ –≤ –æ–±–ª–∞—á–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ (AWS S3), —Ç–∞–∫ –∫–∞–∫ —Ö—Ä–∞–Ω–∏—Ç—å –±—ç–∫–∞–ø—ã –Ω–∞ —Ç–æ–º –∂–µ —Å–µ—Ä–≤–µ—Ä–µ, –≥–¥–µ –∏ –±–∞–∑–∞ ‚Äî –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ.

–í–∞–º –ø–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –±–∞–∫–µ—Ç –≤ S3 (AWS) –∏ –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ –Ω–µ–º—É.

–í–æ—Ç –Ω–æ–≤—ã–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã.
1. –û–±–Ω–æ–≤–∏—Ç–µ k8s/01-environment.yaml

–î–æ–±–∞–≤–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö –∏ –∫–ª—é—á–∏ AWS –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±—ç–∫–∞–ø–æ–≤.
YAML

apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  CORS_ORIGINS: "https://qwestor.general.singularitynet.dev,http://localhost:3000"
  LOG_LEVEL: "info"
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ë–î
  POSTGRES_HOST: "postgres" # –ò–º—è —Å–µ—Ä–≤–∏—Å–∞ –≤ Kubernetes
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "app_db"
  POSTGRES_USER: "app_user"
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ë—ç–∫–∞–ø–æ–≤
  S3_BUCKET_NAME: "my-db-backups" # <-- –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∫–µ—Ç –≤ AWS S3
  AWS_REGION: "us-east-1"

---
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
type: Opaque
stringData:
  OPENAI_API_KEY: "sk-..."
  # –°–µ–∫—Ä–µ—Ç—ã –ë–î
  POSTGRES_PASSWORD: "super_secure_password" # <-- –ü—Ä–∏–¥—É–º–∞–π—Ç–µ –ø–∞—Ä–æ–ª—å
  # –°–µ–∫—Ä–µ—Ç—ã AWS –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –±—ç–∫–∞–ø–æ–≤ (–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å –ø—Ä–∞–≤–∞–º–∏ S3 write)
  AWS_ACCESS_KEY_ID: "AKIA..."
  AWS_SECRET_ACCESS_KEY: "secret..."

2. –°–æ–∑–¥–∞–π—Ç–µ k8s/05-postgres.yaml

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Ä–∞–∑–≤–µ—Ä–Ω–µ—Ç —Å–∞–º—É –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
YAML

apiVersion: v1
kind: Service
metadata:
  name: postgres
spec:
  ports:
    - port: 5432
  selector:
    app: postgres
  clusterIP: None # Headless service –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ DNS

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  serviceName: "postgres"
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_DB
            - name: POSTGRES_USER
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: POSTGRES_PASSWORD
            # –ü–∞–ø–∫–∞ –¥–ª—è –¥–∞–Ω–Ω—ã—Ö –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
          volumeMounts:
            - name: postgres-storage
              mountPath: /var/lib/postgresql/data
  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Å–∫–∞ (PVC) –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∞
  volumeClaimTemplates:
    - metadata:
        name: postgres-storage
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 10Gi

3. –°–æ–∑–¥–∞–π—Ç–µ k8s/06-backup-cronjob.yaml

–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∫–∞–∂–¥—É—é –Ω–æ—á—å –≤ 03:00, –¥–µ–ª–∞—Ç—å —Å–∂–∞—Ç—ã–π –¥–∞–º–ø –∏ –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –µ–≥–æ –≤ AWS S3. –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–µ–≥–∫–∏–π –æ–±—Ä–∞–∑ postgres:15-alpine –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º aws-cli –ø—Ä—è–º–æ –ø–µ—Ä–µ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ–º.
YAML

apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
spec:
  schedule: "0 3 * * *" # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00 —É—Ç—Ä–∞
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup
              image: postgres:15-alpine
              envFrom:
                - configMapRef:
                    name: app-config
                - secretRef:
                    name: app-secrets
              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting backup..."
                  # 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º AWS CLI –∏ python3 (–Ω—É–∂–µ–Ω –¥–ª—è aws cli)
                  apk add --no-cache aws-cli
                  
                  # 2. –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –¥–∞—Ç–æ–π
                  DATE=$(date +%Y-%m-%d_%H-%M-%S)
                  FILE_NAME="backup_$DATE.sql.gz"
                  
                  # 3. –î–µ–ª–∞–µ–º –¥–∞–º–ø, —Å–∂–∏–º–∞–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ S3
                  # PGPASSWORD –±–µ—Ä–µ—Ç—Å—è –∏–∑ env, –∫–æ—Ç–æ—Ä—ã–π –º—ã –∑–∞–≥—Ä—É–∑–∏–ª–∏ –∏–∑ secrets
                  PGPASSWORD=$POSTGRES_PASSWORD pg_dump -h postgres -U $POSTGRES_USER $POSTGRES_DB | gzip > /tmp/$FILE_NAME
                  
                  echo "Uploading to S3..."
                  aws s3 cp /tmp/$FILE_NAME s3://$S3_BUCKET_NAME/$FILE_NAME
                  
                  echo "Backup $FILE_NAME uploaded successfully."
          restartPolicy: OnFailure

4. –û–±–Ω–æ–≤–∏—Ç–µ k8s/02-backend.yaml

–¢–µ–ø–µ—Ä—å –Ω—É–∂–Ω–æ —Å–æ–æ–±—â–∏—Ç—å –≤–∞—à–µ–º—É FastAPI, –≥–¥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö.
YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  # ... (–≤–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π)
  template:
    spec:
      # ...
      containers:
        - name: backend
          image: ghcr.io/<GITHUB_USER>/<REPO_NAME>/backend:latest
          # ...
          env:
            # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é DATABASE_URL
            - name: DATABASE_URL
              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(POSTGRES_HOST):$(POSTGRES_PORT)/$(POSTGRES_DB)"
            # –ü–æ–¥–≥—Ä—É–∂–∞–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (USER, PASS –∏ —Ç.–¥.) –¥–ª—è –ø–æ–¥—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤—ã—à–µ
            - name: POSTGRES_USER
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_HOST
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_HOST
            - name: POSTGRES_PORT
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_PORT
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_DB
          envFrom:
            - configMapRef:
                name: app-config
            - secretRef:
                name: app-secrets
          # ...

–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

    –ù–∞—Å—Ç—Ä–æ–π—Ç–µ S3: –°–æ–∑–¥–∞–π—Ç–µ –±–∞–∫–µ—Ç –≤ AWS (–Ω–∞–ø—Ä–∏–º–µ—Ä, my-app-backups) –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è IAM —Å –ø—Ä–∞–≤–∞–º–∏ –∑–∞–ø–∏—Å–∏ –≤ —ç—Ç–æ—Ç –±–∞–∫–µ—Ç. –ü–æ–ª—É—á–∏—Ç–µ Access Key –∏ Secret Key.

    –û–±–Ω–æ–≤–∏—Ç–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π: –°–¥–µ–ª–∞–π—Ç–µ git push –Ω–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤.

    Deploy: GitHub Actions —Å–∞–º —Å–∫–æ–ø–∏—Ä—É–µ—Ç –Ω–æ–≤—ã–µ —Ñ–∞–π–ª—ã. –ù–æ –µ—Å–ª–∏ –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ –∂–¥–∞—Ç—å, –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

Bash

# –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥–∏ –∏ —Å–µ–∫—Ä–µ—Ç—ã
kubectl apply -f k8s/01-environment.yaml

# –ó–∞–ø—É—Å–∫–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
kubectl apply -f k8s/05-postgres.yaml

# –ó–∞–ø—É—Å–∫–∞–µ–º –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –±—ç–∫–∞–ø–æ–≤
kubectl apply -f k8s/06-backup-cronjob.yaml

# –û–±–Ω–æ–≤–ª—è–µ–º –±—ç–∫–µ–Ω–¥ (—á—Ç–æ–±—ã –æ–Ω —É–≤–∏–¥–µ–ª –Ω–æ–≤—ã–µ ENV)
kubectl apply -f k8s/02-backend.yaml

–ü—Ä–æ–≤–µ—Ä–∫–∞:

    –ë–∞–∑–∞ –∑–∞–ø—É—â–µ–Ω–∞: kubectl get pods (—É–≤–∏–¥–∏—Ç–µ postgres-0).

    –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –±—ç–∫–∞–ø–∞ (–Ω–µ –¥–æ–∂–∏–¥–∞—è—Å—å –Ω–æ—á–∏):
    Bash

    kubectl create job --from=cronjob/postgres-backup manual-backup-test
    kubectl logs -f job/manual-backup-test

    –ï—Å–ª–∏ –≤ –ª–æ–≥–∞—Ö –±—É–¥–µ—Ç Backup ... uploaded successfully, –∑–Ω–∞—á–∏—Ç —Å–≤—è–∑—å —Å S3 —Ä–∞–±–æ—Ç–∞–µ—Ç.

–ü–æ–º–µ–Ω—è–π s3 –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

–ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –±—ç–∫–∞–ø–æ–≤ ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ –∏ —ç–∫–æ–Ω–æ–º–∏—Ç –¥–µ–Ω—å–≥–∏, –Ω–æ –ø–æ–º–Ω–∏—Ç–µ –æ —Ä–∏—Å–∫–µ: –µ—Å–ª–∏ —Å–≥–æ—Ä–∏—Ç –¥–∏—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞, –≤—ã –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –∏ –±–∞–∑—É, –∏ –±—ç–∫–∞–ø—ã.

–ß—Ç–æ–±—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —ç—Ç–æ –≤ Kubernetes, –Ω–∞–º –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π Persistent Volume Claim (PVC) —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –±—ç–∫–∞–ø–æ–≤ –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –µ–≥–æ –∫ –Ω–∞—à–µ–º—É CronJob.

–í–æ—Ç –∏–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã.
1. –°–æ–∑–¥–∞–π—Ç–µ k8s/07-backup-storage.yaml (–ù–æ–≤—ã–π —Ñ–∞–π–ª)

–ù–∞–º –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –¥–∏—Å–∫, –∫—É–¥–∞ –±—É–¥—É—Ç —Å–∫–ª–∞–¥—ã–≤–∞—Ç—å—Å—è –∞—Ä—Ö–∏–≤—ã.
YAML

apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-pvc
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 20Gi # –†–∞–∑–º–µ—Ä –¥–∏—Å–∫–∞ –ø–æ–¥ –±—ç–∫–∞–ø—ã

2. –û–±–Ω–æ–≤–∏—Ç–µ k8s/06-backup-cronjob.yaml

–ú—ã —É–±–∏—Ä–∞–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É aws-cli –∏ –ª–æ–≥–∏–∫—É S3. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –º—ã –º–æ–Ω—Ç–∏—Ä—É–µ–º –¥–∏—Å–∫ backup-pvc –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª—ã —Ç—É–¥–∞.

–í–∞–∂–Ω–æ–µ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ: –Ø –¥–æ–±–∞–≤–∏–ª –∫–æ–º–∞–Ω–¥—É find ... -delete, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è—Ç—å –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π. –ò–Ω–∞—á–µ –≤–∞—à –¥–∏—Å–∫ –ø–µ—Ä–µ–ø–æ–ª–Ω–∏—Ç—Å—è.
YAML

apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
spec:
  schedule: "0 3 * * *" # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup
              image: postgres:15-alpine
              envFrom:
                - configMapRef:
                    name: app-config
                - secretRef:
                    name: app-secrets
              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting local backup..."
                  
                  # 1. –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞
                  DATE=$(date +%Y-%m-%d_%H-%M-%S)
                  FILE_PATH="/backups/backup_$DATE.sql.gz"
                  
                  # 2. –î–µ–ª–∞–µ–º –¥–∞–º–ø –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–∏—Å–∫
                  PGPASSWORD=$POSTGRES_PASSWORD pg_dump -h postgres -U $POSTGRES_USER $POSTGRES_DB | gzip > $FILE_PATH
                  
                  echo "Backup saved to $FILE_PATH"
                  
                  # 3. –û–ß–ò–°–¢–ö–ê: –£–¥–∞–ª—è–µ–º —Ñ–∞–π–ª—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
                  echo "Cleaning up old backups..."
                  find /backups -name "backup_*.sql.gz" -mtime +7 -delete
                  
                  echo "Done."
              volumeMounts:
                - name: backup-storage
                  mountPath: /backups # –ú–æ–Ω—Ç–∏—Ä—É–µ–º –¥–∏—Å–∫ –≤ —ç—Ç—É –ø–∞–ø–∫—É
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: backup-pvc # –°—Å—ã–ª–∫–∞ –Ω–∞ –Ω–∞—à –Ω–æ–≤—ã–π PVC
          restartPolicy: OnFailure

3. –û—á–∏—Å—Ç–∏—Ç–µ k8s/01-environment.yaml

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å –ª–∏—à–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å AWS.
YAML

apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  CORS_ORIGINS: "https://qwestor.general.singularitynet.dev,http://localhost:3000"
  LOG_LEVEL: "info"
  POSTGRES_HOST: "postgres"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "app_db"
  POSTGRES_USER: "app_user"
  # S3_BUCKET_NAME –∏ AWS_REGION –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã

---
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
type: Opaque
stringData:
  OPENAI_API_KEY: "sk-..."
  POSTGRES_PASSWORD: "super_secure_password"
  # AWS –∫–ª—é—á–∏ –±–æ–ª—å—à–µ –Ω–µ –Ω—É–∂–Ω—ã

–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è

    –£–¥–∞–ª–∏—Ç–µ —Å—Ç–∞—Ä—ã–π CronJob (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ–±–Ω–æ–≤–∏–ª–∏—Å—å —á–∏—Å—Ç–æ):
    Bash

kubectl delete cronjob postgres-backup

–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –Ω–æ–≤—ã–µ –∫–æ–Ω—Ñ–∏–≥–∏:
Bash

    kubectl apply -f k8s/01-environment.yaml
    kubectl apply -f k8s/07-backup-storage.yaml
    kubectl apply -f k8s/06-backup-cronjob.yaml

–ö–∞–∫ —Å–∫–∞—á–∞—Ç—å –±—ç–∫–∞–ø –Ω–∞ —Å–≤–æ–π –∫–æ–º–ø—å—é—Ç–µ—Ä?

–¢–∞–∫ –∫–∞–∫ —Ñ–∞–π–ª—ã —Ç–µ–ø–µ—Ä—å –ª–µ–∂–∞—Ç –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ K3s, —á—Ç–æ–±—ã –¥–æ—Å—Ç–∞—Ç—å –∏—Ö, –≤–∞–º –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —Å–ª–µ–¥—É—é—â–µ–µ:

    –ó–∞–ø—É—Å—Ç–∏—Ç–µ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ø–æ–¥, –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–π –∫ –¥–∏—Å–∫—É –±—ç–∫–∞–ø–æ–≤: –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª debug-backup.yaml:
    YAML

apiVersion: v1
kind: Pod
metadata:
  name: backup-access
spec:
  containers:
    - name: alpine
      image: alpine
      command: ["sleep", "3600"]
      volumeMounts:
        - mountPath: /backups
          name: backup-storage
  volumes:
    - name: backup-storage
      persistentVolumeClaim:
        claimName: backup-pvc

Bash

kubectl apply -f debug-backup.yaml

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ñ–∞–π–ª—ã: –ö–æ–≥–¥–∞ –≤–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è —Ñ–∞–π–ª, –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–≤–æ–µ–º –∫–æ–º–ø—å—é—Ç–µ—Ä–µ:
Bash

    # –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
    kubectl exec -it backup-access -- ls -lh /backups

    # –°–∫–∞—á–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π —Ñ–∞–π–ª
    kubectl cp backup-access:/backups/backup_2023-10-31_03-00-00.sql.gz ./my_local_backup.sql.gz

–°–æ–±–µ—Ä–∏ –∑–∞–Ω–æ–≥–æ –≤–æ–µ–¥–∏–Ω–æ –≤–µ—Å—å –∫–æ–Ω—Ñ–∏–≥

–ö–æ–Ω–µ—á–Ω–æ. –í–æ—Ç –ø–æ–ª–Ω–∞—è, —Å–æ–±—Ä–∞–Ω–Ω–∞—è –≤–æ–µ–¥–∏–Ω–æ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞. –≠—Ç–æ "Production-ready" –Ω–∞–±–æ—Ä –¥–ª—è –¥–µ–ø–ª–æ—è –≤ K3s —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º GitHub Registry, PostgreSQL, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –±—ç–∫–∞–ø–æ–≤ –∏ Nginx Ingress.
## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ–∞–π–ª—ã –ª–µ–∂–∞—Ç –∏–º–µ–Ω–Ω–æ —Ç–∞–∫:
Plaintext

.
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îî‚îÄ‚îÄ ... (–∫–æ–¥ Python)
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf   # –ö–æ–Ω—Ñ–∏–≥ –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ ... (–∫–æ–¥ React)
‚îú‚îÄ‚îÄ k8s/
‚îÇ   ‚îú‚îÄ‚îÄ 01-environment.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 02-storage.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 03-postgres.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 04-backup-cronjob.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 05-backend.yaml
‚îÇ   ‚îú‚îÄ‚îÄ 06-frontend.yaml
‚îÇ   ‚îî‚îÄ‚îÄ 07-ingress.yaml
‚îî‚îÄ‚îÄ .github/
    ‚îî‚îÄ‚îÄ workflows/
        ‚îî‚îÄ‚îÄ deploy.yml

## 1. Dockerfiles
backend/Dockerfile
Dockerfile

FROM python:3.9-slim

WORKDIR /app

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
COPY . .

# –ó–∞–ø—É—Å–∫
CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]

frontend/Dockerfile (Multi-stage build)
Dockerfile

# 1. –°–±–æ—Ä–∫–∞ React
FROM node:18-alpine AS builder
WORKDIR /app
COPY package*.json ./
RUN npm install
COPY . .
RUN npm run build

# 2. –°–µ—Ä–≤–µ—Ä Nginx –¥–ª—è —Ä–∞–∑–¥–∞—á–∏ —Å—Ç–∞—Ç–∏–∫–∏
FROM nginx:1.25-alpine
COPY --from=builder /app/build /usr/share/nginx/html
# –ö–æ–ø–∏—Ä—É–µ–º –Ω–∞—à –∫–æ–Ω—Ñ–∏–≥ –¥–ª—è SPA (—Å–º. –Ω–∏–∂–µ)
COPY nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

frontend/nginx.conf (–î–ª—è —Ä–æ—É—Ç–∏–Ω–≥–∞ React –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
Nginx

server {
    listen 80;
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
}

## 2. Kubernetes Manifests (k8s/)
k8s/01-environment.yaml
YAML

apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
data:
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  CORS_ORIGINS: "https://qwestor.general.singularitynet.dev,http://localhost:3000"
  LOG_LEVEL: "info"
  # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
  POSTGRES_HOST: "postgres"
  POSTGRES_PORT: "5432"
  POSTGRES_DB: "app_db"
  POSTGRES_USER: "app_user"

---
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
type: Opaque
stringData:
  # –í–ê–®–ò –°–ï–ö–†–ï–¢–´
  OPENAI_API_KEY: "sk-..."
  POSTGRES_PASSWORD: "super_secure_password"

k8s/02-storage.yaml (–î–∏—Å–∫–∏ –¥–ª—è –±—ç–∫–µ–Ω–¥–∞ –∏ –±—ç–∫–∞–ø–æ–≤)
YAML

# –î–∏—Å–∫ –¥–ª—è —Ñ–∞–π–ª–æ–≤ –±—ç–∫–µ–Ω–¥–∞ (–µ—Å–ª–∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç–µ —Ñ–∞–π–ª—ã)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backend-pvc
spec:
  accessModes: [ "ReadWriteOnce" ]
  resources:
    requests:
      storage: 5Gi

---
# –î–∏—Å–∫ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –±—ç–∫–∞–ø–æ–≤ –ë–î
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: backup-pvc
spec:
  accessModes: [ "ReadWriteOnce" ]
  resources:
    requests:
      storage: 20Gi

k8s/03-postgres.yaml (–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö)
YAML

apiVersion: v1
kind: Service
metadata:
  name: postgres
spec:
  ports:
    - port: 5432
  selector:
    app: postgres
  clusterIP: None

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgres
spec:
  serviceName: "postgres"
  replicas: 1
  selector:
    matchLabels:
      app: postgres
  template:
    metadata:
      labels:
        app: postgres
    spec:
      containers:
        - name: postgres
          image: postgres:15-alpine
          ports:
            - containerPort: 5432
          env:
            - name: POSTGRES_DB
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_DB
            - name: POSTGRES_USER
              valueFrom:
                configMapKeyRef:
                  name: app-config
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: app-secrets
                  key: POSTGRES_PASSWORD
            - name: PGDATA
              value: /var/lib/postgresql/data/pgdata
          volumeMounts:
            - name: postgres-data
              mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
    - metadata:
        name: postgres-data
      spec:
        accessModes: [ "ReadWriteOnce" ]
        resources:
          requests:
            storage: 10Gi

k8s/04-backup-cronjob.yaml (–õ–æ–∫–∞–ª—å–Ω—ã–µ –±—ç–∫–∞–ø—ã)
YAML

apiVersion: batch/v1
kind: CronJob
metadata:
  name: postgres-backup
spec:
  schedule: "0 3 * * *" # –ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 3:00
  jobTemplate:
    spec:
      template:
        spec:
          containers:
            - name: backup
              image: postgres:15-alpine
              envFrom:
                - configMapRef:
                    name: app-config
                - secretRef:
                    name: app-secrets
              command:
                - /bin/sh
                - -c
                - |
                  echo "Starting local backup..."
                  DATE=$(date +%Y-%m-%d_%H-%M-%S)
                  FILE_PATH="/backups/backup_$DATE.sql.gz"
                  
                  # –î–∞–º–ø –ë–î
                  PGPASSWORD=$POSTGRES_PASSWORD pg_dump -h postgres -U $POSTGRES_USER $POSTGRES_DB | gzip > $FILE_PATH
                  echo "Saved to $FILE_PATH"
                  
                  # –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö (—Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π)
                  find /backups -name "backup_*.sql.gz" -mtime +7 -delete
              volumeMounts:
                - name: backup-storage
                  mountPath: /backups
          volumes:
            - name: backup-storage
              persistentVolumeClaim:
                claimName: backup-pvc
          restartPolicy: OnFailure

k8s/05-backend.yaml
YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: backend
          # –ó–ê–ú–ï–ù–ò–¢–ï <USER>/<REPO> (–Ω–∏–∂–Ω–∏–π —Ä–µ–≥–∏—Å—Ç—Ä)
          image: ghcr.io/<USER>/<REPO>/backend:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8000
          env:
            - name: DATABASE_URL
              value: "postgresql://$(POSTGRES_USER):$(POSTGRES_PASSWORD)@$(POSTGRES_HOST):$(POSTGRES_PORT)/$(POSTGRES_DB)"
          envFrom:
            - configMapRef:
                name: app-config
            - secretRef:
                name: app-secrets
          volumeMounts:
            - mountPath: /app/storage_data
              name: storage
      volumes:
        - name: storage
          persistentVolumeClaim:
            claimName: backend-pvc
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
spec:
  selector:
    app: backend
  ports:
    - protocol: TCP
      port: 8000
      targetPort: 8000

k8s/06-frontend.yaml
YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: frontend
          # –ó–ê–ú–ï–ù–ò–¢–ï <USER>/<REPO>
          image: ghcr.io/<USER>/<REPO>/frontend:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 80
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
spec:
  selector:
    app: frontend
  ports:
    - protocol: TCP
      port: 80
      targetPort: 80

k8s/07-ingress.yaml (HTTPS, WS –∏ API)
YAML

apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: your-email@example.com # –ó–ê–ú–ï–ù–ò–¢–ï EMAIL
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
      - http01:
          ingress:
            class: nginx
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è WebSocket
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    
    # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–≤–æ–π–Ω—ã—Ö —Å–ª—ç—à–µ–π (/ws//notifications -> /ws/notifications)
    # Rewrite: –£–±–∏—Ä–∞–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å /ws/ –∏–ª–∏ /api/ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.
    # –í –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ, –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º regex, —á—Ç–æ–±—ã –ø–µ—Ä–µ–¥–∞—Ç—å –ø—É—Ç—å —á–∏—Å—Ç–æ.
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$1

spec:
  tls:
    - hosts:
        - qwestor.general.singularitynet.dev
      secretName: app-tls-secret
  rules:
    - host: qwestor.general.singularitynet.dev
      http:
        paths:
          # API: /api/users -> –±—ç–∫–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç /users
          - path: /api/?(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          
          # WebSocket: /ws/notifications -> –±—ç–∫–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç /notifications
          - path: /ws/?(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          
          # –§—Ä–æ–Ω—Ç–µ–Ω–¥: –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ
          - path: /(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: frontend-service
                port:
                  number: 80

## 3. GitHub Actions (.github/workflows/deploy.yml)

–≠—Ç–æ—Ç —Ñ–∞–π–ª —Å–æ–±–∏—Ä–∞–µ—Ç Docker-–æ–±—Ä–∞–∑—ã –∏ –¥–µ–ø–ª–æ–∏—Ç –∏—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
YAML

name: Build and Deploy

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Log in to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest

      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # –ö–æ–ø–∏—Ä—É–µ–º –∫–æ–Ω—Ñ–∏–≥–∏ k8s –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      - name: Copy k8s configs
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "k8s/*"
          target: "~/app-deploy"

      # –ü—Ä–∏–º–µ–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥–∏ –ø–æ SSH
      - name: Apply K8s
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã
            kubectl apply -f ~/app-deploy/k8s/
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥—ã –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞
            kubectl rollout restart deployment/backend
            kubectl rollout restart deployment/frontend

## –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤—Ä—É—á–Ω—É—é (–û–¥–∏–Ω —Ä–∞–∑)

    –ù–∞ —Å–µ—Ä–≤–µ—Ä–µ (K3s): –°–æ–∑–¥–∞–π—Ç–µ —Å–µ–∫—Ä–µ—Ç –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ GHCR (–∏—Å–ø–æ–ª—å–∑—É—è –≤–∞—à GitHub PAT):
    Bash

    kubectl create secret docker-registry ghcr-secret \
      --docker-server=ghcr.io \
      --docker-username=–í–ê–®_–õ–û–ì–ò–ù \
      --docker-password=–í–ê–®_–¢–û–ö–ï–ù_PAT \
      --docker-email=–í–ê–®_EMAIL

    –í GitHub Repository Secrets: –î–æ–±–∞–≤—å—Ç–µ 3 —Å–µ–∫—Ä–µ—Ç–∞ –¥–ª—è SSH:

        SSH_HOST

        SSH_USER

        SSH_PRIVATE_KEY

–ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ª—é–±–æ–π –ø—É—à –≤ main –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–∏—Ç –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

–ö–∞–∫–∏–µ –ø–æ—Ä—Ç—ã –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –µ—Å–ª–∏ —Å–Ω–∞—Ä—É–∂–∏ –µ—Å—Ç—å nginx –≤—Å–µ–π —Å–∏—Å—Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã–π –∑–∞–Ω–∏–º–∞–µ—Ç—Å—è —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏

–û—Ç–≤–µ—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–æ–≥–æ, —á—Ç–æ –≤—ã –ø–æ–¥—Ä–∞–∑—É–º–µ–≤–∞–µ—Ç–µ –ø–æ–¥ "–æ—Ç–∫—Ä—ã—Ç–∏–µ–º –ø–æ—Ä—Ç–æ–≤" ‚Äî –Ω–∞ —É—Ä–æ–≤–Ω–µ —Ñ–∞–µ—Ä–≤–æ–ª–∞ (AWS Security Group) –∏–ª–∏ –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Docker/K8s.

–ï—Å–ª–∏ –∫—Ä–∞—Ç–∫–æ: –î–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –º–∏—Ä–∞ (–∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞) –≤—ã –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –¢–û–õ–¨–ö–û –ø–æ—Ä—Ç—ã Nginx. –°–∞–º–æ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é (–±—ç–∫–µ–Ω–¥—É –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É) "—Ç–æ—Ä—á–∞—Ç—å" –Ω–∞—Ä—É–∂—É –Ω–µ –Ω—É–∂–Ω–æ –≤–æ–æ–±—â–µ.

–í–æ—Ç –ø–æ–¥—Ä–æ–±–Ω–∞—è —Å—Ö–µ–º–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏:
1. –ù–∞ —É—Ä–æ–≤–Ω–µ —Å–µ—Ä–≤–µ—Ä–∞ (AWS Security Group)

–≠—Ç–æ –≤–∞—à–∞ –≥–ª–∞–≤–Ω–∞—è —Å—Ç–µ–Ω–∞ –∑–∞—â–∏—Ç—ã. –ó–¥–µ—Å—å –≤—ã —Ä–∞–∑—Ä–µ—à–∞–µ—Ç–µ —Ç—Ä–∞—Ñ–∏–∫ –∏–∑ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –∫ –≤–∞—à–µ–º—É —Å–µ—Ä–≤–µ—Ä—É (EC2).

–í–∞–º –Ω—É–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ç–æ–ª—å–∫–æ 3 –ø–æ—Ä—Ç–∞:
–ü–æ—Ä—Ç	–ü—Ä–æ—Ç–æ–∫–æ–ª	–ò—Å—Ç–æ—á–Ω–∏–∫ (Source)	–ó–∞—á–µ–º –Ω—É–∂–µ–Ω
80	TCP	0.0.0.0/0 (–í–µ—Å—å –º–∏—Ä)	–ß—Ç–æ–±—ã –ø—Ä–∏–Ω—è—Ç—å HTTP –∑–∞–ø—Ä–æ—Å (–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –µ–≥–æ –Ω–∞ HTTPS). –ù—É–∂–µ–Ω –¥–ª—è Let's Encrypt.
443	TCP	0.0.0.0/0 (–í–µ—Å—å –º–∏—Ä)	–û—Å–Ω–æ–≤–Ω–æ–π –ø–æ—Ä—Ç –¥–ª—è –∑–∞—â–∏—â–µ–Ω–Ω–æ–≥–æ —Ç—Ä–∞—Ñ–∏–∫–∞ (HTTPS / WSS).
22	TCP	–í–∞—à–µ IP (–∏–ª–∏ 0.0.0.0/0)	SSH –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–æ–º.

‚õî –ß–µ–≥–æ –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –ù–ï–õ–¨–ó–Ø:

    8000 (–ü–æ—Ä—Ç –±—ç–∫–µ–Ω–¥–∞) ‚Äî –ù–µ –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ. –ó–ª–æ—É–º—ã—à–ª–µ–Ω–Ω–∏–∫–∏ —Å–º–æ–≥—É—Ç —Å–ª–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –∫ API –≤ –æ–±—Ö–æ–¥ Nginx (–≤ –æ–±—Ö–æ–¥ HTTPS –∏ –ø—Ä–∞–≤–∏–ª –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏).

    5432 (Postgres) ‚Äî –ö–∞—Ç–µ–≥–æ—Ä–∏—á–µ—Å–∫–∏ –Ω–µ–ª—å–∑—è –æ—Ç–∫—Ä—ã–≤–∞—Ç—å –Ω–∞—Ä—É–∂—É. –≠—Ç–æ –¥—ã—Ä–∞ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

    3000 (Frontend container) ‚Äî –ù–µ –Ω—É–∂–Ω–æ, —Ç–∞–∫ –∫–∞–∫ Nginx –æ—Ç–¥–∞–µ—Ç —Å—Ç–∞—Ç–∏–∫—É —á–µ—Ä–µ–∑ 443.

2. –í–Ω—É—Ç—Ä–∏ Docker Compose (–∏–ª–∏ K8s)

–ó–¥–µ—Å—å –ª–æ–≥–∏–∫–∞ –º–µ–Ω—è–µ—Ç—Å—è. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è Nginx, –Ω–æ –Ω–µ –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ –º–∏—Ä–∞.
–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Docker Compose:

–í–∞—à docker-compose.yml –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:
YAML

services:
  # 1. Nginx - –ï–î–ò–ù–°–¢–í–ï–ù–ù–´–ô, –∫—Ç–æ –∏–º–µ–µ—Ç –ø–æ—Ä—Ç—ã –Ω–∞—Ä—É–∂—É
  nginx:
    ports:
      - "80:80"   # –°–≤—è–∑—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç 80 —Å–µ—Ä–≤–µ—Ä–∞ —Å –ø–æ—Ä—Ç–æ–º 80 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
      - "443:443" # –°–≤—è–∑—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç 443 —Å–µ—Ä–≤–µ—Ä–∞ —Å –ø–æ—Ä—Ç–æ–º 443 –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    networks:
      - app-network

  # 2. Backend - –°–∫—Ä—ã—Ç –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –º–∏—Ä–∞
  backend:
    # ports:        <-- –£–î–ê–õ–ò–¢–ï –≠–¢–£ –°–ï–ö–¶–ò–Æ!
    #   - "8000:8000"
    expose:         # <-- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ EXPOSE. –≠—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç –¢–û–õ–¨–ö–û –≤–Ω—É—Ç—Ä–∏ —Å–µ—Ç–∏ Docker
      - "8000"
    networks:
      - app-network

  # 3. Frontend - –°–∫—Ä—ã—Ç
  frontend:
    # ports:        <-- –£–î–ê–õ–ò–¢–ï
    #   - "3000:3000"
    expose:
      - "80"
    networks:
      - app-network

–ü–æ—á–µ–º—É —Ç–∞–∫? Nginx –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –æ–¥–Ω–æ–π —Å–µ—Ç–∏ app-network —Å –±—ç–∫–µ–Ω–¥–æ–º. –í —Å–≤–æ–µ–º –∫–æ–Ω—Ñ–∏–≥–µ (nginx.conf) –æ–Ω –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ –±—ç–∫–µ–Ω–¥—É –∫–∞–∫ http://backend:8000. –≠—Ç–æ—Ç —Ç—Ä–∞—Ñ–∏–∫ –∏–¥–µ—Ç –≤–Ω—É—Ç—Ä–∏ Docker, –Ω–µ –≤—ã—Ö–æ–¥—è –Ω–∞ —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–µ—Ä–≤–µ—Ä–∞. –°–Ω–∞—Ä—É–∂–∏ –¥–æ—Å—Ç—É—á–∞—Ç—å—Å—è –¥–æ –ø–æ—Ä—Ç–∞ 8000 –±—É–¥–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ.
–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ Kubernetes (K3s):

–õ–æ–≥–∏–∫–∞ —Ç–∞ –∂–µ, —Ä–µ–∞–ª–∏–∑—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ —Ç–∏–ø—ã —Å–µ—Ä–≤–∏—Å–æ–≤ (Service Types).

    Ingress Controller (Nginx): –ò—Å–ø–æ–ª—å–∑—É–µ—Ç LoadBalancer (–∏–ª–∏ HostPort 80/443), —á—Ç–æ–±—ã –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –∏–∑–≤–Ω–µ.

    Backend Service: –î–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ç–∏–ø–∞ ClusterIP.
    YAML

    apiVersion: v1
    kind: Service
    spec:
      type: ClusterIP  # <-- –û–∑–Ω–∞—á–∞–µ—Ç "–¥–æ—Å—Ç—É–ø–µ–Ω —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞"
      ports:
        - port: 8000

    Frontend Service: –¢–æ–∂–µ —Ç–∏–ø–∞ ClusterIP.

–ò—Ç–æ–≥

    –í AWS: –û—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ 80, 443 (–∏ 22 –¥–ª—è —Å–µ–±—è).

    –í Docker/K8s: –ë—ç–∫–µ–Ω–¥ –∏ –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –ø—É–±–ª–∏–∫—É—é—Ç –ø–æ—Ä—Ç—ã –Ω–∞—Ä—É–∂—É. –û–Ω–∏ –¥–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π —Å–µ—Ç–∏. –í–µ—Å—å –≤—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ –æ–±—è–∑–∞–Ω –ø—Ä–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Nginx.

–ü–µ—Ä–µ–¥–µ–ª–∞–π ingress –Ω–∞ —Ç–æ —á—Ç–æ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ –±—É–¥–µ—Ç –∑–∞–Ω–∏–º–∞—Ç—Å—è –¥—Ä—É–≥–æ–π —Ö–æ—Å—Ç

–≠—Ç–æ —á–∞—Å—Ç—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–≥–¥–∞ –ø–µ—Ä–µ–¥ –∫–ª–∞—Å—Ç–µ—Ä–æ–º —Å—Ç–æ–∏—Ç AWS ALB, CloudFlare –∏–ª–∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π Nginx).

–í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –≤–∞—à Kubernetes Ingress –¥–æ–ª–∂–µ–Ω —Ä–∞–±–æ—Ç–∞—Ç—å –ø–æ HTTP (–ø–æ—Ä—Ç 80), –ø—Ä–∏–Ω–∏–º–∞—Ç—å —É–∂–µ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç—Ä–∞—Ñ–∏–∫ –∏ –ø—Ä–æ—Å—Ç–æ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä–æ–≤–∞—Ç—å –µ–≥–æ –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º.

–í–æ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏—è:

    –£–±–∏—Ä–∞–µ–º cert-manager –∏ –±–ª–æ–∫ tls.

    –û—Ç–∫–ª—é—á–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ HTTPS –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ (—Ç–∞–∫ –∫–∞–∫ —Ç—Ä–∞—Ñ–∏–∫ –≤–Ω—É—Ç—Ä–∏ —É–∂–µ –∏–¥–µ—Ç –ø–æ HTTP).

    –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º Ingress —Ç–∞–∫, —á—Ç–æ–±—ã –æ–Ω –¥–æ–≤–µ—Ä—è–ª –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–∞.

1. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π k8s/07-ingress.yaml
YAML

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    
    # --- –û–¢–ö–õ–Æ–ß–ê–ï–ú SSL –í–ù–£–¢–†–ò ---
    # –ú—ã –≥–æ–≤–æ—Ä–∏–º: "–ù–µ –ø—ã—Ç–∞–π—Å—è –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å –Ω–∞ HTTPS, 
    # –ø–æ—Ç–æ–º—É —á—Ç–æ –∫ –Ω–∞–º —Ç—Ä–∞—Ñ–∏–∫ –ø—Ä–∏—Ö–æ–¥–∏—Ç —É–∂–µ –∫–∞–∫ HTTP".
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    
    # --- –ù–ê–°–¢–†–û–ô–ö–ò WEBSOCKET ---
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    
    # --- REWRITE (–ï—Å–ª–∏ –Ω—É–∂–Ω–æ —É–±–∏—Ä–∞—Ç—å –ø—Ä–µ—Ñ–∏–∫—Å—ã) ---
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$1

spec:
  # –ë–õ–û–ö TLS –£–î–ê–õ–ï–ù –ü–û–õ–ù–û–°–¢–¨–Æ
  
  rules:
    - host: qwestor.general.singularitynet.dev
      http:
        paths:
          # API
          - path: /api/?(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          
          # WebSocket
          - path: /ws/?(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          
          # Frontend
          - path: /(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: frontend-service
                port:
                  number: 80

2. –í–∞–∂–Ω—ã–π –Ω—é–∞–Ω—Å: –ó–∞–≥–æ–ª–æ–≤–∫–∏ (X-Forwarded-Proto)

–ü–æ—Å–∫–æ–ª—å–∫—É SSL —Å–Ω–∏–º–∞–µ—Ç—Å—è –Ω–∞ –¥—Ä—É–≥–æ–º —Ö–æ—Å—Ç–µ, –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (FastAPI) –∏ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π Nginx –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –≤—Ö–æ–¥—è—â–∏–π –∑–∞–ø—Ä–æ—Å –∫–∞–∫ HTTP.

–ò–∑-–∑–∞ —ç—Ç–æ–≥–æ –º–æ–≥—É—Ç –≤–æ–∑–Ω–∏–∫–Ω—É—Ç—å –ø—Ä–æ–±–ª–µ–º—ã:

    FastAPI –º–æ–∂–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å—Å—ã–ª–∫–∏ —Å http:// –≤–º–µ—Å—Ç–æ https://.

    WebSocket –º–æ–∂–µ—Ç —Ä—É–≥–∞—Ç—å—Å—è –Ω–∞ –Ω–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ö–µ–º.

–ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

    –ù–∞ –≤–Ω–µ—à–Ω–µ–º —Ö–æ—Å—Ç–µ (–∫–æ—Ç–æ—Ä—ã–π –¥–µ—Ä–∂–∏—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã): –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ X-Forwarded-Proto. –ï—Å–ª–∏ —ç—Ç–æ Nginx, —Ç–∞–º –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å:
    Nginx

proxy_set_header X-Forwarded-Proto $scheme; # –û–±—ã—á–Ω–æ —ç—Ç–æ https
proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
proxy_pass http://<IP-–í–ê–®–ï–ì–û-K3S-–°–ï–†–í–ï–†–ê>:80;

–í –≤–∞—à–µ–º FastAPI (backend): FastAPI –¥–æ–ª–∂–µ–Ω –¥–æ–≤–µ—Ä—è—Ç—å —ç—Ç–æ–º—É –∑–∞–≥–æ–ª–æ–≤–∫—É. –í–∞–º –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å ProxyHeadersMiddleware (–µ—Å–ª–∏ –µ–≥–æ –µ—â–µ –Ω–µ—Ç, Uvicorn —á–∞—Å—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ —Å–∞–º, –Ω–æ –ª—É—á—à–µ —è–≤–Ω–æ —É–∫–∞–∑–∞—Ç—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ).

–í backend/Dockerfile –æ–±–Ω–æ–≤–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∑–∞–ø—É—Å–∫–∞, –¥–æ–±–∞–≤–∏–≤ --proxy-headers –∏ --forwarded-allow-ips:
Dockerfile

    # –†–∞–∑—Ä–µ—à–∞–µ–º –¥–æ–≤–µ—Ä—è—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∞–º –æ—Ç –ª—é–±—ã—Ö –ø—Ä–æ–∫—Å–∏ (–∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ IP –≤–∞—à–µ–≥–æ Ingress)
    CMD ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000", "--proxy-headers", "--forwarded-allow-ips", "*"]

–ò—Ç–æ–≥

–¢–µ–ø–µ—Ä—å —Å—Ö–µ–º–∞ –≤—ã–≥–ª—è–¥–∏—Ç —Ç–∞–∫: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (HTTPS) -> –í–Ω–µ—à–Ω–∏–π –•–æ—Å—Ç (SSL Termination) -> HTTP (–ü–æ—Ä—Ç 80) -> –í–∞—à K3s Ingress -> –°–µ—Ä–≤–∏—Å—ã.

–¥–æ–±–∞–≤—å –≤ ingress —Ö–æ—Å—Ç localhost

–î–∞, –≤ Kubernetes Ingress —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Å–ø–æ—Å–æ–± –¥–æ–±–∞–≤–∏—Ç—å –≤—Ç–æ—Ä–æ–π —Ö–æ—Å—Ç ‚Äî —ç—Ç–æ —Å–æ–∑–¥–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø—Ä–∞–≤–∏–ª–æ rule –¥–ª—è –Ω–µ–≥–æ. –ü–æ—Å–∫–æ–ª—å–∫—É –º–∞—Ä—à—Ä—É—Ç—ã (paths) –æ–¥–∏–Ω–∞–∫–æ–≤—ã, –º—ã –ø—Ä–æ—Å—Ç–æ –¥—É–±–ª–∏—Ä—É–µ–º –±–ª–æ–∫ http –¥–ª—è —Ö–æ—Å—Ç–∞ localhost.

–í–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π k8s/07-ingress.yaml.
–ß—Ç–æ –∏–∑–º–µ–Ω–∏–ª–æ—Å—å:

–Ø –¥–æ–±–∞–≤–∏–ª —Å–µ–∫—Ü–∏—é - host: localhost –≤ —Å–∞–º–æ–º –Ω–∏–∑—É. –¢–µ–ø–µ—Ä—å Ingress –±—É–¥–µ—Ç –ø—Ä–∏–Ω–∏–º–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫, –µ—Å–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ Host —Ä–∞–≤–µ–Ω –ª–∏–±–æ –≤–∞—à–µ–º—É –¥–æ–º–µ–Ω—É, –ª–∏–±–æ localhost.
YAML

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  annotations:
    kubernetes.io/ingress.class: "nginx"
    
    # –û—Ç–∫–ª—é—á–∞–µ–º SSL-—Ä–µ–¥–∏—Ä–µ–∫—Ç (—Ç–∞–∫ –∫–∞–∫ SSL –Ω–∞ –≤–Ω–µ—à–Ω–µ–º –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–µ)
    nginx.ingress.kubernetes.io/ssl-redirect: "false"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "false"
    
    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ WebSocket
    nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-send-timeout: "3600"
    nginx.ingress.kubernetes.io/proxy-http-version: "1.1"
    
    # Rewrite
    nginx.ingress.kubernetes.io/use-regex: "true"
    nginx.ingress.kubernetes.io/rewrite-target: /$1

spec:
  rules:
    # === –ü–†–ê–í–ò–õ–û 1: –í–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π –¥–æ–º–µ–Ω ===
    - host: qwestor.general.singularitynet.dev
      http:
        paths:
          # API
          - path: /api/?(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          # WebSocket
          - path: /ws/?(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          # Frontend
          - path: /(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: frontend-service
                port:
                  number: 80

    # === –ü–†–ê–í–ò–õ–û 2: Localhost (–¥–ª—è —Ç–µ—Å—Ç–æ–≤) ===
    - host: localhost
      http:
        paths:
          # –¢–µ –∂–µ —Å–∞–º—ã–µ –ø—É—Ç–∏, –¥—É–±–ª–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É
          - path: /api/?(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          - path: /ws/?(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          - path: /(.*)
            pathType: ImplementationSpecific
            backend:
              service:
                name: frontend-service
                port:
                  number: 80

–ö–∞–∫ —ç—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è —Ç–µ—Å—Ç–æ–≤?

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ —É –≤–∞—Å –µ—Å—Ç—å –ø—Ä–∞–≤–∏–ª–æ –¥–ª—è localhost, –≤—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –∫–ª–∞—Å—Ç–µ—Ä–∞, –ø—Ä–æ–±—Ä–æ—Å–∏–≤ –ø–æ—Ä—Ç Ingress Controller'–∞ –Ω–∞ —Å–≤–æ–π –ª–æ–∫–∞–ª—å–Ω—ã–π –∫–æ–º–ø—å—é—Ç–µ—Ä:

    –ù–∞–π–¥–∏—Ç–µ –ø–æ–¥ Ingress Controller'–∞ (–æ–±—ã—á–Ω–æ –≤ namespace ingress-nginx –∏–ª–∏ kube-system, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ K3s):
    Bash

kubectl get pods -n kube-system # –∏–ª–∏ ingress-nginx

–°–¥–µ–ª–∞–π—Ç–µ Port-Forward:
Bash

    # –ü—Ä–∏–º–µ—Ä (–∑–∞–º–µ–Ω–∏—Ç–µ –∏–º—è –ø–æ–¥–∞ –Ω–∞ –≤–∞—à–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä svclb-traefik –∏–ª–∏ ingress-nginx-controller)
    kubectl port-forward -n kube-system service/traefik 8080:80

    –û—Ç–∫—Ä–æ–π—Ç–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ: –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–∫—Ä—ã—Ç—å http://localhost:8080, –∏ Ingress –ø—Ä–æ–ø—É—Å—Ç–∏—Ç —ç—Ç–æ—Ç –∑–∞–ø—Ä–æ—Å, —Ç–∞–∫ –∫–∞–∫ –∑–∞–≥–æ–ª–æ–≤–æ–∫ Host —Å–æ–≤–ø–∞–¥–µ—Ç —Å –ø—Ä–∞–≤–∏–ª–æ–º localhost.

–Ω–∞–ø–∏—à–∏ –º–Ω–µ –∫–æ–º–∞–Ω–¥—É –¥–ª—è –ø—É—à–∞ –≤—Ä—É—á–Ω—É—é

–í–æ—Ç –ø–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –∫–æ–º–∞–Ω–¥ –¥–ª—è —Ä—É—á–Ω–æ–π —Å–±–æ—Ä–∫–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ (–ø—É—à–∞) –æ–±—Ä–∞–∑–æ–≤ –≤ GitHub Container Registry (ghcr.io).

–í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–∞—à PAT (Personal Access Token), –∫–æ—Ç–æ—Ä—ã–π –º—ã —Å–æ–∑–¥–∞–≤–∞–ª–∏ —Ä–∞–Ω–µ–µ.
1. –õ–æ–≥–∏–Ω (–û–¥–∏–Ω —Ä–∞–∑)

–°–Ω–∞—á–∞–ª–∞ –Ω—É–∂–Ω–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ —Ä–µ–µ—Å—Ç—Ä–µ. –ó–∞–º–µ–Ω–∏—Ç–µ –í–ê–®_–ù–ò–ö–ù–ï–ô–ú –∏ –í–ê–®_–¢–û–ö–ï–ù.
Bash

export CR_PAT=–í–ê–®_–¢–û–ö–ï–ù
echo $CR_PAT | docker login ghcr.io -u –í–ê–®_–ù–ò–ö–ù–ï–ô–ú --password-stdin

2. –ë—ç–∫–µ–Ω–¥ (–°–±–æ—Ä–∫–∞ –∏ –ü—É—à)

–û–±—Ä–∞—Ç–∏—Ç–µ –≤–Ω–∏–º–∞–Ω–∏–µ: –∏–º—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ –º–∞–ª–µ–Ω—å–∫–∏–º–∏ –±—É–∫–≤–∞–º–∏.
Bash

# 1. –°–æ–±–∏—Ä–∞–µ–º –∏ —Å—Ä–∞–∑—É —Å—Ç–∞–≤–∏–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ç–µ–≥
# –ó–∞–º–µ–Ω–∏—Ç–µ <user> –∏ <repo> –Ω–∞ –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ
docker build -t ghcr.io/<user>/<repo>/backend:latest ./backend

# 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –æ–±–ª–∞–∫–æ
docker push ghcr.io/<user>/<repo>/backend:latest

3. –§—Ä–æ–Ω—Ç–µ–Ω–¥ (–°–±–æ—Ä–∫–∞ –∏ –ü—É—à)
Bash

# 1. –°–æ–±–∏—Ä–∞–µ–º
docker build -t ghcr.io/<user>/<repo>/frontend:latest ./frontend

# 2. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
docker push ghcr.io/<user>/<repo>/frontend:latest

–ü–æ—Å–ª–µ –ø—É—à–∞:

–ß—Ç–æ–±—ã Kubernetes —É–≤–∏–¥–µ–ª –∏–∑–º–µ–Ω–µ–Ω–∏—è, –≤–∞–º –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –¥–µ–ø–ª–æ–π–º–µ–Ω—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (—Ç–∞–∫ –∫–∞–∫ —Ç–µ–≥ :latest –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è, K8s –º–æ–∂–µ—Ç –Ω–µ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –æ–±—Ä–∞–∑ –æ–±–Ω–æ–≤–∏–ª—Å—è, –µ—Å–ª–∏ –Ω–µ —Ñ–æ—Ä—Å–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫):
Bash

kubectl rollout restart deployment/backend
kubectl rollout restart deployment/frontend

–∫–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ –æ–±—Ä–∞–∑–æ–≤ –Ω–∞ –º–∞—à–∏–Ω–µ —Å –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è –ø—Ä

–ß—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–∫–∞—á–∏–≤–∞–Ω–∏–µ (pull) –æ–±—Ä–∞–∑–æ–≤ —Å –ø—Ä–∏–≤–∞—Ç–Ω–æ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –Ω—É–∂–Ω–æ –ø—Ä–æ–π—Ç–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é. –ü—Ä–æ—Ü–µ—Å—Å –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –¥–ª—è —á–∏—Å—Ç–æ–≥–æ Docker –∏ –¥–ª—è Kubernetes (K3s).

–í–æ—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –æ–±–æ–∏—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤.
–í–∞—Ä–∏–∞–Ω—Ç 1: –î–ª—è Kubernetes (K3s)

Kubernetes –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã –¥–µ–ª–∞–µ—Ç–µ —á–µ—Ä–µ–∑ docker login –Ω–∞ —Ö–æ—Å—Ç–µ. –ï–º—É –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π —Ä–µ—Å—É—Ä—Å Secret, –≤ –∫–æ—Ç–æ—Ä–æ–º –±—É–¥–µ—Ç –ª–µ–∂–∞—Ç—å –≤–∞—à –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å (—Ç–æ–∫–µ–Ω).
–®–∞–≥ 1. –°–æ–∑–¥–∞–π—Ç–µ —Å–µ–∫—Ä–µ—Ç –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ

–ó–∞–π–¥–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä –ø–æ SSH –∏ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É.

–î–ª—è GitHub Container Registry (GHCR): –í–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –≤–∞—à PAT (Personal Access Token) (Classic), –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Å–æ–∑–¥–∞–ª–∏ –≤ GitHub.
Bash

# ghcr-secret ‚Äî —ç—Ç–æ –∏–º—è, –∫–æ—Ç–æ—Ä–æ–µ –º—ã –ø—Ä–∏–¥—É–º–∞–ª–∏
kubectl create secret docker-registry ghcr-secret \
  --docker-server=ghcr.io \
  --docker-username=–í–ê–®_GITHUB_–ù–ò–ö–ù–ï–ô–ú \
  --docker-password=–í–ê–®_–¢–û–ö–ï–ù_PAT \
  --docker-email=–í–ê–®_EMAIL

–î–ª—è AWS ECR: (–ü–æ–º–Ω–∏—Ç–µ, —Ç–æ–∫–µ–Ω –∂–∏–≤–µ—Ç 12 —á–∞—Å–æ–≤, –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –Ω—É–∂–µ–Ω CronJob, –∫–æ—Ç–æ—Ä—ã–π –º—ã –æ–±—Å—É–∂–¥–∞–ª–∏ –≤—ã—à–µ)
Bash

kubectl create secret docker-registry ecr-secret \
  --docker-server=ACCOUNT_ID.dkr.ecr.REGION.amazonaws.com \
  --docker-username=AWS \
  --docker-password=$(aws ecr get-login-password --region REGION)

–®–∞–≥ 2. –£–∫–∞–∂–∏—Ç–µ —Å–µ–∫—Ä–µ—Ç –≤ YAML

–¢–µ–ø–µ—Ä—å –≤ —Ñ–∞–π–ª—ã deployment.yaml –∏–ª–∏ statefulset.yaml –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–ª–µ imagePullSecrets. –û–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–∞ –æ–¥–Ω–æ–º —É—Ä–æ–≤–Ω–µ —Å containers.
YAML

spec:
  # ...
  template:
    spec:
      # --- –î–û–ë–ê–í–¨–¢–ï –≠–¢–û–¢ –ë–õ–û–ö ---
      imagePullSecrets:
        - name: ghcr-secret  # –ò–º—è —Å–µ–∫—Ä–µ—Ç–∞ –∏–∑ –®–∞–≥–∞ 1
      # --------------------------
      
      containers:
        - name: backend
          image: ghcr.io/user/repo/backend:latest

–í–∞—Ä–∏–∞–Ω—Ç 2: –î–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ Docker (–∏–ª–∏ Docker Compose)

–ï—Å–ª–∏ –≤—ã –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ K8s, –∞ –ø—Ä–æ—Å—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å docker run –∏–ª–∏ docker-compose up –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.
1. –õ–æ–≥–∏–Ω –≤ —Ä–µ–µ—Å—Ç—Ä

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

–î–ª—è GitHub (GHCR):
Bash

# –í–≤–æ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å (PAT —Ç–æ–∫–µ–Ω), –∫–æ–≥–¥–∞ –ø–æ–ø—Ä–æ—Å–∏—Ç
docker login ghcr.io -u –í–ê–®_GITHUB_–ù–ò–ö–ù–ï–ô–ú

–°–æ–≤–µ—Ç: –ß—Ç–æ–±—ã –Ω–µ –≤–≤–æ–¥–∏—Ç—å —Ç–æ–∫–µ–Ω –≤—Ä—É—á–Ω—É—é, –º–æ–∂–Ω–æ —Ç–∞–∫:
Bash

echo "–í–ê–®_–¢–û–ö–ï–ù" | docker login ghcr.io -u –í–ê–®_–ù–ò–ö–ù–ï–ô–ú --password-stdin

–î–ª—è AWS ECR: –í–∞–º –Ω—É–∂–Ω–æ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å aws-cli –Ω–∞ —Å–µ—Ä–≤–µ—Ä.
Bash

aws ecr get-login-password --region us-east-1 | docker login --username AWS --password-stdin 123456789012.dkr.ecr.us-east-1.amazonaws.com

2. –ü—Ä–æ–≤–µ—Ä–∫–∞

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ª–æ–≥–∏–Ω–∞ Docker —Å–æ—Ö—Ä–∞–Ω–∏—Ç –∫—Ä–µ–¥—ã –≤ ~/.docker/config.json. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –¥–µ–ª–∞—Ç—å:
Bash

docker pull ghcr.io/user/repo/backend:latest

–ò–ª–∏ –∑–∞–ø—É—Å–∫–∞—Ç—å docker-compose up -d, –∏ –æ–Ω —Å–∞–º —Å–∫–∞—á–∞–µ—Ç –æ–±—Ä–∞–∑—ã –±–µ–∑ –æ—à–∏–±–æ–∫.
‚ùì –ß—Ç–æ –≤—ã–±—Ä–∞—Ç—å?

    –ï—Å–ª–∏ —É –≤–∞—Å K3s/Kubernetes ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –í–∞—Ä–∏–∞–Ω—Ç 1. docker login –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –Ω–µ –ø–æ–º–æ–∂–µ—Ç –∫—É–±–µ—Ä–Ω–µ—Ç–µ—Å—É —Å–∫–∞—á–∞—Ç—å –æ–±—Ä–∞–∑—ã, —Ç–∞–∫ –∫–∞–∫ K3s —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ (containerd) –∏ –Ω–µ —Å–º–æ—Ç—Ä–∏—Ç –≤ –∫–æ–Ω—Ñ–∏–≥ –¥–æ–∫–µ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

    –ï—Å–ª–∏ —É –≤–∞—Å Docker Compose ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –í–∞—Ä–∏–∞–Ω—Ç 2.

Error from server (BadRequest): error when creating "env.yaml": Secret in version "v1" cannot be handled as a Secret: json: cannot unmarshal string in

to Go struct field Secret.stringData of type map[string]string

–≠—Ç–∞ –æ—à–∏–±–∫–∞ json: cannot unmarshal string into Go struct field Secret.stringData of type map[string]string –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ Kubernetes –æ–∂–∏–¥–∞–µ—Ç, —á—Ç–æ stringData –±—É–¥–µ—Ç —Å–ø–∏—Å–∫–æ–º –ø–∞—Ä "–∫–ª—é—á-–∑–Ω–∞—á–µ–Ω–∏–µ" (map), –∞ –≤—ã –ø–µ—Ä–µ–¥–∞–ª–∏ —Ç—É–¥–∞ –ø—Ä–æ—Å—Ç–æ —Å—Ç—Ä–æ–∫—É –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–ª–∏ YAML.

–°–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ, —É –≤–∞—Å –æ—à–∏–±–∫–∞ –≤ –æ—Ç—Å—Ç—É–ø–∞—Ö (–∏–Ω–¥–µ–Ω—Ç–∞—Ü–∏–∏) –∏–ª–∏ —Ñ–æ—Ä–º–∞—Ç–µ.
‚ùå –ö–∞–∫ —É –≤–∞—Å —Å–µ–π—á–∞—Å (–í–µ—Ä–æ—è—Ç–Ω–∞—è –æ—à–∏–±–∫–∞):

–õ–∏–±–æ –≤—ã –∑–∞–±—ã–ª–∏ –æ—Ç—Å—Ç—É–ø, –ª–∏–±–æ –ø–æ—Å—Ç–∞–≤–∏–ª–∏ –ª–∏—à–Ω–∏–π —Ç–µ–∫—Å—Ç:
YAML

# –û–®–ò–ë–ö–ê 1: –ù–µ—Ç –æ—Ç—Å—Ç—É–ø–æ–≤
stringData:
POSTGRES_PASSWORD: "password"

# –û–®–ò–ë–ö–ê 2: –í–æ—Å–ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –∫–∞–∫ –æ–¥–Ω–∞ —Å—Ç—Ä–æ–∫–∞
stringData: "POSTGRES_PASSWORD=password"

‚úÖ –ö–∞–∫ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å (–ü—Ä–∞–≤–∏–ª—å–Ω–æ):

stringData –¥–æ–ª–∂–Ω–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∫–ª—é—á–∏ —Å –æ—Ç—Å—Ç—É–ø–æ–º –≤ 2 –ø—Ä–æ–±–µ–ª–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Å–∞–º–æ–≥–æ —Å–ª–æ–≤–∞ stringData.

–û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à —Ñ–∞–π–ª env.yaml (–∏–ª–∏ —Ç–æ—Ç, –≥–¥–µ Secret) –∏ –∏—Å–ø—Ä–∞–≤—å—Ç–µ:
YAML

apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
type: Opaque
stringData:  # <--- –î–≤–æ–µ—Ç–æ—á–∏–µ, –∑–∞—Ç–µ–º –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞
  # –í–ê–ñ–ù–û: –û—Ç—Å—Ç—É–ø 2 –ø—Ä–æ–±–µ–ª–∞ –¥–ª—è –∫–ª—é—á–µ–π
  OPENAI_API_KEY: "sk-..."
  POSTGRES_PASSWORD: "super_secure_password"

–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å:

    –ü–æ—Å–ª–µ stringData: –Ω–∏—á–µ–≥–æ –Ω–µ –ø–∏—à–∏—Ç–µ –Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ.

    –°–ª–µ–¥—É—é—â–∞—è —Å—Ç—Ä–æ–∫–∞ –¥–æ–ª–∂–Ω–∞ –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å –æ—Ç—Å—Ç—É–ø–∞ (–ø—Ä–æ–±–µ–ª–æ–≤).

    –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–æ—Ä–º–∞—Ç –ö–õ–Æ–ß: "–∑–Ω–∞—á–µ–Ω–∏–µ" (—Å –¥–≤–æ–µ—Ç–æ—á–∏–µ–º –∏ –ø—Ä–æ–±–µ–ª–æ–º –ø–æ—Å–ª–µ –Ω–µ–≥–æ).

–ò—Å–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞:
Bash

kubectl apply -f env.yaml

–î–æ–∞–±–≤—å –Ω–µ–π–º—Å–ø–µ–π—Å

–î–æ–±–∞–≤–ª–µ–Ω–∏–µ Namespace (–ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–∞ –∏–º–µ–Ω) ‚Äî —ç—Ç–æ –æ—Ç–ª–∏—á–Ω–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–æ–ª–∏—Ä–æ–≤–∞—Ç—å –≤–∞—à–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –æ—Ç –¥—Ä—É–≥–∏—Ö —Å–∏—Å—Ç–µ–º–Ω—ã—Ö –≤–µ—â–µ–π –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ.

–î–∞–≤–∞–π—Ç–µ –Ω–∞–∑–æ–≤–µ–º –Ω–∞—à –Ω–µ–π–º—Å–ø–µ–π—Å researcher-app.

–í–æ—Ç –ø–æ–ª–Ω—ã–π –ø–ª–∞–Ω –∏–∑–º–µ–Ω–µ–Ω–∏–π.
1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª k8s/00-namespace.yaml

–≠—Ç–æ—Ç —Ñ–∞–π–ª –¥–æ–ª–∂–µ–Ω –ø—Ä–∏–º–µ–Ω—è—Ç—å—Å—è —Å–∞–º—ã–º –ø–µ—Ä–≤—ã–º, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Å–∞–º–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ –∏–º–µ–Ω.
YAML

apiVersion: v1
kind: Namespace
metadata:
  name: researcher-app

2. –û–±–Ω–æ–≤–∏—Ç–µ –í–°–ï –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –≤ –ø–∞–ø–∫–µ k8s/

–í–∞–º –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å—Ç—Ä–æ–∫—É namespace: researcher-app –≤ –±–ª–æ–∫ metadata –∫–∞–∂–¥–æ–≥–æ —Ä–µ—Å—É—Ä—Å–∞ (ConfigMap, Secret, Deployment, Service, PVC, Ingress, CronJob).

–ò—Å–∫–ª—é—á–µ–Ω–∏–µ: –ù–µ –¥–æ–±–∞–≤–ª—è–π—Ç–µ namespace –≤ ClusterIssuer (–≤ —Ñ–∞–π–ª–µ 07-ingress.yaml), —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –≥–ª–æ–±–∞–ª—å–Ω—ã–π —Ä–µ—Å—É—Ä—Å –∫–ª–∞—Å—Ç–µ—Ä–∞.
–ü—Ä–∏–º–µ—Ä –¥–ª—è k8s/01-environment.yaml
YAML

apiVersion: v1
kind: ConfigMap
metadata:
  name: app-config
  namespace: researcher-app # <-- –î–û–ë–ê–í–ò–¢–¨ –í–ï–ó–î–ï
data:
  # ...

---
apiVersion: v1
kind: Secret
metadata:
  name: app-secrets
  namespace: researcher-app # <-- –î–û–ë–ê–í–ò–¢–¨ –í–ï–ó–î–ï
type: Opaque
stringData:
  # ...

–ü—Ä–∏–º–µ—Ä –¥–ª—è k8s/05-backend.yaml
YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: researcher-app # <-- –¢–£–¢
spec:
  # ...
  template:
    metadata:
      # –í–Ω—É—Ç—Ä–∏ template namespace —É–∫–∞–∑—ã–≤–∞—Ç—å –ù–ï –Ω—É–∂–Ω–æ, –æ–Ω –Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è
      labels:
        app: backend
# ...
---
apiVersion: v1
kind: Service
metadata:
  name: backend-service
  namespace: researcher-app # <-- –ò –¢–£–¢
# ...

–°–¥–µ–ª–∞–π—Ç–µ —ç—Ç–æ –¥–ª—è —Ñ–∞–π–ª–æ–≤: 01, 02, 03, 04, 05, 06.
–í —Ñ–∞–π–ª–µ k8s/07-ingress.yaml
YAML

# ClusterIssuer –æ—Å—Ç–∞–≤–ª—è–µ–º –ë–ï–ó namespace!
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  # ...

---
# –ê –≤–æ—Ç Ingress –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –Ω–µ–π–º—Å–ø–µ–π—Å–µ
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  namespace: researcher-app # <-- –î–û–ë–ê–í–ò–¢–¨
  annotations:
    # ...

3. –û–±–Ω–æ–≤–∏—Ç–µ —Ä—É—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã (–°–æ–∑–¥–∞–Ω–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤)

–¢–∞–∫ –∫–∞–∫ —Å–µ–∫—Ä–µ—Ç—ã —Ç–µ–ø–µ—Ä—å –∂–∏–≤—É—Ç –≤ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º –Ω–µ–π–º—Å–ø–µ–π—Å–µ, –ø—Ä–∏ –∏—Ö —Ä—É—á–Ω–æ–º —Å–æ–∑–¥–∞–Ω–∏–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è GHCR) –Ω—É–∂–Ω–æ —É–∫–∞–∑—ã–≤–∞—Ç—å —Ñ–ª–∞–≥ -n.

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
Bash

# –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –Ω–µ–π–º—Å–ø–µ–π—Å (–µ—Å–ª–∏ –µ—â–µ –Ω–µ –ø—Ä–∏–º–µ–Ω–∏–ª–∏ —Ñ–∞–π–ª 00)
kubectl create namespace researcher-app

# –°–æ–∑–¥–∞–µ–º —Å–µ–∫—Ä–µ—Ç –¥–ª—è GitHub Registry –í–ù–£–¢–†–ò –Ω–µ–π–º—Å–ø–µ–π—Å–∞
kubectl create secret docker-registry ghcr-secret \
  --docker-server=ghcr.io \
  --docker-username=–í–ê–®_–õ–û–ì–ò–ù \
  --docker-password=–í–ê–®_PAT_–¢–û–ö–ï–ù \
  --docker-email=–í–ê–®_EMAIL \
  --namespace=researcher-app  # <--- –í–ê–ñ–ù–û

4. –û–±–Ω–æ–≤–∏—Ç–µ GitHub Actions (deploy.yml)

–í –ø–∞–π–ø–ª–∞–π–Ω–µ –∫–æ–º–∞–Ω–¥–∞ kubectl apply —Å—Ä–∞–±–æ—Ç–∞–µ—Ç —Å–∞–º–∞ (—Ç–∞–∫ –∫–∞–∫ namespace –ø—Ä–æ–ø–∏—Å–∞–Ω –≤ —Ñ–∞–π–ª–∞—Ö), –Ω–æ –∫–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞ (rollout restart) –Ω—É–∂–Ω–æ –Ω–∞–ø—Ä–∞–≤–∏—Ç—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–µ–π–º—Å–ø–µ–π—Å.
YAML

      - name: Apply K8s
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # –ü—Ä–∏–º–µ–Ω—è–µ–º –º–∞–Ω–∏—Ñ–µ—Å—Ç—ã (–æ–Ω–∏ —Å–∞–º–∏ –Ω–∞–π–¥—É—Ç —Å–≤–æ–π namespace)
            kubectl apply -f ~/app-deploy/k8s/
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥—ã –Ø–í–ù–û —É–∫–∞–∑—ã–≤–∞—è namespace
            kubectl rollout restart deployment/backend -n researcher-app
            kubectl rollout restart deployment/frontend -n researcher-app

5. –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è

–¢–µ–ø–µ—Ä—å –≤—Å–µ –≤–∞—à–∏ –ø–æ–¥—ã –±—É–¥—É—Ç "—Å–∫—Ä—ã—Ç—ã" –∏–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞.

    –ù–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç: kubectl get pods (–ø–æ–∫–∞–∂–µ—Ç –ø—É—Å—Ç–æ—Ç—É –∏–ª–∏ default –Ω–µ–π–º—Å–ø–µ–π—Å).

    –°—Ä–∞–±–æ—Ç–∞–µ—Ç: kubectl get pods -n researcher-app

–ß—Ç–æ–±—ã –Ω–µ –ø–∏—Å–∞—Ç—å -n researcher-app –∫–∞–∂–¥—ã–π —Ä–∞–∑, –º–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç:
Bash

kubectl config set-context --current --namespace=researcher-app

–ö–∞–∫ –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∞–¥—Ä–µ—Å–∞—Ü–∏—è

–° –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º Namespace (researcher-app) –ø—Ä–∞–≤–∏–ª–∞ –∞–¥—Ä–µ—Å–∞—Ü–∏–∏ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ –º–µ–Ω—è—é—Ç—Å—è, –Ω–æ Kubernetes –¥–µ–ª–∞–µ—Ç —ç—Ç–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –≤–∞—à–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –≤ –æ–¥–Ω–æ–º –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –∏–º–µ–Ω.

–í–æ—Ç —Å—Ö–µ–º–∞ —Ç–æ–≥–æ, –∫–∞–∫ –ø—Ä–æ—Ö–æ–¥–∏—Ç –∑–∞–ø—Ä–æ—Å –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–æ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö:
1. –ò–∑ –ò–Ω—Ç–µ—Ä–Ω–µ—Ç–∞ –≤ –ö–ª–∞—Å—Ç–µ—Ä (Ingress)

–ö–æ–≥–¥–∞ –∑–∞–ø—Ä–æ—Å –ø—Ä–∏—Ö–æ–¥–∏—Ç —Å–Ω–∞—Ä—É–∂–∏ (—á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π Nginx/–ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫), –æ–Ω –ø–æ–ø–∞–¥–∞–µ—Ç –≤ –≤–∞—à Ingress Controller.

Ingress Controller —á–∏—Ç–∞–µ—Ç –≤–∞—à —Ñ–∞–π–ª 07-ingress.yaml –∏ –≤–∏–¥–∏—Ç –ø—Ä–∞–≤–∏–ª–æ:
YAML

- path: /api
  backend:
    service:
      name: backend-service # <-- –ö—É–¥–∞ —Å–ª–∞—Ç—å?
      port: number: 8000

–¢–∞–∫ –∫–∞–∫ Ingress –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Ç–æ–º –∂–µ namespace researcher-app, –æ–Ω –∏—â–µ—Ç —Å–µ—Ä–≤–∏—Å —Å –∏–º–µ–Ω–µ–º backend-service –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–º –Ω–µ–π–º—Å–ø–µ–π—Å–µ.
2. –í–Ω—É—Ç—Ä–∏ –Ω–µ–π–º—Å–ø–µ–π—Å–∞ (Backend -> Postgres)

–≠—Ç–æ —Å–∞–º—ã–π –≤–∞–∂–Ω—ã–π –º–æ–º–µ–Ω—Ç. –í –≤–∞—à–µ–º –∫–æ–Ω—Ñ–∏–≥–µ (01-environment.yaml) –Ω–∞–ø–∏—Å–∞–Ω–æ:
YAML

POSTGRES_HOST: "postgres"

–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

    –ë—ç–∫–µ–Ω–¥ –ø—ã—Ç–∞–µ—Ç—Å—è —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è —Å —Ö–æ—Å—Ç–æ–º postgres.

    –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π DNS Kubernetes (CoreDNS) —Å–Ω–∞—á–∞–ª–∞ –∏—â–µ—Ç —ç—Ç–æ—Ç —Ö–æ—Å—Ç –≤ —Ç–µ–∫—É—â–µ–º –Ω–µ–π–º—Å–ø–µ–π—Å–µ (researcher-app).

    –û–Ω –Ω–∞—Ö–æ–¥–∏—Ç Service —Å –∏–º–µ–Ω–µ–º postgres –≤ researcher-app.

    DNS –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç IP-–∞–¥—Ä–µ—Å —ç—Ç–æ–≥–æ —Å–µ—Ä–≤–∏—Å–∞.

–ò—Ç–æ–≥: –í–∞–º –Ω–µ –Ω—É–∂–Ω–æ –º–µ–Ω—è—Ç—å –∫–æ–Ω—Ñ–∏–≥–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ü–æ–∫–∞ –ë—ç–∫–µ–Ω–¥ –∏ –ë–∞–∑–∞ –ª–µ–∂–∞—Ç –≤ –æ–¥–Ω–æ–º namespace, –æ–Ω–∏ –≤–∏–¥—è—Ç –¥—Ä—É–≥ –¥—Ä—É–≥–∞ –ø–æ –∫–æ—Ä–æ—Ç–∫–∏–º –∏–º–µ–Ω–∞–º (postgres, backend-service, frontend-service).
3. –ü–æ–ª–Ω–æ–µ –¥–æ–º–µ–Ω–Ω–æ–µ –∏–º—è (FQDN)

–ï—Å–ª–∏ –±—ã –≤—ã –∑–∞—Ö–æ—Ç–µ–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –≤–∞—à–µ–º—É —Å–µ—Ä–≤–∏—Å—É –∏–∑ –¥—Ä—É–≥–æ–≥–æ –Ω–µ–π–º—Å–ø–µ–π—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏–∑ default), –∫–æ—Ä–æ—Ç–∫–æ–µ –∏–º—è postgres –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–æ –±—ã.

–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –≤–Ω—É—Ç—Ä–∏ Kubernetes —Å—Ç—Ä–æ–∏—Ç—Å—è —Ç–∞–∫: ipv4 <–∏–º—è-—Å–µ—Ä–≤–∏—Å–∞>.<–∏–º—è-–Ω–µ–π–º—Å–ø–µ–π—Å–∞>.svc.cluster.local `

–í –≤–∞—à–µ–º —Å–ª—É—á–∞–µ –ø–æ–ª–Ω—ã–µ –∞–¥—Ä–µ—Å–∞ (–∫–æ—Ç–æ—Ä—ã–µ —Ç–æ–∂–µ —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω–æ –æ–Ω–∏ –¥–ª–∏–Ω–Ω—ã–µ) –±—É–¥—É—Ç —Ç–∞–∫–∏–º–∏:

    –ë—ç–∫–µ–Ω–¥: backend-service.researcher-app.svc.cluster.local

    –ë–∞–∑–∞: postgres.researcher-app.svc.cluster.local

    –§—Ä–æ–Ω—Ç–µ–Ω–¥: frontend-service.researcher-app.svc.cluster.local

4. –ß—Ç–æ –µ—Å–ª–∏ —è —Ö–æ—á—É –ø—Ä–æ–≤–µ—Ä–∏—Ç—å Localhost?

–ü–æ—Å–∫–æ–ª—å–∫—É –≤—ã –¥–æ–±–∞–≤–∏–ª–∏ –ø—Ä–∞–≤–∏–ª–æ host: localhost –≤ Ingress:

    –í—ã –¥–µ–ª–∞–µ—Ç–µ –ø—Ä–æ–±—Ä–æ—Å –ø–æ—Ä—Ç–∞ (port-forward) –Ω–∞ —Å–≤–æ–µ–π –º–∞—à–∏–Ω–µ –¥–æ Ingress Controller'–∞.

    –û—Ç–∫—Ä—ã–≤–∞–µ—Ç–µ –±—Ä–∞—É–∑–µ—Ä http://localhost:8080.

    –ë—Ä–∞—É–∑–µ—Ä —à–ª–µ—Ç –∑–∞–≥–æ–ª–æ–≤–æ–∫ Host: localhost.

    Ingress –≤ –Ω–µ–π–º—Å–ø–µ–π—Å–µ researcher-app –≤–∏–¥–∏—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞ frontend-service –≤ —Ç–æ–º –∂–µ –Ω–µ–π–º—Å–ø–µ–π—Å–µ.

–†–µ–∑—é–º–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

    –ö–æ–Ω—Ñ–∏–≥–∏ (.env): –ú–µ–Ω—è—Ç—å –Ω–µ –Ω—É–∂–Ω–æ. –ö–æ—Ä–æ—Ç–∫–∏–µ –∏–º–µ–Ω–∞ (postgres) —Ä–∞–±–æ—Ç–∞—é—Ç, —Ç–∞–∫ –∫–∞–∫ –≤—Å–µ –≤ –æ–¥–Ω–æ–π "–∫–æ–º–Ω–∞—Ç–µ" (namespace).

    Ingress: –í —Ñ–∞–π–ª–µ Ingress –º—ã –¥–æ–±–∞–≤–∏–ª–∏ namespace: researcher-app, –ø–æ—ç—Ç–æ–º—É –æ–Ω –∑–Ω–∞–µ—Ç, —á—Ç–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –Ω—É–∂–Ω–æ –Ω–∞ —Å–µ—Ä–≤–∏—Å—ã –≤–Ω—É—Ç—Ä–∏ researcher-app.

    –ò–∑–æ–ª—è—Ü–∏—è: –¢–µ–ø–µ—Ä—å –≤–∞—à–∏ —Å–µ—Ä–≤–∏—Å—ã –Ω–µ –≤–∏–¥—è—Ç —Å–µ—Ä–≤–∏—Å—ã –∏–∑ default –∏–ª–∏ –¥—Ä—É–≥–∏—Ö –Ω–µ–π–º—Å–ø–µ–π—Å–æ–≤ –ø–æ –∫–æ—Ä–æ—Ç–∫–∏–º –∏–º–µ–Ω–∞–º, —á—Ç–æ –ø–æ–≤—ã—à–∞–µ—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –ø–æ—Ä—è–¥–æ–∫.

–ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è –∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é –ø–æ–ª—É—á–∞—é 404 page not found

–û—à–∏–±–∫–∞ 404 Page Not Found –≤ Kubernetes –æ–±—ã—á–Ω–æ –æ–∑–Ω–∞—á–∞–µ—Ç –æ–¥–Ω—É –∏–∑ —Ç—Ä–µ—Ö –≤–µ—â–µ–π:

    Ingress Controller –Ω–µ –≤–∏–¥–∏—Ç –≤–∞—à–µ –ø—Ä–∞–≤–∏–ª–æ (—Å–∞–º–∞—è —á–∞—Å—Ç–∞—è –ø—Ä–∏—á–∏–Ω–∞ –≤ K3s).

    –í—ã –æ–±—Ä–∞—â–∞–µ—Ç–µ—Å—å –ø–æ IP-–∞–¥—Ä–µ—Å—É, –∞ Ingress –∂–¥–µ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –¥–æ–º–µ–Ω (Host header).

    –¢—Ä–∞—Ñ–∏–∫ –¥–æ—Ö–æ–¥–∏—Ç –¥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞, –Ω–æ React Router –∏–ª–∏ Nginx –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–µ–≤–µ—Ä–Ω–æ.

–î–∞–≤–∞–π—Ç–µ –ø—Ä–æ–π–¥–µ–º—Å—è –ø–æ —à–∞–≥–∞–º, —á—Ç–æ–±—ã –Ω–∞–π—Ç–∏ –ø—Ä–∏—á–∏–Ω—É.
–®–∞–≥ 1: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∞–∫—Ç–∏–≤–µ–Ω –ª–∏ Ingress

–í—ã–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:
Bash

kubectl get ingress -n researcher-app

–ß—Ç–æ –∏—Å–∫–∞—Ç—å:

    –ï—Å—Ç—å –ª–∏ –≤ –∫–æ–ª–æ–Ω–∫–µ ADDRESS IP-–∞–¥—Ä–µ—Å?

        –ï—Å–ª–∏ —Ç–∞–º –ø—É—Å—Ç–æ –∏–ª–∏ –Ω–∞–ø–∏—Å–∞–Ω–æ <pending> –¥–æ–ª–≥–æ–µ –≤—Ä–µ–º—è ‚Äî –∑–Ω–∞—á–∏—Ç, Ingress Controller –Ω–µ –ø–æ–¥—Ö–≤–∞—Ç–∏–ª –≤–∞—à—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é.

–ü—Ä–∏—á–∏–Ω–∞ (–°–ø–µ—Ü–∏—Ñ–∏–∫–∞ K3s): K3s –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –∏—Å–ø–æ–ª—å–∑—É–µ—Ç Traefik, –∞ –≤ –Ω–∞—à–∏—Ö –∫–æ–Ω—Ñ–∏–≥–∞—Ö –º—ã –Ω–∞–ø–∏—Å–∞–ª–∏ kubernetes.io/ingress.class: "nginx".

–†–µ—à–µ–Ω–∏–µ: –ï—Å–ª–∏ –≤—ã –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ Nginx Ingress Controller, –≤–∞–º –Ω—É–∂–Ω–æ –ø–æ–º–µ–Ω—è—Ç—å –∞–Ω–Ω–æ—Ç–∞—Ü–∏—é –≤ —Ñ–∞–π–ª–µ k8s/07-ingress.yaml, —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Traefik –∏–∑ K3s:
YAML

metadata:
  name: app-ingress
  namespace: researcher-app
  annotations:
    # –ò–ó–ú–ï–ù–ò–¢–ï –≠–¢–£ –°–¢–†–û–ö–£ (–µ—Å–ª–∏ —É –≤–∞—Å —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π K3s):
    kubernetes.io/ingress.class: "traefik"
    
    # Traefik —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–≤–º–µ—Å—Ç–æ nginx.*)
    # –û—Ç–∫–ª—é—á–µ–Ω–∏–µ SSL —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞ –¥–ª—è Traefik (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
    traefik.ingress.kubernetes.io/router.middlewares: "default-strip-prefix@kubernetescrd" # –ü—Ä–∏–º–µ—Ä, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

–ù–æ –ª—É—á—à–µ –ø—Ä–æ—Å—Ç–æ —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É ingress.class –≤–æ–æ–±—â–µ, –µ—Å–ª–∏ —É –≤–∞—Å –≤ –∫–ª–∞—Å—Ç–µ—Ä–µ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä.
–®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ "Host" –∑–∞–≥–æ–ª–æ–≤–∫–∞

–í –≤–∞—à–µ–º –∫–æ–Ω—Ñ–∏–≥–µ Ingress –µ—Å—Ç—å –∂–µ—Å—Ç–∫–æ–µ –ø—Ä–∞–≤–∏–ª–æ:
YAML

rules:
  - host: qwestor.general.singularitynet.dev
  - host: localhost

–ï—Å–ª–∏ –≤—ã –ø–æ–ø—ã—Ç–∞–µ—Ç–µ—Å—å –æ—Ç–∫—Ä—ã—Ç—å —Å–∞–π—Ç –ø–æ IP-–∞–¥—Ä–µ—Å—É (–Ω–∞–ø—Ä–∏–º–µ—Ä, http://172.xx.xx.xx), Ingress –Ω–µ –Ω–∞–π–¥–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è –∏ –≤–µ—Ä–Ω–µ—Ç 404. –≠—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ.

–ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å: –°–¥–µ–ª–∞–π—Ç–µ –∑–∞–ø—Ä–æ—Å —Å —Å–µ—Ä–≤–µ—Ä–∞ (–∏–ª–∏ –ª–æ–∫–∞–ª—å–Ω–æ), –ø—Ä–∏—Ç–≤–æ—Ä–∏–≤—à–∏—Å—å, —á—Ç–æ –≤—ã –∏–¥–µ—Ç–µ –ø–æ –¥–æ–º–µ–Ω—É:
Bash

# –ó–∞–º–µ–Ω–∏—Ç–µ IP_–°–ï–†–í–ï–†–ê –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π IP
curl -v -H "Host: qwestor.general.singularitynet.dev" http://IP_–°–ï–†–í–ï–†–ê/

    –ï—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ HTML –∫–æ–¥ (React App) ‚Äî –∑–Ω–∞—á–∏—Ç Ingress —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–±–ª–µ–º–∞ –≤–æ –≤–Ω–µ—à–Ω–µ–º DNS –∏–ª–∏ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤—â–∏–∫–µ.

    –ï—Å–ª–∏ –ø–æ–ª—É—á–∏—Ç–µ 404 ‚Äî –ø—Ä–æ–±–ª–µ–º–∞ –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞.

–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ Ingress -> Service

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Ingress —Å–º–æ—Ç—Ä–∏—Ç –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–µ—Ä–≤–∏—Å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º namespace.

    –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –µ—Å—Ç—å –ª–∏ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —É —Å–µ—Ä–≤–∏—Å–∞ (–∑–Ω–∞–µ—Ç –ª–∏ —Å–µ—Ä–≤–∏—Å, –≥–¥–µ –∂–∏–≤—É—Ç –ø–æ–¥—ã):
    Bash

    kubectl get endpoints frontend-service -n researcher-app

        –í –∫–æ–ª–æ–Ω–∫–µ ENDPOINTS –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å IP-–∞–¥—Ä–µ—Å–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10.42.0.5:80).

        –ï—Å–ª–∏ —Ç–∞–º <none>, –∑–Ω–∞—á–∏—Ç Service Selector –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å Labels –≤ Deployment.

    –ü—Ä–æ–≤–µ—Ä–∫–∞:

        –í 06-frontend.yaml (Service) –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å selector: app: frontend.

        –í 06-frontend.yaml (Deployment -> template -> metadata -> labels) –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å labels: app: frontend.

–®–∞–≥ 4: –ü—Ä–æ–≤–µ—Ä–∫–∞ Nginx –≤–Ω—É—Ç—Ä–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞

–ï—Å–ª–∏ Ingress —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å, –≤–æ–∑–º–æ–∂–Ω–æ, 404 –æ—Ç–¥–∞–µ—Ç —Å–∞–º Nginx –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ frontend.

–≠—Ç–æ —Å–ª—É—á–∞–µ—Ç—Å—è, –µ—Å–ª–∏ Nginx –Ω–µ –º–æ–∂–µ—Ç –Ω–∞–π—Ç–∏ —Ñ–∞–π–ª—ã.

    –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ –ø–æ–¥–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞:
    Bash

    kubectl logs -l app=frontend -n researcher-app

    –ï—Å–ª–∏ –≤–∏–¥–∏—Ç–µ —Ç–∞–º —Å—Ç—Ä–æ–∫–∏ –≤—Ä–æ–¥–µ: "GET / HTTP/1.1" 404 ... open() "/usr/share/nginx/html/index.html" failed

    –≠—Ç–æ –∑–Ω–∞—á–∏—Ç, —á—Ç–æ Docker-–æ–±—Ä–∞–∑ —Å–æ–±—Ä–∞–ª—Å—è –∫—Ä–∏–≤–æ, –∏ —Ñ–∞–π–ª—ã React –Ω–µ –ø–æ–ø–∞–ª–∏ –≤ –ø–∞–ø–∫—É /usr/share/nginx/html.

–ö–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à frontend/Dockerfile. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ COPY --from=builder /app/build /usr/share/nginx/html –∫–æ–ø–∏—Ä—É–µ—Ç –∏–º–µ–Ω–Ω–æ –ø–∞–ø–∫—É build. (–ò–Ω–æ–≥–¥–∞ –ø–∞–ø–∫–∞ –Ω–∞–∑—ã–≤–∞–µ—Ç—Å—è dist, –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–µ—Ä—Å–∏–∏ Create React App –∏–ª–∏ Vite).
–ë—ã—Å—Ç—Ä–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è K3s (Traefik)

–ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ "—á–∏—Å—Ç—ã–π" K3s –∏ –Ω–µ —Å—Ç–∞–≤–∏–ª–∏ Nginx Ingress, –∏—Å–ø—Ä–∞–≤—å—Ç–µ k8s/07-ingress.yaml —Ç–∞–∫:

–£–¥–∞–ª–∏—Ç–µ –∞–Ω–Ω–æ—Ç–∞—Ü–∏–∏ nginx.* –∏ –∫–ª–∞—Å—Å, —Å–¥–µ–ª–∞–π—Ç–µ –µ–≥–æ –ø—Ä–æ—â–µ:
YAML

apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: app-ingress
  namespace: researcher-app
  # –£–±–∏—Ä–∞–µ–º ingress.class, –ø—É—Å—Ç—å K3s —Å–∞–º —Ä–µ—à–∏—Ç
  annotations:
    # –î–ª—è Traefik –æ—Ç–∫–ª—é—á–∞–µ–º HTTPS —Ä–µ–¥–∏—Ä–µ–∫—Ç (–µ—Å–ª–∏ SSL —Å–Ω–∞—Ä—É–∂–∏)
    traefik.ingress.kubernetes.io/router.entrypoints: web
spec:
  rules:
    - host: qwestor.general.singularitynet.dev
      http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          - path: /ws
            pathType: Prefix
            backend:
              service:
                name: backend-service
                port:
                  number: 8000
          - path: /
            pathType: Prefix
            backend:
              service:
                name: frontend-service
                port:
                  number: 80

–ü—Ä–∏–º–µ–Ω–∏—Ç–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è: kubectl apply -f k8s/07-ingress.yaml.

—Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ nginx —Å–ª—É—à–∞–µ—Ç 3000 –ø–æ—Ä—Ç

–≠—Ç–æ –≤—Å–µ –æ–±—ä—è—Å–Ω—è–µ—Ç! –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ª—É—à–∞–µ—Ç –ø–æ—Ä—Ç 3000, –∞ Kubernetes (Service –∏ Ingress) –ø—ã—Ç–∞–µ—Ç—Å—è —Å—Ç—É—á–∞—Ç—å—Å—è –≤ –ø–æ—Ä—Ç 80, —Ç—Ä–∞—Ñ–∏–∫ –ø—Ä–æ—Å—Ç–æ –Ω–µ –¥–æ—Ö–æ–¥–∏—Ç, –∏ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –æ—à–∏–±–∫—É (–æ–±—ã—á–Ω–æ 502 Bad Gateway –∏–ª–∏ 404).

–í–∞–º –Ω—É–∂–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Ä—Ç—ã –≤ —Ü–µ–ø–æ—á–∫–µ: Service -> Pod.

–í–æ—Ç –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π —Ñ–∞–π–ª k8s/06-frontend.yaml.
–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π k8s/06-frontend.yaml

–ú—ã –¥–µ–ª–∞–µ–º —Å–ª–µ–¥—É—é—â–µ–µ:

    –í Deployment —É–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –ø–æ—Ä—Ç 3000.

    –í Service –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º "–º–æ—Å—Ç": —Å–µ—Ä–≤–∏—Å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π HTTP (80) –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞, –Ω–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ –Ω–∞ –ø–æ—Ä—Ç 3000 –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä.

YAML

apiVersion: apps/v1
kind: Deployment
metadata:
  name: frontend
  namespace: researcher-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: frontend
  template:
    metadata:
      labels:
        app: frontend
    spec:
      imagePullSecrets:
        - name: ghcr-secret
      containers:
        - name: frontend
          image: ghcr.io/<USER>/<REPO>/frontend:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 3000 # <--- –í–ê–ñ–ù–û: –ü–æ—Ä—Ç, –∫–æ—Ç–æ—Ä—ã–π —Å–ª—É—à–∞–µ—Ç Nginx –≤–Ω—É—Ç—Ä–∏
---
apiVersion: v1
kind: Service
metadata:
  name: frontend-service
  namespace: researcher-app
spec:
  selector:
    app: frontend
  ports:
    - protocol: TCP
      port: 80           # <--- –°–µ—Ä–≤–∏—Å –≤–Ω—É—Ç—Ä–∏ –∫–ª–∞—Å—Ç–µ—Ä–∞ –ø–æ-–ø—Ä–µ–∂–Ω–µ–º—É –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ 80 (—Å—Ç–∞–Ω–¥–∞—Ä—Ç)
      targetPort: 3000   # <--- –ù–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–∞ 3000

–ù—É–∂–Ω–æ –ª–∏ –º–µ–Ω—è—Ç—å Ingress?

–ù–µ—Ç, –µ—Å–ª–∏ –≤—ã –æ—Å—Ç–∞–≤–∏–ª–∏ port: 80 –≤ —Å–µ–∫—Ü–∏–∏ Service (–∫–∞–∫ —è —Å–¥–µ–ª–∞–ª –≤—ã—à–µ).

–õ–æ–≥–∏–∫–∞ —Ç–∞–∫–∞—è:

    Ingress —à–ª–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ frontend-service:80.

    Service –ø—Ä–∏–Ω–∏–º–∞–µ—Ç –Ω–∞ 80 –∏ –ø–µ—Ä–µ–∫–∏–¥—ã–≤–∞–µ—Ç –Ω–∞ Pod:3000.

    Pod (Nginx) —Å–ª—É—à–∞–µ—Ç 3000 –∏ –æ—Ç–¥–∞–µ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç.

–ü—Ä–æ–≤–µ—Ä–∫–∞ Dockerfile –∏ Nginx Conf

–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–Ω—É—Ç—Ä–∏ –≤–∞—à–µ–≥–æ –æ–±—Ä–∞–∑–∞ frontend –∫–æ–Ω—Ñ–∏–≥ Nginx –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ 3000.

–í–∞—à frontend/nginx.conf –¥–æ–ª–∂–µ–Ω –≤—ã–≥–ª—è–¥–µ—Ç—å —Ç–∞–∫:
Nginx

server {
    listen 3000; # <--- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ 3000
    
    root /usr/share/nginx/html;
    index index.html;

    location / {
        try_files $uri $uri/ /index.html;
    }
}

–ê –≤ frontend/Dockerfile –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–∞:
Dockerfile

EXPOSE 3000

–ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å:

    –ï—Å–ª–∏ –º–µ–Ω—è–ª–∏ nginx.conf, –ø–µ—Ä–µ—Å–æ–±–µ—Ä–∏—Ç–µ –∏ –∑–∞–ø—É—à—å—Ç–µ –æ–±—Ä–∞–∑:
    Bash

# (–õ–æ–∫–∞–ª—å–Ω–æ)
docker build -t ghcr.io/user/repo/frontend:latest ./frontend
docker push ghcr.io/user/repo/frontend:latest

–û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–Ω—Ñ–∏–≥–∏ –≤ Kubernetes:
Bash

    # (–ù–∞ —Å–µ—Ä–≤–µ—Ä–µ)
    kubectl apply -f k8s/06-frontend.yaml

    # –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ –ø–æ–¥, —á—Ç–æ–±—ã –ø–æ–¥—Ç—è–Ω—É—Ç—å –Ω–æ–≤—ã–π –∫–æ–Ω—Ñ–∏–≥/–æ–±—Ä–∞–∑
    kubectl rollout restart deployment/frontend -n researcher-app

ssh —á–µ—Ä–µ–∑ jump —Å–µ—Ä–≤–µ—Ä –≤ github actions

–î–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–µ–ø–ª–æ—è –∏–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥ –Ω–∞ –∑–∞–∫—Ä—ã—Ç–æ–º —Å–µ—Ä–≤–µ—Ä–µ (Target Server) —á–µ—Ä–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (Jump Host / Bastion) –≤ GitHub Actions, –µ—Å—Ç—å –¥–≤–∞ –æ—Å–Ω–æ–≤–Ω—ã—Ö —Å–ø–æ—Å–æ–±–∞.

–°–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π –∏ –Ω–∞–¥–µ–∂–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç ‚Äî –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–æ—Ç–æ–≤—ã–π —ç–∫—à–µ–Ω appleboy/ssh-action.
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞

–¢—Ä–∞—Ñ–∏–∫ –∏–¥–µ—Ç —Ç–∞–∫: GitHub Runner -> Jump Server (Public IP) -> Target Server (Private IP)
–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞: Secrets –≤ GitHub

–ü–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ø–∞–π–ø–ª–∞–π–Ω–∞ –¥–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π (Settings -> Secrets and variables -> Actions):

    SSH_PRIVATE_KEY: –í–∞—à –ø—Ä–∏–≤–∞—Ç–Ω—ã–π SSH –∫–ª—é—á.

        –°–æ–≤–µ—Ç: –î–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã –¥–æ–±–∞–≤—å—Ç–µ –ø—É–±–ª–∏—á–Ω—É—é —á–∞—Å—Ç—å —ç—Ç–æ–≥–æ –∫–ª—é—á–∞ (id_rsa.pub) –≤ —Ñ–∞–π–ª ~/.ssh/authorized_keys –∏ –Ω–∞ Jump —Å–µ—Ä–≤–µ—Ä–µ, –∏ –Ω–∞ Target —Å–µ—Ä–≤–µ—Ä–µ.

    JUMP_HOST: –ü—É–±–ª–∏—á–Ω—ã–π IP –∞–¥—Ä–µ—Å Jump —Å–µ—Ä–≤–µ—Ä–∞.

    JUMP_USER: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ Jump —Å–µ—Ä–≤–µ—Ä–µ (–æ–±—ã—á–Ω–æ ubuntu –∏–ª–∏ root).

    TARGET_HOST: –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π IP –∞–¥—Ä–µ—Å —Ü–µ–ª–µ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10.0.1.5).

    TARGET_USER: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ —Ü–µ–ª–µ–≤–æ–º —Å–µ—Ä–≤–µ—Ä–µ.

–°–ø–æ—Å–æ–± 1: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ appleboy/ssh-action (–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π)

–≠—Ç–æ—Ç —ç–∫—à–µ–Ω –Ω–∞—Ç–∏–≤–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä proxy_host (—ç—Ç–æ –∏ –µ—Å—Ç—å jump —Å–µ—Ä–≤–µ—Ä).

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .github/workflows/deploy.yml:
YAML

name: Deploy via Jump Host

on:
  push:
    branches: [ "main" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Execute SSH commands on Target Server
        uses: appleboy/ssh-action@master
        with:
          # --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞ (Target) ---
          host: ${{ secrets.TARGET_HOST }}
          username: ${{ secrets.TARGET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          
          # --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Jump —Å–µ—Ä–≤–µ—Ä–∞ (Bastion) ---
          proxy_host: ${{ secrets.JUMP_HOST }}
          proxy_username: ${{ secrets.JUMP_USER }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }} # –û–±—ã—á–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ—Ç –∂–µ –∫–ª—é—á
          proxy_port: 22
          
          # --- –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è ---
          script: |
            echo "–Ø –ø–æ–¥–∫–ª—é—á–∏–ª—Å—è —á–µ—Ä–µ–∑ Jump —Å–µ—Ä–≤–µ—Ä!"
            whoami
            hostname -I
            # docker pull ...
            # docker-compose up -d ...

–°–ø–æ—Å–æ–± 2: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ SSH (ssh -J)

–ï—Å–ª–∏ –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ —ç–∫—à–µ–Ω—ã, –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ Linux. –≠—Ç–æ —Å–ª–æ–∂–Ω–µ–µ, —Ç–∞–∫ –∫–∞–∫ –Ω—É–∂–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å ssh-agent –∏ known_hosts.
YAML

name: Manual SSH Jump

on: [push]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh/
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # –î–æ–±–∞–≤–ª—è–µ–º –∫–ª—é—á–∏ —Å–µ—Ä–≤–µ—Ä–æ–≤ –≤ known_hosts, —á—Ç–æ–±—ã SSH –Ω–µ —Å–ø—Ä–∞—à–∏–≤–∞–ª –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
          # 1. –°–∫–∞–Ω–∏—Ä—É–µ–º Jump —Ö–æ—Å—Ç
          ssh-keyscan -H ${{ secrets.JUMP_HOST }} >> ~/.ssh/known_hosts
          # 2. –°–∫–∞–Ω–∏—Ä—É–µ–º Target —Ö–æ—Å—Ç (—á–µ—Ä–µ–∑ Jump —Ö–æ—Å—Ç, –∏—Å–ø–æ–ª—å–∑—É—è netcat)
          ssh -o StrictHostKeyChecking=no ${{ secrets.JUMP_USER }}@${{ secrets.JUMP_HOST }} "ssh-keyscan -H ${{ secrets.TARGET_HOST }}" >> ~/.ssh/known_hosts

      - name: Run Command
        run: |
          # –§–ª–∞–≥ -J —É–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞ Jump Host
          ssh -J ${{ secrets.JUMP_USER }}@${{ secrets.JUMP_HOST }} \
              ${{ secrets.TARGET_USER }}@${{ secrets.TARGET_HOST }} \
              "echo 'Success!'; ls -la"

–°–ø–æ—Å–æ–± 3: –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ (SCP) —á–µ—Ä–µ–∑ Jump —Å–µ—Ä–≤–µ—Ä

–ï—Å–ª–∏ –≤–∞–º –Ω—É–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä, –±–∏–ª–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è) —á–µ—Ä–µ–∑ Jump —Å–µ—Ä–≤–µ—Ä, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ appleboy/scp-action.
YAML

      - name: Copy files via Jump Host
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.TARGET_HOST }}
          username: ${{ secrets.TARGET_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Jump
          proxy_host: ${{ secrets.JUMP_HOST }}
          proxy_username: ${{ secrets.JUMP_USER }}
          proxy_key: ${{ secrets.SSH_PRIVATE_KEY }}
          
          source: "./build/*"
          target: "/var/www/app"

–í–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏

    –û–¥–∏–Ω –∫–ª—é—á vs –†–∞–∑–Ω—ã–µ –∫–ª—é—á–∏:

        –ü—Ä–æ—Å—Ç–æ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ–¥–Ω—É –ø–∞—Ä—É –∫–ª—é—á–µ–π (Private Key –≤ GitHub, Public Key –Ω–∞ –æ–±–æ–∏—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö).

        –ë–µ–∑–æ–ø–∞—Å–Ω–æ: –°–æ–∑–¥–∞—Ç—å —Ä–∞–∑–Ω—ã–µ –∫–ª—é—á–∏. –û–¥–∏–Ω –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ GitHub -> Jump, –¥—Ä—É–≥–æ–π –¥–ª—è Jump -> Target. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –≤ –∫–æ–Ω—Ñ–∏–≥–µ appleboy –≤ –ø–æ–ª–µ proxy_key –≤—ã –≤—Å—Ç–∞–≤–ª—è–µ—Ç–µ –∫–ª—é—á –æ—Ç Jump, –∞ –≤ –ø–æ–ª–µ key ‚Äî –∫–ª—é—á –æ—Ç Target.

    Firewall: –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Security Group (–∏–ª–∏ iptables) –Ω–∞ Jump —Å–µ—Ä–≤–µ—Ä–µ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –≤—Ö–æ–¥—è—â–∏–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –Ω–∞ –ø–æ—Ä—Ç 22 —Å –ª—é–±—ã—Ö IP (–∏–ª–∏ IP-–∞–¥—Ä–µ—Å–æ–≤ GitHub Actions, —Ö–æ—Ç—è –æ–Ω–∏ —á–∞—Å—Ç–æ –º–µ–Ω—è—é—Ç—Å—è), –∞ Target —Å–µ—Ä–≤–µ—Ä —Ä–∞–∑—Ä–µ—à–∞–µ—Ç –ø–æ—Ä—Ç 22 —Ç–æ–ª—å–∫–æ —Å IP-–∞–¥—Ä–µ—Å–∞ Jump —Å–µ—Ä–≤–µ—Ä–∞.

–ó–∞—á–µ–º –Ω—É–∂–µ–Ω —à–∞–≥

- name: Copy k8s configs

uses: appleboy/scp-action@master

with:

host: ${{ secrets.SSH_HOST }}

username: ${{ secrets.SSH_USER }}

key: ${{ secrets.SSH_PRIVATE_KEY }}

source: "k8s/*"

target: "~/app-deploy"

–≠—Ç–æ—Ç —à–∞–≥ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Ä–æ–ª—å –∫—É—Ä—å–µ—Ä–∞.

–í GitHub Actions –≤–∞—à –∫–æ–¥ –∏ —Ñ–∞–π–ª—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ –≤—Ä–µ–º–µ–Ω–Ω–æ–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–µ (Runner), –∫–æ—Ç–æ—Ä—É—é GitHub —Å–æ–∑–¥–∞–µ—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ä–µ–º—è —Å–±–æ—Ä–∫–∏. –í–∞—à —Å–µ—Ä–≤–µ—Ä (K3s) –Ω–∏—á–µ–≥–æ –Ω–µ –∑–Ω–∞–µ—Ç –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ —Ñ–∞–π–ª–∞—Ö –≤–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è, –ø–æ–∫–∞ –≤—ã –∏—Ö —Ç—É–¥–∞ —Ñ–∏–∑–∏—á–µ—Å–∫–∏ –Ω–µ –ø–æ–ª–æ–∂–∏—Ç–µ.

–í–æ—Ç –ø–æ–¥—Ä–æ–±–Ω–∞—è –ª–æ–≥–∏—á–µ—Å–∫–∞—è —Ü–µ–ø–æ—á–∫–∞, –∑–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ:
1. –ü–µ—Ä–µ–Ω–æ—Å –∏–∑–º–µ–Ω–µ–Ω–∏–π –∏–∑ Git –Ω–∞ –°–µ—Ä–≤–µ—Ä

–ö–æ–≥–¥–∞ –≤—ã –º–µ–Ω—è–µ—Ç–µ —á—Ç–æ-—Ç–æ –≤ –ø–∞–ø–∫–µ k8s/ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –º–µ–Ω—è–µ—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ ConfigMap –∏–ª–∏ –≤–µ—Ä—Å–∏—é –æ–±—Ä–∞–∑–∞ –≤ Deployment), —ç—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—Ç —Ç–æ–ª—å–∫–æ –≤ Git.

    Source (k8s/*): –ë–µ—Ä–µ—Ç –≤—Å–µ YAML-—Ñ–∞–π–ª—ã –∏–∑ –≤–∞—à–µ–≥–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–Ω–∞ Runner'–µ).

    Target (~/app-deploy): –ö–æ–ø–∏—Ä—É–µ—Ç –∏—Ö –≤ –ø–∞–ø–∫—É –Ω–∞ –≤–∞—à–µ–º —Ä–µ–∞–ª—å–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ.

    Shutterstock

2. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ø–ª–∞—Ü–¥–∞—Ä–º–∞ –¥–ª—è kubectl

–°—Ä–∞–∑—É –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ —à–∞–≥–∞ –≤ –≤–∞—à–µ–º –ø–∞–π–ø–ª–∞–π–Ω–µ –∏–¥–µ—Ç —à–∞–≥ ssh-action, –∫–æ—Ç–æ—Ä—ã–π –≤—ã–ø–æ–ª–Ω—è–µ—Ç –∫–æ–º–∞–Ω–¥—É: kubectl apply -f ~/app-deploy/k8s/

–ö–æ–º–∞–Ω–¥–∞ kubectl apply -f —Ç—Ä–µ–±—É–µ—Ç, —á—Ç–æ–±—ã —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –æ–Ω–∞ –ø—Ä–∏–º–µ–Ω—è–µ—Ç, —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏ –Ω–∞ –¥–∏—Å–∫–µ.

    –ï—Å–ª–∏ –≤—ã —É–¥–∞–ª–∏—Ç–µ —à–∞–≥ scp-action, —Ç–æ —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ —É–ø–∞–¥–µ—Ç —Å –æ—à–∏–±–∫–æ–π: error: the path "~/app-deploy/k8s/" does not exist (–∏–ª–∏ —Ñ–∞–π–ª—ã –±—É–¥—É—Ç —Å—Ç–∞—Ä—ã–º–∏).

3. –ü–æ—á–µ–º—É –Ω–µ –∑–∞–ø—É—Å–∫–∞—Ç—å kubectl –ø—Ä—è–º–æ —Å Runner'–∞?

–ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å GitHub Actions —Ç–∞–∫, —á—Ç–æ–±—ã kubectl –∑–∞–ø—É—Å–∫–∞–ª—Å—è –ø—Ä—è–º–æ –Ω–∞ Runner'–µ –∏ –ø–æ–¥–∫–ª—é—á–∞–ª—Å—è –∫ –≤–∞—à–µ–º—É –∫–ª–∞—Å—Ç–µ—Ä—É —É–¥–∞–ª–µ–Ω–Ω–æ (–±–µ–∑ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤). –ù–æ –¥–ª—è —ç—Ç–æ–≥–æ –Ω—É–∂–Ω–æ:

    –û—Ç–∫—Ä—ã–≤–∞—Ç—å –ø–æ—Ä—Ç API Kubernetes (6443) –Ω–∞—Ä—É–∂—É –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç (—á—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ).

    –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Å–ª–æ–∂–Ω—ã–π kubeconfig —Å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏ –≤ —Å–µ–∫—Ä–µ—Ç—ã GitHub.

–í–∞—à –º–µ—Ç–æ–¥ (SCP + SSH) –±–µ–∑–æ–ø–∞—Å–Ω–µ–µ –∏ –ø—Ä–æ—â–µ –¥–ª—è K3s:

    –í—ã –∫–æ–ø–∏—Ä—É–µ—Ç–µ —Ñ–∞–π–ª—ã —á–µ—Ä–µ–∑ SSH (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –∑–∞—â–∏—â–µ–Ω–Ω—ã–π –∫–∞–Ω–∞–ª).

    –í—ã –∑–∞–ø—É—Å–∫–∞–µ—Ç–µ kubectl –ª–æ–∫–∞–ª—å–Ω–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ (–≥–¥–µ –æ–Ω —É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –∫ –∫–ª–∞—Å—Ç–µ—Ä—É –±–µ–∑ –ª–∏—à–Ω–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫).

–ò—Ç–æ–≥: –≠—Ç–æ—Ç —à–∞–≥ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ "—á–µ—Ä—Ç–µ–∂–∏" (YAML-—Ñ–∞–π–ª—ã) –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º, —á—Ç–æ–±—ã —Å—Ç—Ä–æ–∏—Ç–µ–ª—å (Kubernetes) –º–æ–≥ –ø–æ –Ω–∏–º —Ä–∞–±–æ—Ç–∞—Ç—å.


The action appleboy/ssh-action@master is not allowed in singnet/qwestor because all actions must be from a repository owned by singnet, created by GitHub, or verified in the GitHub Marketplace.


–≠—Ç–∞ –æ—à–∏–±–∫–∞ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –≤ –≤–∞—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ GitHub (singnet) –≤–∫–ª—é—á–µ–Ω–∞ —Å—Ç—Ä–æ–≥–∞—è –ø–æ–ª–∏—Ç–∏–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –∑–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ Actions, –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ —Å–æ–∑–¥–∞–Ω—ã —Å–∞–º–∏–º GitHub –∏–ª–∏ –Ω–µ –ø—Ä–æ—à–ª–∏ –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é. –ü–æ–ø—É–ª—è—Ä–Ω—ã–π —ç–∫—à–µ–Ω appleboy/ssh-action –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –≤ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–µ (—Ö–æ—Ç—å –æ–Ω –∏ –Ω–∞–¥–µ–∂–Ω—ã–π), –ø–æ—ç—Ç–æ–º—É –ø–æ–ª–∏—Ç–∏–∫–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ –µ–≥–æ –±–ª–æ–∫–∏—Ä—É–µ—Ç.

–†–µ—à–µ–Ω–∏–µ: –ù–∞–º –Ω—É–∂–Ω–æ –æ—Ç–∫–∞–∑–∞—Ç—å—Å—è –æ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≥–æ—Ç–æ–≤–æ–≥–æ —ç–∫—à–µ–Ω–∞ appleboy –∏ –Ω–∞–ø–∏—Å–∞—Ç—å —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–∫—Ä–∏–ø—Ç –Ω–∞ Bash –≤–Ω—É—Ç—Ä–∏ –ø–∞–π–ø–ª–∞–π–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã Linux (ssh, scp). –≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ª–µ–≥–∞–ª—å–Ω–æ, —Ç–∞–∫ –∫–∞–∫ –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ GitHub Runner.

–í–æ—Ç –∫–∞–∫ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤–∞—à —Ñ–∞–π–ª .github/workflows/deploy.yml:
–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π .github/workflows/deploy.yml
YAML

name: Build and Deploy

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Log in to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest

      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # --- –ó–ê–ú–ï–ù–ê APPLEBOY –ù–ê NATIVE SSH ---
      
      - name: Install SSH Key
        run: |
          mkdir -p ~/.ssh/
          # –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ —Ñ–∞–π–ª
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ 600, –∏–Ω–∞—á–µ ssh –æ—Ç–∫–∞–∂–µ—Ç)
          chmod 600 ~/.ssh/id_rsa
          
          # –î–æ–±–∞–≤–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –≤ known_hosts, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –≤–æ–ø—Ä–æ—Å–∞ "Are you sure...?"
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Copy k8s configs (SCP)
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π scp –≤–º–µ—Å—Ç–æ appleboy/scp-action
          # -r –æ–∑–Ω–∞—á–∞–µ—Ç —Ä–µ–∫—É—Ä—Å–∏–≤–Ω–æ (–≤—Å—é –ø–∞–ø–∫—É)
          scp -r k8s/* ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:~/app-deploy/

      - name: Apply K8s manifests (SSH)
        run: |
          # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π ssh –≤–º–µ—Å—Ç–æ appleboy/ssh-action
          ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            # –í—ã–ø–æ–ª–Ω—è–µ–º –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Å–µ—Ä–≤–µ—Ä–µ
            kubectl apply -f ~/app-deploy/
            
            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º –ø–æ–¥—ã –≤ –Ω—É–∂–Ω–æ–º –Ω–µ–π–º—Å–ø–µ–π—Å–µ
            kubectl rollout restart deployment/backend -n researcher-app
            kubectl rollout restart deployment/frontend -n researcher-app
          "

–ß—Ç–æ –º—ã –∏–∑–º–µ–Ω–∏–ª–∏:

    –£–¥–∞–ª–∏–ª–∏ uses: appleboy/...: –ú—ã –±–æ–ª—å—à–µ –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º —Å—Ç–æ—Ä–æ–Ω–Ω–∏–π –∫–æ–¥.

    –î–æ–±–∞–≤–∏–ª–∏ —à–∞–≥ "Install SSH Key":

        –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É ~/.ssh.

        –ö–ª–∞–¥–µ–º —Ç—É–¥–∞ –≤–∞—à –∫–ª—é—á.

        chmod 600 ‚Äî —ç—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ. SSH –Ω–µ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å, –µ—Å–ª–∏ –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª —Å–ª–∏—à–∫–æ–º –æ—Ç–∫—Ä—ã—Ç—ã.

        ssh-keyscan ‚Äî —ç—Ç–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã GitHub Actions "—É–∑–Ω–∞–ª" –≤–∞—à —Å–µ—Ä–≤–µ—Ä –∏ –Ω–µ –∑–∞–≤–∏—Å –Ω–∞ –≤–æ–ø—Ä–æ—Å–µ "–í—ã —Ç–æ—á–Ω–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –Ω–æ–≤–æ–º—É —Ö–æ—Å—Ç—É?".

    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ scp: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ Linux –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤.

    –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ ssh: –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è.

–≠—Ç–æ—Ç –º–µ—Ç–æ–¥ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –≤–∞—à–µ–π –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫ –Ω–µ –Ω–∞—Ä—É—à–∞–µ—Ç –Ω–∏–∫–∞–∫–∏—Ö –ø–æ–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.

–°–¥–µ–ª–∞–π —Å jump

–¢–∞–∫ –∫–∞–∫ –≤–∞—à–∞ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∑–∞–ø—Ä–µ—â–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ç–æ—Ä–æ–Ω–Ω–∏—Ö Actions (appleboy), –º—ã —Ä–µ–∞–ª–∏–∑—É–µ–º –ø—Ä–æ—Ö–æ–¥ —á–µ—Ä–µ–∑ Jump Server (Bastion) –∏—Å–ø–æ–ª—å–∑—É—è –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã Linux (ssh —Å —Ñ–ª–∞–≥–æ–º -J / ProxyJump) –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é SSH.

–≠—Ç–æ —Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π –∏ "—á–∏—Å—Ç—ã–π" —Å–ø–æ—Å–æ–±, –∫–æ—Ç–æ—Ä—ã–π –æ–¥–æ–±—Ä–∏—Ç –ª—é–±–∞—è —Å–ª—É–∂–±–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏.
## 1. –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –°–µ–∫—Ä–µ—Ç–æ–≤

–í Settings -> Secrets and variables -> Actions –¥–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–µ —Å–µ–∫—Ä–µ—Ç—ã (–∏–ª–∏ —É–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –æ–Ω–∏ –µ—Å—Ç—å):

    JUMP_HOST ‚Äî –ü—É–±–ª–∏—á–Ω—ã–π IP –≤–∞—à–µ–≥–æ Jump-—Å–µ—Ä–≤–µ—Ä–∞.

    JUMP_USER ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ Jump-—Å–µ—Ä–≤–µ—Ä–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, ubuntu).

    SSH_HOST ‚Äî –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π (—á–∞—Å—Ç–Ω—ã–π) IP –≤–∞—à–µ–≥–æ K3s —Å–µ—Ä–≤–µ—Ä–∞ (Target).

    SSH_USER ‚Äî –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞ K3s —Å–µ—Ä–≤–µ—Ä–µ.

    SSH_PRIVATE_KEY ‚Äî –í–∞—à –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á.

        –í–∞–∂–Ω–æ: –ü—É–±–ª–∏—á–Ω–∞—è —á–∞—Å—Ç—å —ç—Ç–æ–≥–æ –∫–ª—é—á–∞ (id_rsa.pub) –¥–æ–ª–∂–Ω–∞ –ª–µ–∂–∞—Ç—å –≤ ~/.ssh/authorized_keys –∏ –Ω–∞ Jump-—Å–µ—Ä–≤–µ—Ä–µ, –∏ –Ω–∞ K3s-—Å–µ—Ä–≤–µ—Ä–µ.

## 2. –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π .github/workflows/deploy.yml

–ú—ã –±—É–¥–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞–≥–∏—é —Ñ–∞–π–ª–∞ ~/.ssh/config, —á—Ç–æ–±—ã —É–ø—Ä–æ—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥—ã. –ú—ã –Ω–∞—Å—Ç—Ä–æ–∏–º –∞–ª–∏–∞—Å, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Ç—É–Ω–Ω–µ–ª—å.
YAML

name: Build and Deploy via Jump Host

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Log in to Registry
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Backend
        uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest

      - name: Build and push Frontend
        uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest

name: Build and Deploy (Separate Keys)

on:
  push:
    branches: [ "main" ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ... (job build-and-push –æ—Å—Ç–∞–µ—Ç—Å—è –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ...
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v3
      - uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/build-push-action@v4
        with:
          context: ./backend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/backend:latest
      - uses: docker/build-push-action@v4
        with:
          context: ./frontend
          push: true
          tags: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}/frontend:latest

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Configure SSH 
        run: |
          mkdir -p ~/.ssh/
          
          echo "${{ secrets.DC_DEV_SSH_JUMP_PRIVATE_KEY }}" > ~/.ssh/jump_key
          chmod 600 ~/.ssh/jump_key
          
          echo "${{ secrets.DC_DEV_SSH_PRIVATE_KEY }}" > ~/.ssh/target_key
          chmod 600 ~/.ssh/target_key
          
          cat > ~/.ssh/config <<EOF
          
          Host jump-server
            HostName ${{ secrets.DC_DEV_JUMP_HOST }}
            User ${{ secrets.DC_DEV_JUMP_USER }}
            Port ${{ secrets.DC_DEV_JUMP_PORT }}
            IdentityFile ~/.ssh/jump_key  
            StrictHostKeyChecking no
          
          Host k3s-server
            HostName ${{ secrets.DC_DEV_TARGET_HOST }}
            User ${{ secrets.DC_DEV_TARGET_USER }}
            Port ${{ secrets.DC_DEV_PORT }}
            ProxyJump jump-server
            IdentityFile ~/.ssh/target_key 
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config
      
      # - name: Copy k8s configs
      #   run: |
      #     scp -r k8s/* k3s-server:~/app-deploy/

      - name: Apply K8s manifests
        run: |
          ssh k3s-server "
            kubectl apply -f ~/app-deploy/
            
            kubectl rollout restart deployment/backend -n researcher-app
            kubectl rollout restart deployment/frontend -n researcher-app
          " 
